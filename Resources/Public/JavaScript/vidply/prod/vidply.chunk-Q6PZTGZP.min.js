/*!
 * Universal, Accessible Video Player
 * (c) 2026 Matthias Peltzer
 * Released under GPL-2.0-or-later License
 */
var d=class{constructor(e){this.player=e,this.media=e.element,this._didDeferredLoad=!1}async init(){this.media.controls=!1,this.media.removeAttribute("controls"),this.attachEvents(),this.player.options.deferLoad?this.media.preload=this.player.options.preload||"none":(this.media.preload=this.player.options.preload,this.media.load()),this.player.container&&this.player.container.classList.remove("vidply-external-controls")}attachEvents(){this.media.addEventListener("loadedmetadata",()=>{this.player.state.duration=this.media.duration,this.player.emit("loadedmetadata"),this.media.tagName==="VIDEO"&&this.player.autoGeneratePoster().catch(e=>{this.player.log("Failed to auto-generate poster:",e,"warn")})}),this.media.addEventListener("play",()=>{this.player.state.playing=!0,this.player.state.paused=!1,this.player.state.ended=!1,this.player.emit("play"),this.player.options.onPlay&&this.player.options.onPlay.call(this.player),this.player.options.pauseOthersOnPlay&&this.pauseOtherPlayers()}),this.media.addEventListener("pause",()=>{this.player.state.playing=!1,this.player.state.paused=!0,this.player.emit("pause"),this.player.options.onPause&&this.player.options.onPause.call(this.player)}),this.media.addEventListener("ended",()=>{this.player.state.playing=!1,this.player.state.paused=!0,this.player.state.ended=!0,this.player.emit("ended"),this.player.options.onEnded&&this.player.options.onEnded.call(this.player),this.player.options.loop&&(this.player.seek(0),this.player.play())}),this.media.addEventListener("timeupdate",()=>{this.player.state.currentTime=this.media.currentTime,this.player.emit("timeupdate",this.media.currentTime),this.player.options.onTimeUpdate&&this.player.options.onTimeUpdate.call(this.player,this.media.currentTime)}),this.media.addEventListener("volumechange",()=>{this.player.state.volume=this.media.volume,this.player.state.muted=this.media.muted,this.player.emit("volumechange",this.media.volume),this.player.options.onVolumeChange&&this.player.options.onVolumeChange.call(this.player,this.media.volume)}),this.media.addEventListener("seeking",()=>{this.player.state.seeking=!0,this.player.emit("seeking")}),this.media.addEventListener("seeked",()=>{this.player.state.seeking=!1,this.player.emit("seeked")}),this.media.addEventListener("waiting",()=>{this.player.state.buffering=!0,this.player.emit("waiting")}),this.media.addEventListener("canplay",()=>{this.player.state.buffering=!1,this.player.emit("canplay")}),this.media.addEventListener("progress",()=>{if(this.media.buffered.length>0){let e=this.media.buffered.end(this.media.buffered.length-1);this.player.emit("progress",e)}}),this.media.addEventListener("error",e=>{this.player.handleError(this.media.error)}),this.media.addEventListener("ratechange",()=>{this.player.state.playbackSpeed=this.media.playbackRate,this.player.emit("ratechange",this.media.playbackRate)})}pauseOtherPlayers(){document.querySelectorAll(".vidply-player").forEach(t=>{if(t!==this.player.container){let i=t.querySelector("video, audio");i&&!i.paused&&i.pause()}})}play(){let e=window.scrollX,t=window.scrollY;if(this.player.options.deferLoad&&!this._didDeferredLoad){try{this.media.readyState===0&&this.media.load()}catch{}this._didDeferredLoad=!0}let i=this.media.play();return window.scrollTo(e,t),i!==void 0?(i.catch(s=>{if(this.player.log("Play failed:",s,"warn"),this.player.options.autoplay&&!this.player.state.muted){this.player.log("Retrying play with muted audio","info"),this.media.muted=!0;let a=window.scrollX,r=window.scrollY;this.media.play().then(()=>{window.scrollTo(a,r)}).catch(l=>{this.player.handleError(l)})}}),i):Promise.resolve()}ensureLoaded(){if(!(!this.player.options.deferLoad||this._didDeferredLoad)){try{this.media.readyState===0&&this.media.load()}catch{}this._didDeferredLoad=!0}}pause(){this.media.pause()}seek(e){this.media.currentTime=e}setVolume(e){this.media.volume=e}setMuted(e){this.media.muted=e}setPlaybackSpeed(e){this.media.playbackRate=e}getQualities(){let e=Array.from(this.media.querySelectorAll("source"));return e.length<=1?[]:e.map((t,i)=>{let s=t.getAttribute("data-quality")||t.getAttribute("label")||"",a=t.getAttribute("data-height")||this.extractHeightFromLabel(s),r=t.getAttribute("data-width")||"";return{index:i,height:a?parseInt(a):0,width:r?parseInt(r):0,src:t.src,type:t.type,name:s||(a?`${a}p`:`Quality ${i+1}`)}}).filter(t=>t.height>0)}extractHeightFromLabel(e){let t=e.match(/(\d+)p/i);return t?parseInt(t[1]):0}switchQuality(e){let t=this.getQualities();if(e<0||e>=t.length){this.player.log("Invalid quality index","warn");return}let i=t[e],s=this.media.currentTime,a=!this.media.paused;if(this.media.currentSrc===i.src){this.player.log("Already at this quality level","info");return}this.player.log(`Switching to quality: ${i.name}`,"info"),this.media.src=i.src;let l=()=>{this.media.removeEventListener("loadedmetadata",l),this.media.currentTime=s,a&&this.media.play().catch(h=>{this.player.log("Failed to resume playback after quality switch","warn")}),this.player.emit("qualitychange",{quality:i.name,index:e})};this.media.addEventListener("loadedmetadata",l),this.media.load()}getCurrentQuality(){let e=this.getQualities(),t=this.media.currentSrc;for(let i=0;i<e.length;i++)if(e[i].src===t)return i;return 0}destroy(){this.media.removeEventListener("loadedmetadata",()=>{}),this.media.removeEventListener("play",()=>{}),this.media.removeEventListener("pause",()=>{})}};export{d as a};
