/*!
 * Universal, Accessible Video Player
 * (c) 2026 Matthias Peltzer
 * Released under GPL-2.0-or-later License
 */
import{CaptionManager as e}from"./vidply.chunk-NFACYQG2.min.js";import"./vidply.chunk-AE2Z46L5.min.js";import"./vidply.chunk-YLKHFL57.min.js";var t=class{constructor(e){this.player=e,this.enabled=!1,this.desiredState=!1,this.src=e.options.audioDescriptionSrc,this.sourceElement=null,this.originalSource=null,this.captionTracks=[]}initFromSourceElements(e,t){for(const t of e){const e=t.getAttribute("data-desc-src"),a=t.getAttribute("data-orig-src");if(e||a){if(this.sourceElement||(this.sourceElement=t),a)this.originalSource||(this.originalSource=a),this.player.originalSrc||(this.player.originalSrc=a);else{const e=t.getAttribute("src");!this.originalSource&&e&&(this.originalSource=e),!this.player.originalSrc&&e&&(this.player.originalSrc=e)}e&&!this.src&&(this.src=e)}}t.forEach(e=>{const t=e.getAttribute("kind"),a=e.getAttribute("data-desc-src");"captions"!==t&&"subtitles"!==t&&"chapters"!==t&&"descriptions"!==t||!a||(this.captionTracks.push({trackElement:e,originalSrc:e.getAttribute("src"),describedSrc:a,originalTrackSrc:e.getAttribute("data-orig-src")||e.getAttribute("src"),explicit:!0}),this.player.log(`Found explicit described ${t} track: ${e.getAttribute("src")} -> ${a}`))})}isAvailable(){const e=this.player.sourceElements.some(e=>e.getAttribute("data-desc-src"));return!!(this.src||e||this.captionTracks.length>0)}async enable(){const e=this.player.sourceElements.some(e=>e.getAttribute("data-desc-src")),t=this.captionTracks.length>0;if(!this.src&&!e&&!t)return void console.warn("VidPly: No audio description source, source elements, or tracks provided");this.desiredState=!0;const a=this.player.state.currentTime,i=this.player.state.playing,r=this.player.element.poster||this.player.element.getAttribute("poster")||this.player.options.poster,s=a<.1&&!i,n=this._getCurrentCaptionText();this.sourceElement?await this._enableWithSourceElement(a,i,r,s,n):this.src?await this._enableWithDirectSrc(a,i,r,s):t&&(await this._swapCaptionTracks(!0),this.enabled=!0,this.player.emit("audiodescriptionenabled"))}async disable(){if(this.desiredState=!1,!this.sourceElement&&!this.src&&this.captionTracks.length>0)return await this._swapCaptionTracks(!1),this.enabled=!1,void this.player.emit("audiodescriptiondisabled");if(!this.player.originalSrc)return;const e=this.player.state.currentTime,t=this.player.state.playing,a=this.player.element.poster||this.player.element.getAttribute("poster")||this.player.options.poster,i=e<.1&&!t,r=this._getCurrentCaptionText();this.sourceElement?await this._disableWithSourceElement(e,t,a,i,r):this.src&&await this._disableWithDirectSrc(e,t,a)}async toggle(){const e=this.player.findTextTrack("descriptions"),t=this.isAvailable();e&&!t?"showing"===e.mode?(e.mode="hidden",this.enabled=!1,this.player.emit("audiodescriptiondisabled")):(e.mode="showing",this.enabled=!0,this.player.emit("audiodescriptionenabled")):e&&t?this.enabled?(this.desiredState=!1,await this.disable()):(e.mode="showing",this.desiredState=!0,await this.enable()):t&&(this.enabled?(this.desiredState=!1,await this.disable()):(this.desiredState=!0,await this.enable()))}_getCurrentCaptionText(){return this.player.captionManager&&this.player.captionManager.currentTrack&&this.player.captionManager.currentCue?this.player.captionManager.currentCue.text:null}async _validateTrackExists(e){try{return(await fetch(e,{method:"HEAD"})).ok}catch{return!1}}async _swapCaptionTracks(e=!0){if(0===this.captionTracks.length)return[];const t=[],a=this.captionTracks.map(async t=>{if(t.trackElement&&t.describedSrc&&!0===t.explicit)try{return{trackInfo:t,exists:await this._validateTrackExists(e?t.describedSrc:t.originalSrc)}}catch{return{trackInfo:t,exists:!1}}return{trackInfo:t,exists:!1}}),i=(await Promise.all(a)).filter(e=>e.exists);if(i.length>0){const a=new Map;i.forEach(({trackInfo:e})=>{const t=e.trackElement.track;a.set(e,t?{wasShowing:"showing"===t.mode,wasHidden:"hidden"===t.mode}:{wasShowing:!1,wasHidden:!1})});const r=i.map(({trackInfo:e})=>{const t={};Array.from(e.trackElement.attributes).forEach(e=>{t[e.name]=e.value});const a={trackInfo:e,oldSrc:e.trackElement.getAttribute("src"),parent:e.trackElement.parentNode,nextSibling:e.trackElement.nextSibling,attributes:t};return e.trackElement.remove(),a});this.player.element.load(),await new Promise(i=>{setTimeout(()=>{r.forEach(({trackInfo:a,parent:i,nextSibling:r,attributes:s})=>{t.push(a);const n=document.createElement("track");n.setAttribute("src",e?a.describedSrc:a.originalSrc),Object.keys(s).forEach(e=>{"src"!==e&&"data-desc-src"!==e&&n.setAttribute(e,s[e])});const l=i||this.player.element;r&&r.parentNode?l.insertBefore(n,r):l.appendChild(n),a.trackElement=n}),this.player.invalidateTrackCache();const s=()=>{this.player.setManagedTimeout(()=>{t.forEach(e=>{const t=e.trackElement.track;if(t){const i=a.get(e)||{wasShowing:!1,wasHidden:!1};t.mode="hidden";const r=()=>{t.mode=i.wasShowing||i.wasHidden?"hidden":"disabled"};t.readyState>=2?r():(t.addEventListener("load",r,{once:!0}),t.addEventListener("error",r,{once:!0}))}})},300)};this.player.element.readyState>=1?setTimeout(s,200):(this.player.element.addEventListener("loadedmetadata",s,{once:!0}),setTimeout(s,2e3)),i()},100)})}return t}_updateSourceElements(e=!0){const t=this.player.sourceElements,a=[];t.forEach(t=>{const i=t.getAttribute("data-desc-src"),r=t.getAttribute("src");if(i){const s=t.getAttribute("type");let n=t.getAttribute("data-orig-src")||r;a.push({src:e?i:n,type:s,origSrc:n,descSrc:i})}else a.push({src:t.getAttribute("src"),type:t.getAttribute("type"),origSrc:null,descSrc:null})}),this.player.element.hasAttribute("src")&&this.player.element.removeAttribute("src"),t.forEach(e=>e.remove()),a.forEach(e=>{const t=document.createElement("source");t.setAttribute("src",e.src),e.type&&t.setAttribute("type",e.type),e.origSrc&&t.setAttribute("data-orig-src",e.origSrc),e.descSrc&&t.setAttribute("data-desc-src",e.descSrc);const a=this.player.element.querySelector("track");a?this.player.element.insertBefore(t,a):this.player.element.appendChild(t)}),this.player._sourceElementsDirty=!0,this.player._sourceElementsCache=null}async _waitForMediaReady(e=!1){await new Promise(e=>{if(this.player.element.readyState>=1)e();else{const t=()=>{this.player.element.removeEventListener("loadedmetadata",t),e()};this.player.element.addEventListener("loadedmetadata",t)}}),await new Promise(e=>setTimeout(e,300)),e&&await new Promise(e=>{if(this.player.element.readyState>=3)e();else{const t=()=>{this.player.element.removeEventListener("canplay",t),this.player.element.removeEventListener("canplaythrough",t),e()};this.player.element.addEventListener("canplay",t,{once:!0}),this.player.element.addEventListener("canplaythrough",t,{once:!0}),setTimeout(()=>{this.player.element.removeEventListener("canplay",t),this.player.element.removeEventListener("canplaythrough",t),e()},3e3)}})}async _restorePlaybackState(e,t,a,i){let r=e;if(i&&this.player.captionManager&&this.player.captionManager.tracks.length>0){await new Promise(e=>setTimeout(e,500));const t=this.player.findMatchingCaptionTime(i,this.player.captionManager.tracks);null!==t&&(r=t,this.player.options.debug&&this.player.log(`[VidPly] Syncing via caption: ${e}s -> ${r}s`))}r>0&&(this.player.seek(r),await new Promise(e=>setTimeout(e,100))),t?(await this.player.play(),this.player.setManagedTimeout(()=>{this.player.hidePosterOverlay()},100)):(this.player.pause(),a||this.player.hidePosterOverlay())}async _enableWithSourceElement(e,t,a,i,r){await this._swapCaptionTracks(!0),this._updateSourceElements(!0),a&&"VIDEO"===this.player.element.tagName&&(this.player.element.poster=a),this.player.element.load(),await this._waitForMediaReady(e>0||t),await this._restorePlaybackState(e,t,i,r),this.desiredState&&(this.enabled=!0,this.player.state.audioDescriptionEnabled=!0,this.player.emit("audiodescriptionenabled"),this._reloadTranscript())}async _enableWithDirectSrc(e,t,a,i){await this._swapCaptionTracks(!0),a&&"VIDEO"===this.player.element.tagName&&(this.player.element.poster=a),this.player.element.src=this.src,await this._waitForMediaReady(e>0||t),e>0&&(this.player.seek(e),await new Promise(e=>setTimeout(e,100))),t?await this.player.play():(this.player.pause(),i||this.player.hidePosterOverlay()),this.desiredState&&(this.enabled=!0,this.player.state.audioDescriptionEnabled=!0,this.player.emit("audiodescriptionenabled"),this._reloadTranscript())}async _disableWithSourceElement(t,a,i,r,s){await this._swapCaptionTracks(!1),this._updateSourceElements(!1),i&&"VIDEO"===this.player.element.tagName&&(this.player.element.poster=i),this.player.element.load(),this.player.invalidateTrackCache(),await this._waitForMediaReady(t>0||a),await this._restorePlaybackState(t,a,r,s),this.player.captionManager&&(this.player.captionManager.destroy(),this.player.captionManager=new e(this.player)),this.desiredState||(this.enabled=!1,this.player.state.audioDescriptionEnabled=!1,this.player.emit("audiodescriptiondisabled"),this._reloadTranscript())}async _disableWithDirectSrc(e,t,a){await this._swapCaptionTracks(!1),a&&"VIDEO"===this.player.element.tagName&&(this.player.element.poster=a),this.player.element.src=this.originalSource||this.player.originalSrc,this.player.element.load(),await this._waitForMediaReady(e>0||t),e>0&&this.player.seek(e),t&&await this.player.play(),this.desiredState||(this.enabled=!1,this.player.state.audioDescriptionEnabled=!1,this.player.emit("audiodescriptiondisabled"),this._reloadTranscript())}_reloadTranscript(){this.player.transcriptManager&&this.player.transcriptManager.isVisible&&this.player.setManagedTimeout(()=>{this.player.transcriptManager&&this.player.transcriptManager.loadTranscriptData&&this.player.transcriptManager.loadTranscriptData()},800)}updateSources(e){this.src=e||null,this.enabled=!1,this.desiredState=!1,this.sourceElement=null,this.originalSource=null,this.captionTracks=[]}reinitialize(){this.player.invalidateTrackCache(),this.initFromSourceElements(this.player.sourceElements,this.player.trackElements)}destroy(){this.enabled=!1,this.desiredState=!1,this.captionTracks=[],this.sourceElement=null,this.originalSource=null}};export{t as AudioDescriptionManager};