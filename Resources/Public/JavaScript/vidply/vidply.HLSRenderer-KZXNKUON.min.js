/*!
 * Universal, Accessible Video Player
 * (c) 2026 Matthias Peltzer
 * Released under GPL-2.0-or-later License
 */
var e=class{constructor(e){this.player=e,this.media=e.element,this.hls=null,this._hlsSourceLoaded=!1,this._pendingSrc=null,this._hlsSubtitleTracksCount=void 0}async init(){this.canPlayNatively()?(this.player.log("Using native HLS support"),await this.initNative()):(this.player.log("Using hls.js for HLS support"),await this.initHlsJs())}canPlayNatively(){const e=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),t=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;return!(!e&&!t)&&""!==document.createElement("video").canPlayType("application/vnd.apple.mpegurl")}async initNative(){const e=new(0,(await import("./vidply.HTML5Renderer-UC4UXGXP.min.js")).HTML5Renderer)(this.player);await e.init(),Object.getOwnPropertyNames(Object.getPrototypeOf(e)).forEach(t=>{"constructor"!==t&&"function"==typeof e[t]&&(this[t]=e[t].bind(e))})}async initHlsJs(){if(this.media.controls=!1,this.media.removeAttribute("controls"),window.Hls||await this.loadHlsJs(),!window.Hls.isSupported())throw new Error("HLS is not supported in this browser");const e=Array.from(this.media.querySelectorAll("source"));let t=null;e.length>0&&(t=e[0].getAttribute("src"),e.forEach(e=>e.remove()),this.player.log("Removed <source> elements for HTML5 validity (hls.js uses src attribute)")),this.hls=new window.Hls({debug:this.player.options.debug,autoStartLoad:!this.player.options.deferLoad,enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,maxBufferLength:30,maxMaxBufferLength:600,maxBufferSize:6e7,maxBufferHole:.5,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:4,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3}),this.hls.attachMedia(this.media);let s=this.player.currentSource;if(!s&&t&&(s=t),s||(s=this.player.element.getAttribute("data-vidply-src")),!s){const e=this.player.element.getAttribute("src")||this.player.element.src;e&&!e.startsWith("blob:")&&(s=e)}if(this.player.log(`Loading HLS source: ${s}`,"log"),!s)throw new Error("No HLS source found");this.player.options.deferLoad?this._pendingSrc=s:(this.hls.loadSource(s),this._hlsSourceLoaded=!0),this.attachHlsEvents(),this.attachMediaEvents()}async loadHlsJs(){return new Promise((e,t)=>{const s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/hls.js@latest",s.onload=()=>e(),s.onerror=()=>t(new Error("Failed to load hls.js")),document.head.appendChild(s)})}attachHlsEvents(){this.hls.on(window.Hls.Events.MANIFEST_PARSED,(e,t)=>{this.player.log("HLS manifest loaded, found "+t.levels.length+" quality levels"),this.player.emit("hlsmanifestparsed",t),this.player.container&&this.player.container.classList.remove("vidply-external-controls"),setTimeout(()=>{void 0!==this._hlsSubtitleTracksCount&&0!==this._hlsSubtitleTracksCount||0===(this.hls?.subtitleTracks?.length||0)&&(this._hlsSubtitleTracksCount=0,this.updateCaptionButtonsForHls())},500)}),this.hls.on(window.Hls.Events.LEVEL_SWITCHED,(e,t)=>{this.player.log("HLS level switched to "+t.level),this.player.emit("hlslevelswitched",t)}),this.hls.on(window.Hls.Events.SUBTITLE_TRACKS_UPDATED,(e,t)=>{this.player.log("HLS subtitle tracks updated, found "+t.subtitleTracks.length+" tracks"),this.player.emit("hlssubtitletracksupdated",t),this._hlsSubtitleTracksCount=t.subtitleTracks.length,this.updateCaptionButtonsForHls()}),this.hls.on(window.Hls.Events.SUBTITLE_TRACK_SWITCH,(e,t)=>{this.player.log("HLS subtitle track switched to "+t.id),this.player.emit("hlssubtitletrackswitch",t)}),this.hls.on(window.Hls.Events.ERROR,(e,t)=>{this.handleHlsError(t)}),this.hls.on(window.Hls.Events.FRAG_BUFFERED,()=>{this.player.state.buffering=!1})}updateCaptionButtonsForHls(){const e=this._hlsSubtitleTracksCount||0,t=()=>{this.player.invalidateTrackCache(),e>0?(this.player.captionManager&&this.player.captionManager.refreshTracks(),this.player.transcriptManager?.isVisible&&(this.player.transcriptManager.loadTranscriptData(),this.player.transcriptManager.updateLanguageSelector()),this.player.controlBar&&(this.player.controlBar.ensureCaptionsButton(),this.player.controlBar.ensureCaptionStyleButton(),this.player.controlBar.ensureTranscriptButton())):(this.player.captionManager&&this.player.captionManager.refreshTracks(),this.player.transcriptManager?.isVisible&&this.player.transcriptManager.hideTranscript(),this.player.controlBar&&this.player.controlBar.removeHlsCaptionButtons(!0))};if(this.player.controlBar)return void t();const s=()=>{this.player.off("ready",s),t()};this.player.on("ready",s)}attachMediaEvents(){this.media.addEventListener("loadedmetadata",()=>{this.player.state.duration=this.media.duration,this.player.emit("loadedmetadata")}),this.media.addEventListener("durationchange",()=>{const e=this.media.duration;e&&isFinite(e)&&e>0&&(this.player.state.duration=e,this.player.emit("durationchange",e))}),this.media.addEventListener("play",()=>{this.player.state.playing=!0,this.player.state.paused=!1,this.player.state.ended=!1,this.player.emit("play"),this.player.options.onPlay&&this.player.options.onPlay.call(this.player)}),this.media.addEventListener("pause",()=>{this.player.state.playing=!1,this.player.state.paused=!0,this.player.emit("pause"),this.player.options.onPause&&this.player.options.onPause.call(this.player)}),this.media.addEventListener("ended",()=>{this.player.state.playing=!1,this.player.state.paused=!0,this.player.state.ended=!0,this.player.emit("ended"),this.player.options.onEnded&&this.player.options.onEnded.call(this.player),this.player.options.loop&&(this.player.seek(0),this.player.play())}),this.media.addEventListener("timeupdate",()=>{this.player.state.currentTime=this.media.currentTime,this.player.emit("timeupdate",this.media.currentTime),this.player.options.onTimeUpdate&&this.player.options.onTimeUpdate.call(this.player,this.media.currentTime)}),this.media.addEventListener("volumechange",()=>{this.player.state.volume=this.media.volume,this.player.state.muted=this.media.muted,this.player.emit("volumechange",this.media.volume)}),this.media.addEventListener("waiting",()=>{this.player.state.buffering=!0,this.player.emit("waiting")}),this.media.addEventListener("canplay",()=>{this.player.state.buffering=!1,this.player.emit("canplay")}),this.media.addEventListener("error",()=>{this.player.handleError(this.media.error)})}handleHlsError(e){if(this.player.log(`HLS Error - Type: ${e.type}, Details: ${e.details}, Fatal: ${e.fatal}`,"warn"),e.response&&this.player.log(`Response code: ${e.response.code}, URL: ${e.response.url}`,"warn"),e.fatal)switch(e.type){case window.Hls.ErrorTypes.NETWORK_ERROR:this.player.log("Fatal network error, trying to recover...","error"),this.player.log(`Network error details: ${e.details}`,"error"),setTimeout(()=>{this.hls.startLoad()},1e3);break;case window.Hls.ErrorTypes.MEDIA_ERROR:this.player.log("Fatal media error, trying to recover...","error"),this.hls.recoverMediaError();break;default:this.player.log("Fatal error, cannot recover","error"),this.player.handleError(new Error(`HLS Error: ${e.type} - ${e.details}`)),this.hls.destroy()}else this.player.log("Non-fatal HLS error: "+e.details,"warn")}ensureLoaded(){if(!this.player.options.deferLoad)return;if(!this.hls)return;if(this._hlsSourceLoaded)return;const e=this._pendingSrc||this.player._pendingSource||this.player.currentSource;if(e)try{this.hls.loadSource(e),this._hlsSourceLoaded=!0,this.hls.startLoad()}catch(e){}}play(){const e=window.scrollX,t=window.scrollY;if(this.player.options.deferLoad&&this.hls&&!this._hlsSourceLoaded){const e=this._pendingSrc||this.player.currentSource;if(e)try{this.hls.loadSource(e),this.hls.startLoad(),this._hlsSourceLoaded=!0}catch(e){}}const s=this.media.play();window.scrollTo(e,t),void 0!==s&&s.catch(e=>{this.player.log("Play failed:",e,"warn")})}pause(){this.media.pause()}seek(e){this.media.currentTime=e}setVolume(e){this.media.volume=e}setMuted(e){this.media.muted=e}setPlaybackSpeed(e){this.media.playbackRate=e}switchQuality(e){this.hls&&(this.hls.currentLevel=e)}getQualities(){return this.hls&&this.hls.levels?this.hls.levels.map((e,t)=>{const s=Number(e.height)||0,i=Number(e.bitrate)||0,a=i>0?Math.round(i/1e3):0;return{index:t,height:e.height,width:e.width,bitrate:e.bitrate,name:s>0?`${s}p`:a>0?`${a} kb`:"Auto"}}):[]}getCurrentQuality(){return this.hls?this.hls.currentLevel:-1}destroy(){this.hls&&(this.hls.destroy(),this.hls=null)}};export{e as HLSRenderer};