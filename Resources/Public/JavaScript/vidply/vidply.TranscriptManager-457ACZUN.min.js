/*!
 * Universal, Accessible Video Player
 * (c) 2026 Matthias Peltzer
 * Released under GPL-2.0-or-later License
 */
import{TimeUtils as t}from"./vidply.chunk-AK4IZ5DH.min.js";import{StorageManager as e}from"./vidply.chunk-AE2Z46L5.min.js";import{DraggableResizable as s,attachMenuKeyboardNavigation as i,createIconElement as a,createLabeledSelect as r,createMenuItem as n,focusElement as o,preventDragOnElement as l}from"./vidply.chunk-7OK6TG2Y.min.js";import{DOMUtils as h,i18n as p}from"./vidply.chunk-YLKHFL57.min.js";var c=class{constructor(t){this.player=t,this.transcriptWindow=null,this.transcriptEntries=[],this.metadataCues=[],this.currentActiveEntry=null,this.isVisible=!1,this.storage=new e("vidply"),this.draggableResizable=null,this.settingsMenuVisible=!1,this.settingsMenu=null,this.settingsButton=null,this.settingsMenuJustOpened=!1,this.resizeOptionButton=null,this.resizeOptionText=null,this.dragOptionButton=null,this.dragOptionText=null,this.resizeModeIndicator=null,this.resizeModeIndicatorTimeout=null,this.transcriptResizeHandles=[],this.liveRegion=null,this.styleDialog=null,this.styleDialogVisible=!1,this.styleDialogJustOpened=!1,this.languageSelector=null,this.languageLabel=null,this.currentTranscriptLanguage=null,this.availableTranscriptLanguages=[],this.languageSelectorHandler=null;const s=this.storage.getTranscriptPreferences();this.autoscrollEnabled=void 0===s?.autoscroll||s.autoscroll,this.showTimestamps=void 0!==s?.showTimestamps&&s.showTimestamps,this.transcriptStyle={fontSize:s?.fontSize||this.player.options.transcriptFontSize||"100%",fontFamily:s?.fontFamily||this.player.options.transcriptFontFamily||"sans-serif",color:s?.color||this.player.options.transcriptColor||"#ffffff",backgroundColor:s?.backgroundColor||this.player.options.transcriptBackgroundColor||"#1e1e1e",opacity:s?.opacity??this.player.options.transcriptOpacity??.98},this.handlers={timeupdate:()=>this.updateActiveEntry(),audiodescriptionenabled:()=>{this.isVisible&&this.loadTranscriptData()},audiodescriptiondisabled:()=>{this.isVisible&&this.loadTranscriptData()},resize:null,settingsClick:null,settingsKeydown:null,documentClick:null,styleDialogKeydown:null},this.timeouts=new Set,this.init()}init(){this.setupMetadataHandlingOnLoad(),this.player.on("timeupdate",this.handlers.timeupdate),this.player.on("audiodescriptionenabled",this.handlers.audiodescriptionenabled),this.player.on("audiodescriptiondisabled",this.handlers.audiodescriptiondisabled),this.player.on("fullscreenchange",()=>{this.isVisible&&(window.innerWidth<768&&this.setupDragAndDrop(),this.draggableResizable&&this.draggableResizable.manuallyPositioned||this.setManagedTimeout(()=>this.positionTranscript(),100))})}toggleTranscript(){this.isVisible?this.hideTranscript():this.showTranscript()}showTranscript(){if(this.player.invalidateTrackCache(),this.transcriptWindow)return this.transcriptWindow.style.display="flex",this.isVisible=!0,this.loadTranscriptData(),this.updateLanguageSelector(),this.player.controlBar&&"function"==typeof this.player.controlBar.updateTranscriptButton&&this.player.controlBar.updateTranscriptButton(),void o(this.settingsButton,{delay:150});this.createTranscriptWindow(),this.loadTranscriptData(),this.transcriptWindow&&(this.transcriptWindow.style.display="flex",this.draggableResizable&&this.draggableResizable.manuallyPositioned||this.setManagedTimeout(()=>this.positionTranscript(),0),o(this.settingsButton,{delay:150})),this.isVisible=!0}hideTranscript({focusButton:t=!1}={}){if(this.transcriptWindow&&(this.transcriptWindow.style.display="none",this.isVisible=!1),this.draggableResizable&&this.draggableResizable.pointerResizeMode&&(this.draggableResizable.disablePointerResizeMode(),this.updateResizeOptionState()),this.hideResizeModeIndicator(),this.announceLive(""),this.player.controlBar&&"function"==typeof this.player.controlBar.updateTranscriptButton&&this.player.controlBar.updateTranscriptButton(),t){const t=this.player.controlBar?.controls?.transcript;t&&"function"==typeof t.focus&&t.focus({preventScroll:!0})}}createTranscriptWindow(){this.transcriptWindow=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-window`,attributes:{role:"dialog","aria-label":p.t("transcript.ariaLabel"),tabindex:"-1"}}),this.transcriptHeader=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-header`,attributes:{tabindex:"0"}}),this.headerLeft=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-header-left`});const t=p.t("transcript.settingsMenu");this.settingsButton=h.createElement("button",{className:`${this.player.options.classPrefix}-transcript-settings`,attributes:{type:"button","aria-label":t,"aria-expanded":"false"}}),this.settingsButton.appendChild(a("settings")),h.attachTooltip(this.settingsButton,t,this.player.options.classPrefix),this.handlers.settingsClick=t=>{t.preventDefault(),t.stopPropagation(),this.settingsMenuVisible?this.hideSettingsMenu():this.showSettingsMenu()},this.settingsButton.addEventListener("click",this.handlers.settingsClick),this.handlers.settingsKeydown=t=>{"d"===t.key||"D"===t.key?(t.preventDefault(),t.stopPropagation(),this.toggleKeyboardDragMode()):"r"===t.key||"R"===t.key?(t.preventDefault(),t.stopPropagation(),this.toggleResizeMode()):"Escape"===t.key&&this.settingsMenuVisible&&(t.preventDefault(),t.stopPropagation(),this.hideSettingsMenu())},this.settingsButton.addEventListener("keydown",this.handlers.settingsKeydown);const e=h.createElement("h3",{textContent:`${p.t("transcript.title")}. ${p.t("transcript.dragResizePrompt")}`}),s=`${this.player.options.classPrefix}-transcript-autoscroll-${Date.now()}`,i=h.createElement("label",{className:`${this.player.options.classPrefix}-transcript-autoscroll-label`,attributes:{for:s}});this.autoscrollCheckbox=h.createElement("input",{attributes:{id:s,type:"checkbox"}}),this.autoscrollEnabled&&(this.autoscrollCheckbox.checked=!0);const n=h.createElement("span",{textContent:p.t("transcript.autoscroll"),className:`${this.player.options.classPrefix}-transcript-autoscroll-text`});i.appendChild(this.autoscrollCheckbox),i.appendChild(n),this.autoscrollCheckbox.addEventListener("change",t=>{this.autoscrollEnabled=t.target.checked,this.saveAutoscrollPreference()}),this.transcriptHeader.appendChild(e),this.headerLeft.appendChild(this.settingsButton),this.headerLeft.appendChild(i);const o=`${this.player.options.classPrefix}-transcript-language-select-${Date.now()}`,{label:c,select:d}=r({classPrefix:this.player.options.classPrefix,labelClass:`${this.player.options.classPrefix}-transcript-language-label`,selectClass:`${this.player.options.classPrefix}-transcript-language-select`,labelText:"settings.language",selectId:o,hidden:!1});this.languageLabel=c,this.languageSelector=d;const u=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-language-wrapper`,attributes:{style:"display: none;"}});u.appendChild(this.languageLabel),u.appendChild(this.languageSelector),this.languageSelectorWrapper=u,l(u),this.headerLeft.appendChild(u);const g=p.t("transcript.close"),y=h.createElement("button",{className:`${this.player.options.classPrefix}-transcript-close`,attributes:{type:"button","aria-label":g}});let m;y.appendChild(a("close")),h.attachTooltip(y,g,this.player.options.classPrefix),y.addEventListener("click",()=>this.hideTranscript({focusButton:!0})),this.transcriptHeader.appendChild(this.headerLeft),this.transcriptHeader.appendChild(y),this.transcriptContent=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-content`}),this.transcriptWindow.appendChild(this.transcriptHeader),this.transcriptWindow.appendChild(this.transcriptContent),this.createResizeHandles(),this.liveRegion=h.createElement("div",{className:"vidply-sr-only",attributes:{"aria-live":"polite","aria-atomic":"true"}}),this.transcriptWindow.appendChild(this.liveRegion),this.player.container.appendChild(this.transcriptWindow),this.setupDragAndDrop(),this.draggableResizable&&this.draggableResizable.manuallyPositioned||this.positionTranscript(),this.handlers.documentClick=t=>{this.settingsMenuJustOpened||this.styleDialogJustOpened||this.settingsButton&&this.settingsButton.contains(t.target)||this.settingsMenu&&this.settingsMenu.contains(t.target)||(this.settingsMenuVisible&&this.hideSettingsMenu(),this.styleDialogVisible&&this.styleDialog&&!this.styleDialog.contains(t.target)&&this.hideStyleDialog())},this.documentClickHandlerAdded=!1,this.handlers.resize=()=>{m&&this.clearManagedTimeout(m),m=this.setManagedTimeout(()=>{this.draggableResizable&&this.draggableResizable.manuallyPositioned||this.positionTranscript()},100)},window.addEventListener("resize",this.handlers.resize)}createResizeHandles(){this.transcriptWindow&&(this.transcriptResizeHandles=["n","s","e","w","ne","nw","se","sw"].map(t=>{const e=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-resize-handle ${this.player.options.classPrefix}-transcript-resize-${t}`,attributes:{"data-direction":t,"data-vidply-managed-resize":"true","aria-hidden":"true"}});return e.style.display="none",this.transcriptWindow.appendChild(e),e}))}positionTranscript(){if(!this.transcriptWindow||!this.player.videoWrapper||!this.isVisible)return;if(this.draggableResizable&&this.draggableResizable.manuallyPositioned)return;const t=window.innerWidth<768,e=this.player.videoWrapper.getBoundingClientRect(),s=this.player.state.fullscreen;if(t&&!s){this.transcriptWindow.style.position="relative",this.transcriptWindow.style.left="0",this.transcriptWindow.style.right="0",this.transcriptWindow.style.bottom="auto",this.transcriptWindow.style.top="auto",this.transcriptWindow.style.width="100%",this.transcriptWindow.style.maxWidth="100%",this.transcriptWindow.style.maxHeight="300px",this.transcriptWindow.style.height="auto",this.transcriptWindow.style.borderRadius="0",this.transcriptWindow.style.transform="none",this.transcriptWindow.style.border="none",this.transcriptWindow.style.borderTop="1px solid var(--vidply-border-light)",this.transcriptWindow.style.removeProperty("border-right"),this.transcriptWindow.style.removeProperty("border-bottom"),this.transcriptWindow.style.removeProperty("border-left"),this.transcriptWindow.style.removeProperty("border-image"),this.transcriptWindow.style.removeProperty("border-image-source"),this.transcriptWindow.style.removeProperty("border-image-slice"),this.transcriptWindow.style.removeProperty("border-image-width"),this.transcriptWindow.style.removeProperty("border-image-outset"),this.transcriptWindow.style.removeProperty("border-image-repeat"),this.transcriptWindow.style.boxShadow="none",this.transcriptHeader&&(this.transcriptHeader.style.cursor="default");const t=this.player.videoWrapper;t&&t.nextSibling!==this.transcriptWindow&&t.parentNode.insertBefore(this.transcriptWindow,t.nextSibling)}else if(s){this.transcriptWindow.style.position="fixed",this.transcriptWindow.style.left="auto",this.transcriptWindow.style.right="20px",this.transcriptWindow.style.bottom="80px",this.transcriptWindow.style.top="auto",this.transcriptWindow.style.maxHeight="calc(100vh - 180px)",this.transcriptWindow.style.height="auto";const t=260,e=Math.max(t,window.innerWidth-40),s=parseFloat(this.transcriptWindow.style.width)||400,i=Math.max(t,Math.min(s,e));this.transcriptWindow.style.width=`${i}px`,this.transcriptWindow.style.maxWidth="none",this.transcriptWindow.style.borderRadius="8px",this.transcriptWindow.style.border="1px solid var(--vidply-border)",this.transcriptWindow.style.removeProperty("border-top"),this.transcriptWindow.style.removeProperty("border-right"),this.transcriptWindow.style.removeProperty("border-bottom"),this.transcriptWindow.style.removeProperty("border-left"),this.transcriptWindow.style.removeProperty("border-image"),this.transcriptWindow.style.removeProperty("border-image-source"),this.transcriptWindow.style.removeProperty("border-image-slice"),this.transcriptWindow.style.removeProperty("border-image-width"),this.transcriptWindow.style.removeProperty("border-image-outset"),this.transcriptWindow.style.removeProperty("border-image-repeat"),this.transcriptHeader&&(this.transcriptHeader.style.cursor="move"),this.transcriptWindow.parentNode!==this.player.container&&this.player.container.appendChild(this.transcriptWindow)}else{const t=parseFloat(this.transcriptWindow.style.width)||400,s=20,i=260,a=this.player.container.getBoundingClientRect();(()=>{"static"===window.getComputedStyle(this.player.container).position&&(this.player.container.style.position="relative")})();const r=window.innerWidth-e.right-s;if(r<t||!(r>=i)){const t=320,s=280,r=Math.min(t,e.width-40),n=Math.min(s,e.height-120),o=this.player.videoWrapper.getBoundingClientRect(),l=70,h=Math.max(180,n),p=o.bottom-a.top-l-h,c=a.right-o.right+12;this.transcriptWindow.style.position="absolute",this.transcriptWindow.style.left="auto",this.transcriptWindow.style.right=`${c}px`,this.transcriptWindow.style.top=`${p}px`,this.transcriptWindow.style.bottom="auto",this.transcriptWindow.style.width=`${Math.max(i,r)}px`,this.transcriptWindow.style.maxWidth=`${t}px`,this.transcriptWindow.style.height=`${h}px`,this.transcriptWindow.style.maxHeight=`${s}px`,this.transcriptWindow.style.boxShadow="0 4px 16px rgba(0, 0, 0, 0.6)"}else{const n=e.right-a.left+s,o=Math.max(i,Math.min(t,r)),l=e.height;this.transcriptWindow.style.position="absolute",this.transcriptWindow.style.left=`${n}px`,this.transcriptWindow.style.right="auto",this.transcriptWindow.style.bottom="auto",this.transcriptWindow.style.top="0",this.transcriptWindow.style.height=`${l}px`,this.transcriptWindow.style.maxHeight="none",this.transcriptWindow.style.width=`${o}px`,this.transcriptWindow.style.maxWidth="none",this.transcriptWindow.style.boxShadow=""}this.transcriptWindow.style.borderRadius="8px",this.transcriptWindow.style.border="1px solid var(--vidply-border)",this.transcriptWindow.style.removeProperty("border-top"),this.transcriptWindow.style.removeProperty("border-right"),this.transcriptWindow.style.removeProperty("border-bottom"),this.transcriptWindow.style.removeProperty("border-left"),this.transcriptWindow.style.removeProperty("border-image"),this.transcriptWindow.style.removeProperty("border-image-source"),this.transcriptWindow.style.removeProperty("border-image-slice"),this.transcriptWindow.style.removeProperty("border-image-width"),this.transcriptWindow.style.removeProperty("border-image-outset"),this.transcriptWindow.style.removeProperty("border-image-repeat"),this.transcriptHeader&&(this.transcriptHeader.style.cursor="move"),this.transcriptWindow.parentNode!==this.player.container&&this.player.container.appendChild(this.transcriptWindow)}}getAvailableTranscriptLanguages(){const t=this.player.textTracks,e=new Map;return t.forEach(t=>{"captions"!==t.kind&&"subtitles"!==t.kind||!t.language||e.has(t.language)||e.set(t.language,{language:t.language,label:t.label||t.language,track:t})}),Array.from(e.values())}updateLanguageSelector(){if(this.languageSelector)if(this.availableTranscriptLanguages=this.getAvailableTranscriptLanguages(),this.languageSelector.innerHTML="",this.availableTranscriptLanguages.length<2)this.languageSelectorWrapper&&(this.languageSelectorWrapper.style.display="none");else{if(this.languageSelectorWrapper&&(this.languageSelectorWrapper.style.display="flex"),this.availableTranscriptLanguages.forEach((t,e)=>{const s=h.createElement("option",{textContent:t.label,attributes:{value:t.language,lang:t.language}});this.languageSelector.appendChild(s)}),this.currentTranscriptLanguage)this.languageSelector.value=this.currentTranscriptLanguage;else if(this.availableTranscriptLanguages.length>0){const t=this.player.textTracks.find(t=>("captions"===t.kind||"subtitles"===t.kind)&&"showing"===t.mode);this.currentTranscriptLanguage=t?t.language:this.availableTranscriptLanguages[0].language,this.languageSelector.value=this.currentTranscriptLanguage}this.languageSelectorHandler&&this.languageSelector.removeEventListener("change",this.languageSelectorHandler),this.languageSelectorHandler=t=>{this.currentTranscriptLanguage=t.target.value,this.loadTranscriptData(),this.transcriptContent&&this.currentTranscriptLanguage&&this.transcriptContent.setAttribute("lang",this.currentTranscriptLanguage)},this.languageSelector.addEventListener("change",this.languageSelectorHandler)}}loadTranscriptData(){this.transcriptEntries=[],this.transcriptContent.innerHTML="";const t=this.player.textTracks;let e=null;this.currentTranscriptLanguage&&(e=t.find(t=>("captions"===t.kind||"subtitles"===t.kind)&&t.language===this.currentTranscriptLanguage)),e||(e=t.find(t=>"captions"===t.kind||"subtitles"===t.kind),e&&(this.currentTranscriptLanguage=e.language));let s=null;this.currentTranscriptLanguage&&(s=t.find(t=>"descriptions"===t.kind&&t.language===this.currentTranscriptLanguage)),s||(s=t.find(t=>"descriptions"===t.kind));const i=t.find(t=>"metadata"===t.kind);if(!e&&!s&&!i)return void this.showNoTranscriptMessage();const a=[e,s,i].filter(Boolean);if(a.forEach(t=>{"disabled"===t.mode&&(t.mode="hidden")}),a.some(t=>!t.cues||0===t.cues.length)){const t=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-loading`,textContent:p.t("transcript.loading")});this.transcriptContent.appendChild(t);let e=0;const s=()=>{e++,e>=a.length&&this.loadTranscriptData()};return a.forEach(t=>{t.addEventListener("load",s,{once:!0})}),void this.setManagedTimeout(()=>{this.loadTranscriptData()},500)}const r=[];e&&e.cues&&Array.from(e.cues).forEach(t=>{r.push({cue:t,type:"caption"})}),s&&s.cues&&Array.from(s.cues).forEach(t=>{r.push({cue:t,type:"description"})}),i&&i.cues&&(this.metadataCues=Array.from(i.cues),this.setupMetadataHandling()),r.sort((t,e)=>t.cue.startTime-e.cue.startTime),r.forEach((t,e)=>{const s=this.createTranscriptEntry(t.cue,e,t.type);this.transcriptEntries.push({element:s,cue:t.cue,type:t.type,startTime:t.cue.startTime,endTime:t.cue.endTime}),this.transcriptContent.appendChild(s)}),this.applyTranscriptStyles(),this.updateTimestampVisibility(),this.transcriptContent&&this.currentTranscriptLanguage&&this.transcriptContent.setAttribute("lang",this.currentTranscriptLanguage),this.updateLanguageSelector()}setupMetadataHandlingOnLoad(){const t=()=>{const t=this.player.textTracks.find(t=>"metadata"===t.kind);t?("disabled"===t.mode&&(t.mode="hidden"),this.metadataCueChangeHandler&&t.removeEventListener("cuechange",this.metadataCueChangeHandler),this.metadataCueChangeHandler=()=>{const e=Array.from(t.activeCues||[]);e.length>0&&this.player.options.debug&&console.log("[VidPly Metadata] Active cues:",e.map(t=>({start:t.startTime,end:t.endTime,text:t.text}))),e.forEach(t=>{this.handleMetadataCue(t)})},t.addEventListener("cuechange",this.metadataCueChangeHandler),this.player.options.debug&&console.log("[VidPly Metadata] Track enabled,",t.cues?t.cues.length:0,"cues available")):this.player.options.debug&&console.warn("[VidPly Metadata] No metadata track found")};t(),this.player.on("loadedmetadata",t)}setupMetadataHandling(){this.metadataCues&&0!==this.metadataCues.length&&this.player.options.debug&&console.log("[VidPly Metadata]",this.metadataCues.length,"cues stored from transcript load")}handleMetadataCue(t){const e=t.text.trim();this.player.options.debug&&console.log("[VidPly Metadata] Processing cue:",{time:t.startTime,text:e}),this.player.emit("metadata",{time:t.startTime,endTime:t.endTime,text:e,cue:t}),e.includes("PAUSE")&&(this.player.state.paused||(this.player.options.debug&&console.log("[VidPly Metadata] Pausing video at",t.startTime),this.player.pause()),this.player.emit("metadata:pause",{time:t.startTime,text:e}));const s=e.match(/FOCUS:([\w#-]+)/);if(s){const i=s[1],a=document.querySelector(i);a?(this.player.options.debug&&console.log("[VidPly Metadata] Focusing element:",i),this.setManagedTimeout(()=>{a.focus({preventScroll:!0})},10)):this.player.options.debug&&console.warn("[VidPly Metadata] Element not found:",i),this.player.emit("metadata:focus",{time:t.startTime,target:i,element:a,text:e})}const i=e.match(/#[\w-]+/g);i&&(this.player.options.debug&&console.log("[VidPly Metadata] Hashtags found:",i),this.player.emit("metadata:hashtags",{time:t.startTime,hashtags:i,text:e}))}createTranscriptEntry(e,s,i="caption"){const a=this.stripVTTFormatting(e.text),r=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-entry ${this.player.options.classPrefix}-transcript-${i}`,attributes:{tabindex:"0","data-start":String(e.startTime),"data-end":String(e.endTime),"data-type":i}}),n=h.createElement("span",{className:`${this.player.options.classPrefix}-transcript-time`,textContent:t.formatTime(e.startTime),attributes:{"aria-hidden":"true"}}),o=h.createElement("span",{className:`${this.player.options.classPrefix}-transcript-text`,textContent:a});r.appendChild(n),r.appendChild(o);const l=()=>{this.player.seek(e.startTime),this.player.state.paused&&this.player.play()};return r.addEventListener("click",l),r.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),l())}),r}stripVTTFormatting(t){return t.replace(/<[^>]+>/g,"").replace(/\n/g," ").trim()}showNoTranscriptMessage(){const t=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-empty`,textContent:p.t("transcript.noTranscript")});this.transcriptContent.appendChild(t)}updateActiveEntry(){if(!this.isVisible||0===this.transcriptEntries.length)return;const t=this.player.state.currentTime,e=this.transcriptEntries.find(e=>t>=e.startTime&&t<e.endTime);e&&e!==this.currentActiveEntry?(this.currentActiveEntry&&this.currentActiveEntry.element.classList.remove(`${this.player.options.classPrefix}-transcript-entry-active`),e.element.classList.add(`${this.player.options.classPrefix}-transcript-entry-active`),this.scrollToEntry(e.element),this.currentActiveEntry=e):!e&&this.currentActiveEntry&&(this.currentActiveEntry.element.classList.remove(`${this.player.options.classPrefix}-transcript-entry-active`),this.currentActiveEntry=null)}scrollToEntry(t){if(!this.transcriptContent||!this.autoscrollEnabled)return;const e=this.transcriptContent.getBoundingClientRect(),s=t.getBoundingClientRect();(s.top<e.top||s.bottom>e.bottom)&&this.transcriptContent.scrollTo({top:t.offsetTop-this.transcriptContent.clientHeight/2+t.clientHeight/2,behavior:"smooth"})}saveAutoscrollPreference(){const t=this.storage.getTranscriptPreferences()||{};t.autoscroll=this.autoscrollEnabled,this.storage.saveTranscriptPreferences(t)}setupDragAndDrop(){this.transcriptHeader&&this.transcriptWindow&&(window.innerWidth<768&&!this.player.state.fullscreen?this.draggableResizable&&(this.draggableResizable.destroy(),this.draggableResizable=null):this.draggableResizable||(this.draggableResizable=new s(this.transcriptWindow,{dragHandle:this.transcriptHeader,resizeHandles:this.transcriptResizeHandles,constrainToViewport:!0,classPrefix:`${this.player.options.classPrefix}-transcript`,keyboardDragKey:"d",keyboardResizeKey:"r",keyboardStep:10,keyboardStepLarge:50,minWidth:300,minHeight:200,maxWidth:()=>Math.max(320,window.innerWidth-40),maxHeight:()=>Math.max(200,window.innerHeight-120),pointerResizeIndicatorText:p.t("transcript.resizeModeHint"),onPointerResizeToggle:t=>{this.transcriptResizeHandles.forEach(e=>{e.style.display=t?"block":"none"}),this.onPointerResizeModeChange(t)},onDragStart:t=>{const e=[`.${this.player.options.classPrefix}-transcript-close`,`.${this.player.options.classPrefix}-transcript-settings`,`.${this.player.options.classPrefix}-transcript-language-select`,`.${this.player.options.classPrefix}-transcript-language-label`,`.${this.player.options.classPrefix}-transcript-settings-menu`,`.${this.player.options.classPrefix}-transcript-style-dialog`];for(const s of e)if(t.target.closest(s))return!1;return!0}}),this.customKeyHandler=t=>{const e=t.key.toLowerCase(),s=t.defaultPrevented;if(!this.settingsMenuVisible&&!this.styleDialogVisible){if("home"===e)return t.preventDefault(),t.stopPropagation(),void(this.draggableResizable&&(this.draggableResizable.pointerResizeMode&&this.draggableResizable.disablePointerResizeMode(),this.draggableResizable.manuallyPositioned=!1,this.positionTranscript(),this.updateResizeOptionState(),this.announceLive(p.t("transcript.positionReset"))));if("r"===e){if(s)return;return t.preventDefault(),t.stopPropagation(),void(this.toggleResizeMode()&&this.transcriptWindow.focus({preventScroll:!0}))}return"escape"===e?this.draggableResizable&&this.draggableResizable.pointerResizeMode?(t.preventDefault(),t.stopPropagation(),void this.draggableResizable.disablePointerResizeMode()):this.draggableResizable&&this.draggableResizable.keyboardDragMode?(t.preventDefault(),t.stopPropagation(),this.draggableResizable.disableKeyboardDragMode(),void this.announceLive(p.t("transcript.dragModeDisabled"))):(t.preventDefault(),t.stopPropagation(),void this.hideTranscript({focusButton:!0})):void 0}},this.transcriptWindow.addEventListener("keydown",this.customKeyHandler)))}toggleKeyboardDragMode(){if(this.draggableResizable){const t=this.draggableResizable.keyboardDragMode;this.draggableResizable.toggleKeyboardDragMode(),!t&&this.draggableResizable.keyboardDragMode&&this.enableMoveMode(),this.updateDragOptionState(),this.settingsMenuVisible&&this.hideSettingsMenu(),this.transcriptWindow.focus({preventScroll:!0})}}toggleSettingsMenu(){this.settingsMenuVisible?this.hideSettingsMenu():this.showSettingsMenu()}showSettingsMenu(){if(this.settingsMenuJustOpened=!0,setTimeout(()=>{this.settingsMenuJustOpened=!1},350),this.documentClickHandlerAdded||setTimeout(()=>{document.addEventListener("click",this.handlers.documentClick),this.documentClickHandlerAdded=!0},300),this.settingsMenu)return this.settingsMenu.style.display="block",this.settingsMenuVisible=!0,this.settingsButton&&this.settingsButton.setAttribute("aria-expanded","true"),this.attachSettingsMenuKeyboardNavigation(),this.positionSettingsMenuImmediate(),this.updateResizeOptionState(),void setTimeout(()=>{const t=this.settingsMenu.querySelectorAll(`.${this.player.options.classPrefix}-transcript-settings-item`);if(t.length>0){t[0].setAttribute("tabindex","0");for(let e=1;e<t.length;e++)t[e].setAttribute("tabindex","-1");t[0].focus({preventScroll:!0})}},50);this.settingsMenu=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-settings-menu`,attributes:{role:"menu"}});const t=n({classPrefix:this.player.options.classPrefix,itemClass:`${this.player.options.classPrefix}-transcript-settings-item`,icon:"move",label:"transcript.enableDragMode",hasTextClass:!0,onClick:()=>{this.toggleKeyboardDragMode(),this.hideSettingsMenu()}});t.setAttribute("role","switch"),t.setAttribute("aria-checked","false");const e=t.querySelector(`.${this.player.options.classPrefix}-tooltip`);e&&e.remove();const s=t.querySelector(`.${this.player.options.classPrefix}-button-text`);s&&s.remove(),this.dragOptionButton=t,this.dragOptionText=t.querySelector(`.${this.player.options.classPrefix}-settings-text`),this.updateDragOptionState();const a=n({classPrefix:this.player.options.classPrefix,itemClass:`${this.player.options.classPrefix}-transcript-settings-item`,icon:"settings",label:"transcript.styleTranscript",onClick:t=>{t.preventDefault(),t.stopPropagation(),this.hideSettingsMenu(),setTimeout(()=>{this.showStyleDialog()},50)}}),r=a.querySelector(`.${this.player.options.classPrefix}-tooltip`);r&&r.remove();const o=a.querySelector(`.${this.player.options.classPrefix}-button-text`);o&&o.remove();const l=n({classPrefix:this.player.options.classPrefix,itemClass:`${this.player.options.classPrefix}-transcript-settings-item`,icon:"resize",label:"transcript.enableResizeMode",hasTextClass:!0,onClick:t=>{t.preventDefault(),t.stopPropagation(),this.toggleResizeMode({focus:!1})?(this.hideSettingsMenu({focusButton:!1}),setTimeout(()=>{this.transcriptWindow&&this.transcriptWindow.focus({preventScroll:!0})},20)):this.hideSettingsMenu({focusButton:!0})}});l.setAttribute("role","switch"),l.setAttribute("aria-checked","false");const p=l.querySelector(`.${this.player.options.classPrefix}-tooltip`);p&&p.remove();const c=l.querySelector(`.${this.player.options.classPrefix}-button-text`);c&&c.remove(),this.resizeOptionButton=l,this.resizeOptionText=l.querySelector(`.${this.player.options.classPrefix}-settings-text`),this.updateResizeOptionState();const d=n({classPrefix:this.player.options.classPrefix,itemClass:`${this.player.options.classPrefix}-transcript-settings-item`,icon:"clock",label:"transcript.showTimestamps",hasTextClass:!0,onClick:()=>{this.toggleShowTimestamps()}});d.setAttribute("role","switch"),d.setAttribute("aria-checked",this.showTimestamps?"true":"false");const u=d.querySelector(`.${this.player.options.classPrefix}-tooltip`);u&&u.remove();const g=d.querySelector(`.${this.player.options.classPrefix}-button-text`);g&&g.remove(),this.showTimestampsButton=d,this.showTimestampsText=d.querySelector(`.${this.player.options.classPrefix}-settings-text`),this.updateShowTimestampsState();const y=n({classPrefix:this.player.options.classPrefix,itemClass:`${this.player.options.classPrefix}-transcript-settings-item`,icon:"close",label:"transcript.closeMenu",onClick:()=>{this.hideSettingsMenu()}}),m=y.querySelector(`.${this.player.options.classPrefix}-tooltip`);m&&m.remove();const b=y.querySelector(`.${this.player.options.classPrefix}-button-text`);b&&b.remove(),this.settingsMenu.appendChild(t),this.settingsMenu.appendChild(l),this.settingsMenu.appendChild(a),this.settingsMenu.appendChild(d),this.settingsMenu.appendChild(y),this.settingsMenu.style.visibility="hidden",this.settingsMenu.style.display="block",this.settingsButton&&this.settingsButton.parentNode?this.settingsButton.insertAdjacentElement("afterend",this.settingsMenu):this.headerLeft?this.headerLeft.appendChild(this.settingsMenu):this.transcriptHeader?this.transcriptHeader.appendChild(this.settingsMenu):this.transcriptWindow.appendChild(this.settingsMenu),this.positionSettingsMenuImmediate(),requestAnimationFrame(()=>{this.settingsMenu&&(this.settingsMenu.style.visibility="visible")}),this.settingsMenuKeyHandler=i(this.settingsMenu,this.settingsButton,`.${this.player.options.classPrefix}-transcript-settings-item`,()=>this.hideSettingsMenu({focusButton:!0})),this.settingsMenuVisible=!0,this.settingsMenu.style.display="block",this.settingsButton&&this.settingsButton.setAttribute("aria-expanded","true"),this.updateResizeOptionState(),setTimeout(()=>{const t=this.settingsMenu.querySelectorAll(`.${this.player.options.classPrefix}-transcript-settings-item`);if(t.length>0){t[0].setAttribute("tabindex","0");for(let e=1;e<t.length;e++)t[e].setAttribute("tabindex","-1");t[0].focus({preventScroll:!0})}},50)}positionSettingsMenuImmediate(){if(!this.settingsMenu||!this.settingsButton)return;const t=this.settingsButton.parentElement;if(!t)return;const e=this.settingsButton.getBoundingClientRect(),s=t.getBoundingClientRect(),i=this.settingsMenu.getBoundingClientRect(),a=window.innerHeight,r=e.left-s.left,n=a-e.bottom;let o=e.bottom-s.top+4;n<i.height+20&&e.top>n?(o=e.top-s.top-i.height-4,this.settingsMenu.classList.add("vidply-menu-above")):this.settingsMenu.classList.remove("vidply-menu-above"),this.settingsMenu.style.top=`${o}px`,this.settingsMenu.style.left=`${r}px`,this.settingsMenu.style.right="auto",this.settingsMenu.style.bottom="auto"}positionSettingsMenu(){this.settingsMenu&&this.settingsButton&&requestAnimationFrame(()=>{setTimeout(()=>{this.positionSettingsMenuImmediate()},10)})}attachSettingsMenuKeyboardNavigation(){if(!this.settingsMenu)return;this.settingsMenuKeyHandler&&this.settingsMenu.removeEventListener("keydown",this.settingsMenuKeyHandler,!0);const t=i(this.settingsMenu,this.settingsButton,`.${this.player.options.classPrefix}-transcript-settings-item`,()=>this.hideSettingsMenu({focusButton:!0}));this.settingsMenuKeyHandler=t}hideSettingsMenu({focusButton:t=!0}={}){this.settingsMenu&&(this.settingsMenu.style.display="none",this.settingsMenuVisible=!1,this.settingsMenuJustOpened=!1,this.settingsMenuKeyHandler&&(this.settingsMenu.removeEventListener("keydown",this.settingsMenuKeyHandler,!0),this.settingsMenuKeyHandler=null),this.settingsButton&&(this.settingsButton.setAttribute("aria-expanded","false"),t&&this.settingsButton.focus({preventScroll:!0})))}enableMoveMode(){this.hideResizeModeIndicator(),this.transcriptWindow.classList.add(`${this.player.options.classPrefix}-transcript-move-mode`);const t=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-move-tooltip`,textContent:"Drag with mouse or press D for keyboard drag mode"});this.transcriptHeader.appendChild(t),setTimeout(()=>{this.transcriptWindow.classList.remove(`${this.player.options.classPrefix}-transcript-move-mode`),t.parentNode&&t.remove()},2e3)}toggleResizeMode({focus:t=!0}={}){return!!this.draggableResizable&&(this.draggableResizable.pointerResizeMode?(this.draggableResizable.disablePointerResizeMode({focus:t}),!1):(this.draggableResizable.enablePointerResizeMode({focus:t}),!0))}updateDragOptionState(){if(!this.dragOptionButton)return;const t=!(!this.draggableResizable||!this.draggableResizable.keyboardDragMode),e=p.t(t?"transcript.disableDragMode":"transcript.enableDragMode"),s=p.t(t?"transcript.disableDragModeAria":"transcript.enableDragModeAria");this.dragOptionButton.setAttribute("aria-checked",t?"true":"false"),this.dragOptionButton.setAttribute("aria-label",s),this.dragOptionText&&(this.dragOptionText.textContent=e)}updateResizeOptionState(){if(!this.resizeOptionButton)return;const t=!(!this.draggableResizable||!this.draggableResizable.pointerResizeMode),e=p.t(t?"transcript.disableResizeMode":"transcript.enableResizeMode"),s=p.t(t?"transcript.disableResizeModeAria":"transcript.enableResizeModeAria");this.resizeOptionButton.setAttribute("aria-checked",t?"true":"false"),this.resizeOptionButton.setAttribute("aria-label",s),this.resizeOptionText&&(this.resizeOptionText.textContent=e)}toggleShowTimestamps(){this.showTimestamps=!this.showTimestamps,this.updateShowTimestampsState(),this.updateTimestampVisibility(),this.saveTimestampsPreference()}updateShowTimestampsState(){if(!this.showTimestampsButton)return;const t=p.t(this.showTimestamps?"transcript.hideTimestamps":"transcript.showTimestamps"),e=p.t(this.showTimestamps?"transcript.hideTimestampsAria":"transcript.showTimestampsAria");this.showTimestampsButton.setAttribute("aria-checked",this.showTimestamps?"true":"false"),this.showTimestampsButton.setAttribute("aria-label",e),this.showTimestampsText&&(this.showTimestampsText.textContent=t)}updateTimestampVisibility(){this.transcriptContent&&this.transcriptContent.querySelectorAll(`.${this.player.options.classPrefix}-transcript-time`).forEach(t=>{t.style.display=this.showTimestamps?"":"none"})}saveTimestampsPreference(){const t=this.storage.getTranscriptPreferences()||{};t.showTimestamps=this.showTimestamps,this.storage.saveTranscriptPreferences(t)}showResizeModeIndicator(){if(!this.transcriptHeader)return;this.hideResizeModeIndicator();const t=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-resize-tooltip`,textContent:p.t("transcript.resizeModeHint")||"Resize handles enabled. Drag edges or corners to adjust. Press Esc or R to exit."});this.transcriptHeader.appendChild(t),this.resizeModeIndicator=t,this.resizeModeIndicatorTimeout=this.setManagedTimeout(()=>{this.hideResizeModeIndicator()},3e3)}hideResizeModeIndicator(){this.resizeModeIndicatorTimeout&&(this.clearManagedTimeout(this.resizeModeIndicatorTimeout),this.resizeModeIndicatorTimeout=null),this.resizeModeIndicator&&this.resizeModeIndicator.parentNode&&this.resizeModeIndicator.remove(),this.resizeModeIndicator=null}onPointerResizeModeChange(t){this.updateResizeOptionState(),t?(this.showResizeModeIndicator(),this.announceLive(p.t("transcript.resizeModeEnabled"))):(this.hideResizeModeIndicator(),this.announceLive(p.t("transcript.resizeModeDisabled")))}showStyleDialog(){if(this.styleDialog)return this.styleDialog.style.display="block",this.styleDialogVisible=!0,this.handlers.styleDialogKeydown&&document.addEventListener("keydown",this.handlers.styleDialogKeydown),this.styleDialogJustOpened=!0,setTimeout(()=>{this.styleDialogJustOpened=!1},350),void setTimeout(()=>{const t=this.styleDialog.querySelector("select, input");t&&t.focus({preventScroll:!0})},0);this.styleDialog=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-style-dialog`});const t=h.createElement("h4",{textContent:p.t("transcript.styleTitle"),className:`${this.player.options.classPrefix}-transcript-style-title`});this.styleDialog.appendChild(t);const e=this.createStyleSelectControl(p.t("captions.fontSize"),"fontSize",[{label:p.t("fontSizes.small"),value:"90%"},{label:p.t("fontSizes.normal"),value:"100%"},{label:p.t("fontSizes.large"),value:"110%"},{label:p.t("fontSizes.xlarge"),value:"120%"}]);this.styleDialog.appendChild(e);const s=this.createStyleSelectControl(p.t("captions.fontFamily"),"fontFamily",[{label:p.t("fontFamilies.sansSerif"),value:"sans-serif"},{label:p.t("fontFamilies.serif"),value:"serif"},{label:p.t("fontFamilies.monospace"),value:"monospace"}]);this.styleDialog.appendChild(s);const i=this.createStyleColorControl(p.t("captions.color"),"color");this.styleDialog.appendChild(i);const a=this.createStyleColorControl(p.t("captions.backgroundColor"),"backgroundColor");this.styleDialog.appendChild(a);const r=this.createStyleOpacityControl(p.t("captions.opacity"),"opacity");this.styleDialog.appendChild(r);const n=h.createElement("button",{className:`${this.player.options.classPrefix}-transcript-style-close`,textContent:p.t("settings.close"),attributes:{type:"button"}});n.addEventListener("click",()=>this.hideStyleDialog()),this.styleDialog.appendChild(n),this.handlers.styleDialogKeydown=t=>{if(this.styleDialogVisible){if("Escape"===t.key)return t.preventDefault(),t.stopPropagation(),void this.hideStyleDialog();if("Tab"===t.key){const e=this.styleDialog.querySelectorAll("select, input, button"),s=e[0],i=e[e.length-1];t.shiftKey&&document.activeElement===s?(t.preventDefault(),i.focus({preventScroll:!0})):t.shiftKey||document.activeElement!==i||(t.preventDefault(),s.focus({preventScroll:!0}))}}},document.addEventListener("keydown",this.handlers.styleDialogKeydown),this.headerLeft?this.headerLeft.appendChild(this.styleDialog):this.transcriptHeader.appendChild(this.styleDialog),this.applyTranscriptStyles(),this.styleDialogVisible=!0,this.styleDialog.style.display="block",this.styleDialogJustOpened=!0,setTimeout(()=>{this.styleDialogJustOpened=!1},350),setTimeout(()=>{const t=this.styleDialog.querySelector("select, input");t&&t.focus({preventScroll:!0})},0)}hideStyleDialog(){this.styleDialog&&(this.styleDialog.style.display="none",this.styleDialogVisible=!1,this.handlers.styleDialogKeydown&&document.removeEventListener("keydown",this.handlers.styleDialogKeydown),this.settingsButton&&this.settingsButton.focus({preventScroll:!0}))}createStyleSelectControl(t,e,s){const i=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-style-group`}),a=`${this.player.options.classPrefix}-transcript-${e}-${Date.now()}`,r=h.createElement("label",{textContent:t,attributes:{for:a}});i.appendChild(r);const n=h.createElement("select",{className:`${this.player.options.classPrefix}-transcript-style-select`,attributes:{id:a}});return s.forEach(t=>{const s=h.createElement("option",{textContent:t.label,attributes:{value:t.value}});this.transcriptStyle[e]===t.value&&(s.selected=!0),n.appendChild(s)}),n.addEventListener("change",t=>{this.transcriptStyle[e]=t.target.value,this.applyTranscriptStyles(),this.savePreferences()}),i.appendChild(n),i}createStyleColorControl(t,e){const s=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-style-group`}),i=`${this.player.options.classPrefix}-transcript-${e}-${Date.now()}`,a=h.createElement("label",{textContent:t,attributes:{for:i}});s.appendChild(a);const r=h.createElement("input",{attributes:{id:i,type:"color",value:this.transcriptStyle[e]},className:`${this.player.options.classPrefix}-transcript-style-color`});return r.addEventListener("input",t=>{this.transcriptStyle[e]=t.target.value,this.applyTranscriptStyles(),this.savePreferences()}),s.appendChild(r),s}createStyleOpacityControl(t,e){const s=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-style-group`}),i=`${this.player.options.classPrefix}-transcript-${e}-${Date.now()}`,a=h.createElement("label",{textContent:t,attributes:{for:i}});s.appendChild(a);const r=h.createElement("span",{textContent:Math.round(100*this.transcriptStyle[e])+"%",className:`${this.player.options.classPrefix}-transcript-style-value`}),n=h.createElement("input",{attributes:{id:i,type:"range",min:"0",max:"1",step:"0.1",value:String(this.transcriptStyle[e])},className:`${this.player.options.classPrefix}-transcript-style-range`});n.addEventListener("input",t=>{const s=parseFloat(t.target.value);this.transcriptStyle[e]=s,r.textContent=Math.round(100*s)+"%",this.applyTranscriptStyles(),this.savePreferences()});const o=h.createElement("div",{className:`${this.player.options.classPrefix}-transcript-style-range-container`});return o.appendChild(n),o.appendChild(r),s.appendChild(a),s.appendChild(o),s}savePreferences(){this.storage.saveTranscriptPreferences(this.transcriptStyle)}applyTranscriptStyles(){this.transcriptWindow&&(this.transcriptWindow.style.backgroundColor=this.transcriptStyle.backgroundColor,this.transcriptWindow.style.opacity=String(this.transcriptStyle.opacity),this.transcriptContent&&(this.transcriptContent.style.fontSize=this.transcriptStyle.fontSize,this.transcriptContent.style.fontFamily=this.transcriptStyle.fontFamily,this.transcriptContent.style.color=this.transcriptStyle.color),this.transcriptWindow.querySelectorAll(`.${this.player.options.classPrefix}-transcript-text`).forEach(t=>{t.style.fontSize=this.transcriptStyle.fontSize,t.style.fontFamily=this.transcriptStyle.fontFamily,t.style.color=this.transcriptStyle.color}),this.transcriptWindow.querySelectorAll(`.${this.player.options.classPrefix}-transcript-time`).forEach(t=>{t.style.fontFamily=this.transcriptStyle.fontFamily}))}setManagedTimeout(t,e){const s=setTimeout(()=>{this.timeouts.delete(s),t()},e);return this.timeouts.add(s),s}clearManagedTimeout(t){t&&(clearTimeout(t),this.timeouts.delete(t))}destroy(){this.hideResizeModeIndicator(),this.draggableResizable&&(this.draggableResizable.pointerResizeMode&&(this.draggableResizable.disablePointerResizeMode(),this.updateResizeOptionState()),this.draggableResizable.destroy(),this.draggableResizable=null),this.transcriptWindow&&this.customKeyHandler&&(this.transcriptWindow.removeEventListener("keydown",this.customKeyHandler),this.customKeyHandler=null),this.handlers.timeupdate&&this.player.off("timeupdate",this.handlers.timeupdate),this.handlers.audiodescriptionenabled&&this.player.off("audiodescriptionenabled",this.handlers.audiodescriptionenabled),this.handlers.audiodescriptiondisabled&&this.player.off("audiodescriptiondisabled",this.handlers.audiodescriptiondisabled),this.settingsButton&&(this.handlers.settingsClick&&this.settingsButton.removeEventListener("click",this.handlers.settingsClick),this.handlers.settingsKeydown&&this.settingsButton.removeEventListener("keydown",this.handlers.settingsKeydown)),this.handlers.styleDialogKeydown&&document.removeEventListener("keydown",this.handlers.styleDialogKeydown),this.handlers.documentClick&&document.removeEventListener("click",this.handlers.documentClick),this.handlers.resize&&window.removeEventListener("resize",this.handlers.resize),this.timeouts.forEach(t=>clearTimeout(t)),this.timeouts.clear(),this.handlers=null,this.transcriptWindow&&this.transcriptWindow.parentNode&&this.transcriptWindow.parentNode.removeChild(this.transcriptWindow),this.transcriptWindow=null,this.transcriptHeader=null,this.transcriptContent=null,this.transcriptEntries=[],this.settingsMenu=null,this.styleDialog=null,this.transcriptResizeHandles=[],this.resizeOptionButton=null,this.resizeOptionText=null,this.liveRegion=null}announceLive(t){this.liveRegion&&(this.liveRegion.textContent=t||"")}};export{c as TranscriptManager};