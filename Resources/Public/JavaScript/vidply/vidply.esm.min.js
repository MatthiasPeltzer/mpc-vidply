/*!
 * Universal, Accessible Video Player
 * (c) 2026 Matthias Peltzer
 * Released under GPL-2.0-or-later License
 */
import{TimeUtils as e}from"./vidply.chunk-AK4IZ5DH.min.js";import{HTML5Renderer as t}from"./vidply.chunk-G2P52V5M.min.js";import{CaptionManager as i,debounce as s,isMobile as a,rafWithTimeout as n,throttle as r}from"./vidply.chunk-NFACYQG2.min.js";import{StorageManager as o}from"./vidply.chunk-AE2Z46L5.min.js";import{DraggableResizable as l,attachMenuKeyboardNavigation as c,createIconElement as h,createLabeledSelect as u,createMenuItem as p,createPlayOverlay as d,focusElement as g,focusFirstElement as y,focusFirstMenuItem as m,preventDragOnElement as f}from"./vidply.chunk-7OK6TG2Y.min.js";import{DOMUtils as v,i18n as b}from"./vidply.chunk-YLKHFL57.min.js";var L=class{constructor(){this.events={}}on(e,t){return this.events[e]||(this.events[e]=[]),this.events[e].push(t),this}once(e,t){const i=(...s)=>{t(...s),this.off(e,i)};return this.on(e,i)}off(e,t){return this.events[e]?(t?this.events[e]=this.events[e].filter(e=>e!==t):delete this.events[e],this):this}emit(e,...t){return this.events[e]?(this.events[e].forEach(e=>{e(...t)}),this):this}removeAllListeners(){return this.events={},this}};async function k(e,t,i={}){if(!e||"VIDEO"!==e.tagName)return null;const{restoreState:s=!0,quality:a=.9,maxWidth:n,maxHeight:r}=i,o=!e.paused,l=e.currentTime,c=e.muted;return s&&(e.muted=!0),new Promise(i=>{const h=()=>{try{let t=e.videoWidth||640,h=e.videoHeight||360;if(n&&t>n){const e=n/t;t=n,h=Math.round(h*e)}if(r&&h>r){const e=r/h;h=r,t=Math.round(t*e)}const u=document.createElement("canvas");u.width=t,u.height=h,u.getContext("2d").drawImage(e,0,0,t,h);const p=u.toDataURL("image/jpeg",a);s&&(e.currentTime=l,e.muted=c,o&&!e.paused&&e.play().catch(()=>{})),i(p)}catch(t){s&&(e.currentTime=l,e.muted=c,o&&!e.paused&&e.play().catch(()=>{})),i(null)}},u=()=>{e.removeEventListener("seeked",u),requestAnimationFrame(()=>{requestAnimationFrame(h)})};if(Math.abs(e.currentTime-t)<.1&&e.readyState>=2)h();else if(e.readyState>=1)e.addEventListener("seeked",u),e.currentTime=t;else{const i=()=>{e.removeEventListener("loadedmetadata",i),e.addEventListener("seeked",u),e.currentTime=t};e.addEventListener("loadedmetadata",i)}})}var w=class{constructor(e){this.player=e,this.element=null,this.controls={},this.hideTimeout=null,this.isDraggingProgress=!1,this.isDraggingVolume=!1,this.openMenu=null,this.openMenuButton=null,this.init()}init(){this.createElement(),this.createControls(),this.updateDuration(),this.updateProgress(),this.attachEvents(),this.setupAutoHide(),this.setupOverflowDetection()}isTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}positionMenu(e,t,i=!1){const s=a(),n=e.classList.contains(`${this.player.options.classPrefix}-overflow-menu-list`);if(this.player.state.fullscreen&&e.parentElement===this.player.container){const s=()=>{const i=t.getBoundingClientRect(),s=e.getBoundingClientRect(),a=this.player.container.getBoundingClientRect(),r=(window,i.left+i.width/2-a.left),o=i.bottom-a.top,l=i.top-a.top;l>=s.height+20||l>a.bottom-i.bottom?(e.style.bottom=a.height-(i.top-a.top)+8+"px",e.style.top="auto",e.classList.remove("vidply-menu-below")):(e.style.top=`${o+8}px`,e.style.bottom="auto",e.classList.add("vidply-menu-below")),n?(e.style.right=a.width-(i.right-a.left)+"px",e.style.left="auto",e.style.transform="none"):(e.style.left=`${r}px`,e.style.right="auto",e.style.transform="translateX(-50%)")};return void(i?s():requestAnimationFrame(s))}if(s){const s=e.classList.contains(`${this.player.options.classPrefix}-volume-menu`),a=()=>{const i=t.parentElement;if(!i)return;const a=t.getBoundingClientRect(),n=i.getBoundingClientRect(),r=e.getBoundingClientRect(),o=window.innerWidth,l=window.innerHeight;if(s)return e.style.left=a.left+a.width/2-n.left+"px",e.style.right="auto",void(e.style.transform="translateX(-50%)");r.right>o&&(e.style.left="auto",e.style.right="10px",e.style.transform="none"),r.left<0&&(e.style.left="10px",e.style.right="auto",e.style.transform="none"),r.top<10&&(e.style.top="10px",e.style.bottom="auto"),r.bottom>l-10&&(e.style.bottom="10px",e.style.top="auto")};return void(i?a():requestAnimationFrame(a))}const r=()=>{const i=t.getBoundingClientRect(),s=e.getBoundingClientRect(),a=window.innerWidth,r=window.innerHeight,o=t.parentElement;if(!o)return;const l=o.getBoundingClientRect(),c=i.left+i.width/2-l.left,h=i.top;let u=i.top-l.top-s.height-8,p=null;h<s.height+20&&r-i.bottom>h?(u=null,p=l.bottom-l.top-(i.bottom-l.top)+8,e.classList.add("vidply-menu-below")):e.classList.remove("vidply-menu-below");let d="auto",g="auto",y="translateX(0)";if(n)d="auto",g=0,y="translateX(0)";else{d=c-s.width/2;const e=i.left+i.width/2-s.width/2;e<10?(d=0,y="translateX(0)"):e+s.width>a-10?(d="auto",g=0,y="translateX(0)"):(d=c,y="translateX(-50%)")}null!==u?(e.style.top=`${u}px`,e.style.bottom="auto"):null!==p&&(e.style.top="auto",e.style.bottom=`${p}px`),"auto"!==d?(e.style.left=`${d}px`,e.style.right="auto"):(e.style.left="auto",e.style.right=`${g}px`),e.style.transform=y};i?r():requestAnimationFrame(()=>{setTimeout(r,10)})}insertMenuIntoDOM(e,t){e.id||(e.id=`vidply-menu-${Math.random().toString(36).substr(2,9)}`),t.setAttribute("aria-controls",e.id),t.setAttribute("aria-haspopup","true"),this.player.state.fullscreen?(this.player.container.appendChild(e),e.dataset.triggerButton=t.getAttribute("aria-label")||"button"):t.insertAdjacentElement("afterend",e)}attachMenuCloseHandler(e,t,i=!1){this.openMenu&&this.openMenu!==e&&this.openMenuButton&&(this.openMenuButton._vidplyBlurHandler&&(this.openMenuButton.removeEventListener("blur",this.openMenuButton._vidplyBlurHandler),delete this.openMenuButton._vidplyBlurHandler),this.openMenuButton._vidplyMousedownHandler&&(this.openMenuButton.removeEventListener("mousedown",this.openMenuButton._vidplyMousedownHandler),delete this.openMenuButton._vidplyMousedownHandler),this.openMenu&&document.contains(this.openMenu)?this.openMenu.remove():this.openMenu&&this.openMenu.parentNode&&this.openMenu.parentNode.removeChild(this.openMenu),this.openMenuButton&&this.openMenuButton.setAttribute("aria-expanded","false")),this.openMenu=e,this.openMenuButton=t,this.positionMenu(e,t),t&&t.setAttribute("aria-expanded","true");let s=!1,a=!0;const n=()=>{s=!0,a=!1,setTimeout(()=>{s=!1,a=!0},200)};t.addEventListener("mousedown",n),t._vidplyMousedownHandler=n;const r=i=>{if(!a||s)return;if(this.openMenu!==e)return;const o=i.relatedTarget;requestAnimationFrame(()=>{setTimeout(()=>{if(!a||this.openMenu!==e)return;const i=document.activeElement;if(e.contains(i))return;const s=this.player.signLanguageWrapper,l=this.player.transcriptManager?.transcriptWindow;if(s&&s.contains(i)||l&&l.contains(i))return;const c=this.element.querySelectorAll("button"),h=Array.from(c).includes(i)&&i!==t,u=o&&Array.from(c).includes(o)&&o!==t;if(h||u){if(this.openMenu!==e)return;e&&document.contains(e)?e.remove():e&&e.parentNode&&e.parentNode.removeChild(e),t&&t.setAttribute("aria-expanded","false"),this.openMenu===e&&(this.openMenu=null,this.openMenuButton=null),t.removeEventListener("blur",r),t.removeEventListener("mousedown",n),delete t._vidplyBlurHandler,delete t._vidplyMousedownHandler}},10)})};t.addEventListener("blur",r),t._vidplyBlurHandler=r;const o=()=>{this.closeMenuAndReturnFocus(e,t)};let l=null,c=null;setTimeout(()=>{l=s=>{i&&e.contains(s.target)||this.openMenu!==e||e.contains(s.target)||t.contains(s.target)||(o(),l&&document.removeEventListener("click",l),c&&document.removeEventListener("keydown",c))},c=i=>{"Escape"===i.key&&this.openMenu===e&&(i.preventDefault(),i.stopPropagation(),this.closeMenuAndReturnFocus(e,t,!0),l&&document.removeEventListener("click",l),c&&document.removeEventListener("keydown",c))},document.addEventListener("click",l),document.addEventListener("keydown",c)},100)}closeMenuAndReturnFocus(e,t,i=!0){e&&(document.contains(e)?e.remove():e.parentNode&&e.parentNode.removeChild(e)),t&&(t.setAttribute("aria-expanded","false"),e&&e.id&&t.removeAttribute("aria-controls"),i&&requestAnimationFrame(()=>{setTimeout(()=>{t&&document.contains(t)&&t.focus({preventScroll:!0})},0)})),this.openMenu===e&&(this.openMenu=null,this.openMenuButton=null)}closeOpenMenu(){this.openMenu&&this.openMenuButton&&(this.openMenu&&document.contains(this.openMenu)?this.openMenu.remove():this.openMenu&&this.openMenu.parentNode&&this.openMenu.parentNode.removeChild(this.openMenu),this.openMenuButton&&this.openMenuButton.setAttribute("aria-expanded","false"),this.openMenu=null,this.openMenuButton=null)}attachMenuKeyboardNavigation(e,t){const i=Array.from(e.querySelectorAll(`.${this.player.options.classPrefix}-menu-item`));0!==i.length&&e.addEventListener("keydown",s=>{const a=i.indexOf(document.activeElement);switch(s.key){case"ArrowDown":s.preventDefault(),s.stopPropagation();const n=(a+1)%i.length;i[n].focus({preventScroll:!1}),i[n].scrollIntoView({behavior:"smooth",block:"nearest"});break;case"ArrowUp":s.preventDefault(),s.stopPropagation();const r=(a-1+i.length)%i.length;i[r].focus({preventScroll:!1}),i[r].scrollIntoView({behavior:"smooth",block:"nearest"});break;case"ArrowLeft":case"ArrowRight":s.preventDefault(),s.stopPropagation();break;case"Home":s.preventDefault(),s.stopPropagation(),i[0].focus({preventScroll:!1}),i[0].scrollIntoView({behavior:"smooth",block:"nearest"});break;case"End":s.preventDefault(),s.stopPropagation(),i[i.length-1].focus({preventScroll:!1}),i[i.length-1].scrollIntoView({behavior:"smooth",block:"nearest"});break;case"Enter":case" ":s.preventDefault(),s.stopPropagation(),document.activeElement&&i.includes(document.activeElement)&&(document.activeElement.click(),g(t,{delay:0}));break;case"Escape":s.preventDefault(),s.stopPropagation(),this.closeMenuAndReturnFocus(e,t,!0)}})}createElement(){this.element=v.createElement("div",{className:`${this.player.options.classPrefix}-controls`,attributes:{role:"region","aria-label":b.t("player.label")+" controls"}})}createControls(){const e=v.createElement("div",{className:`${this.player.options.classPrefix}-progress-time-wrapper`});this.player.options.progressBar&&(this.createProgressBar(),e.appendChild(this.controls.progress)),(this.player.options.currentTime||this.player.options.duration)&&e.appendChild(this.createTimeDisplay()),this.element.appendChild(e);const t=v.createElement("div",{className:`${this.player.options.classPrefix}-controls-buttons`}),i=v.createElement("div",{className:`${this.player.options.classPrefix}-controls-left`});this.player.playlistManager&&i.appendChild(this.createPreviousButton()),this.player.options.playPauseButton&&i.appendChild(this.createPlayPauseButton()),i.appendChild(this.createRestartButton()),this.player.playlistManager&&i.appendChild(this.createNextButton()),this.player.playlistManager||i.appendChild(this.createRewindButton()),this.player.playlistManager||i.appendChild(this.createForwardButton()),this.player.options.volumeControl&&(this.isTouchDevice()?i.appendChild(this.createMuteButton()):i.appendChild(this.createVolumeControl())),this.rightButtons=v.createElement("div",{className:`${this.player.options.classPrefix}-controls-right`});const s=this.hasChapterTracks(),a=this.hasCaptionTracks(),n=this.hasQualityLevels(),r=this.hasAudioDescription();if(this.player.options.chaptersButton&&s){const e=this.createChaptersButton();e.dataset.overflowPriority="3",e.dataset.overflowPriorityMobile="3",this.rightButtons.appendChild(e)}if(this.player.options.captionsButton&&a){const e=this.createCaptionsButton();e.dataset.overflowPriority="1",e.dataset.overflowPriorityMobile="3",this.rightButtons.appendChild(e)}if(this.player.options.captionStyleButton&&a){const e=this.createCaptionStyleButton();e.dataset.overflowPriority="3",e.dataset.overflowPriorityMobile="3",this.rightButtons.appendChild(e)}const o=this.player.currentSource||this.player.element?.getAttribute?.("src")||this.player.element?.currentSrc||this.player.element?.src||this.player.element?.querySelector?.("source")?.getAttribute?.("src")||this.player.element?.querySelector?.("source")?.src||"",l="string"==typeof o&&o.includes(".m3u8"),c="video"===this.player.element?.tagName?.toLowerCase();if(this.player.options.speedButton&&!(this.player.options.hideSpeedForHls&&l||this.player.options.hideSpeedForHlsVideo&&l&&c)){const e=this.createSpeedButton();e.dataset.overflowPriority="1",e.dataset.overflowPriorityMobile="3",this.rightButtons.appendChild(e)}if(this.player.options.audioDescriptionButton&&r){const e=this.createAudioDescriptionButton();e.dataset.overflowPriority="2",e.dataset.overflowPriorityMobile="3",this.rightButtons.appendChild(e)}if(this.player.options.transcriptButton&&a){const e=this.createTranscriptButton();e.dataset.overflowPriority="3",e.dataset.overflowPriorityMobile="3",this.rightButtons.appendChild(e)}if(this.player.playlistManager&&!1!==this.player.options.playlistToggleButton){const e=this.createPlaylistToggleButton();e.dataset.overflowPriority="2",e.dataset.overflowPriorityMobile="3",this.rightButtons.appendChild(e)}const h=this.hasSignLanguage(),u=this.player.options.signLanguageDisplayMode||"both";if(!1!==this.player.options.signLanguageButton&&h){if(["pip","both"].includes(u)){const e=this.createSignLanguageButton();e.dataset.overflowPriority="3",e.dataset.overflowPriorityMobile="3",this.rightButtons.appendChild(e)}if(["main","both"].includes(u)){const e=this.createSignLanguageInMainViewButton();e.dataset.overflowPriority="3",e.dataset.overflowPriorityMobile="3",this.rightButtons.appendChild(e)}}if(this.player.options.qualityButton&&n){const e=this.createQualityButton();e.dataset.overflowPriority="2",e.dataset.overflowPriorityMobile="3",this.rightButtons.appendChild(e)}if(this.player.options.pipButton&&"pictureInPictureEnabled"in document){const e=this.createPipButton();e.dataset.overflowPriority="3",e.dataset.overflowPriorityMobile="3",this.rightButtons.appendChild(e)}const p="audio"===this.player.element.tagName.toLowerCase();if(this.player.options.fullscreenButton&&!p){const e=this.createFullscreenButton();e.dataset.overflowPriority="1",e.dataset.overflowPriorityMobile="3",this.rightButtons.appendChild(e)}this.overflowMenuButton=this.createOverflowMenuButton(),this.overflowMenuButton.style.display="none",this.rightButtons.appendChild(this.overflowMenuButton),t.appendChild(i),t.appendChild(this.rightButtons),this.element.appendChild(t),this.ensureButtonTooltips(t)}ensureButtonTooltips(e){e.querySelectorAll("button").forEach(e=>{if(e.querySelector(`.${this.player.options.classPrefix}-tooltip`))return;if(e.querySelector(`.${this.player.options.classPrefix}-button-text`))return;if("menuitem"===e.getAttribute("role")||e.classList.contains(`${this.player.options.classPrefix}-settings-item`)||e.classList.contains(`${this.player.options.classPrefix}-menu-item`)||e.classList.contains(`${this.player.options.classPrefix}-transcript-settings-item`)||e.classList.contains(`${this.player.options.classPrefix}-sign-language-settings-item`)||e.classList.contains(`${this.player.options.classPrefix}-popup-settings-item`))return;const t=e.getAttribute("aria-label");t&&v.attachTooltip(e,t,this.player.options.classPrefix)})}hasChapterTracks(){const e=this.player.element.textTracks;for(let t=0;t<e.length;t++)if("chapters"===e[t].kind)return!0;if(Array.from(this.player.element.querySelectorAll('track[kind="chapters"]')).length>0)return!0;const t=this.player.playlistManager?.getCurrentTrack?.();return!(!t?.tracks||!Array.isArray(t.tracks))&&t.tracks.some(e=>"chapters"===e?.kind)}hasCaptionTracks(){const e=this.player.element.textTracks;for(let t=0;t<e.length;t++)if("captions"===e[t].kind||"subtitles"===e[t].kind)return!0;if(Array.from(this.player.element.querySelectorAll("track")).some(e=>"captions"===e.getAttribute("kind")||"subtitles"===e.getAttribute("kind")))return!0;const t=this.player.playlistManager?.getCurrentTrack?.();return!!t?.tracks?.some(e=>"captions"===e?.kind||"subtitles"===e?.kind)}hasQualityLevels(){if(this.player.renderer&&this.player.renderer.getQualities){const e=this.player.renderer.getQualities();return e&&e.length>1}return!1}hasAudioDescription(){return!!(this.player.audioDescriptionSrc&&this.player.audioDescriptionSrc.length>0)||Array.from(this.player.element.textTracks||[]).some(e=>"descriptions"===e.kind)}hasSignLanguage(){const e=this.player.signLanguageSrc&&this.player.signLanguageSrc.length>0,t=this.player.signLanguageSources&&Object.keys(this.player.signLanguageSources).length>0;return e||t}createProgressBar(){const e=v.createElement("div",{className:`${this.player.options.classPrefix}-progress-container`,attributes:{role:"slider","aria-label":b.t("player.progress"),"aria-valuemin":"0","aria-valuemax":"100","aria-valuenow":"0",tabindex:"0"}});this.controls.buffered=v.createElement("div",{className:`${this.player.options.classPrefix}-progress-buffered`}),this.controls.played=v.createElement("div",{className:`${this.player.options.classPrefix}-progress-played`}),this.controls.progressHandle=v.createElement("div",{className:`${this.player.options.classPrefix}-progress-handle`}),this.controls.progressTooltip=v.createElement("div",{className:`${this.player.options.classPrefix}-progress-tooltip`}),this.controls.progressPreview=v.createElement("div",{className:`${this.player.options.classPrefix}-progress-preview`,attributes:{"aria-hidden":"true"}}),this.controls.progressTooltip.appendChild(this.controls.progressPreview),this.controls.progressTooltipTime=v.createElement("div",{className:`${this.player.options.classPrefix}-progress-tooltip-time`}),this.controls.progressTooltip.appendChild(this.controls.progressTooltipTime),e.appendChild(this.controls.buffered),e.appendChild(this.controls.played),this.controls.played.appendChild(this.controls.progressHandle),e.appendChild(this.controls.progressTooltip),this.controls.progress=e,this.initPreviewThumbnail(),this.setupProgressBarEvents()}initPreviewThumbnail(){this.previewThumbnailCache=new Map,this.previewVideo=null,this.currentPreviewTime=null,this.previewThumbnailTimeout=null,this.previewSupported=!1,this.previewVideoReady=!1,this.previewVideoInitialized=!1,this.previewUsingMainVideo=!1}ensurePreviewVideoInitialized(){if(this.previewVideoInitialized)return;if(!this.player?.state?.hasStartedPlayback)return;if(!1===this.player.options.thumbnailPreview)return this.previewSupported=!1,void(this.previewVideoInitialized=!0);const e=this.player.renderer,t=e&&e.media&&"VIDEO"===e.media.tagName;if(!t)return this.previewSupported=!1,void(this.previewVideoInitialized=!0);const i=e.hls&&void 0!==e.hls.loadLevel,s=t&&e.media===this.player.element&&!i&&"function"==typeof e.seek;if(i)return this.previewVideo=null,this.previewVideoReady=!1,this.previewSupported=!1,this.previewUsingMainVideo=!1,this.previewVideoInitialized=!0,void this.player.log("Preview thumbnails disabled for HLS streams","info");if(this.previewSupported=s&&t,!this.previewSupported)return void(this.previewVideoInitialized=!0);const a=e.media||this.player.element;let n=null;if(a.src)n=a.src;else{const e=a.querySelector("source");e&&(n=e.src)}if(!n)return this.player.log("No video source found for preview","warn"),this.previewSupported=!1,void(this.previewVideoInitialized=!0);this.previewVideo=document.createElement("video"),this.previewVideo.muted=!0,this.previewVideo.preload="auto",this.previewVideo.playsInline=!0,this.previewVideo.style.position="absolute",this.previewVideo.style.visibility="hidden",this.previewVideo.style.width="1px",this.previewVideo.style.height="1px",this.previewVideo.style.top="-9999px",a.crossOrigin&&(this.previewVideo.crossOrigin=a.crossOrigin),this.previewVideo.addEventListener("error",e=>{this.player.log("Preview video failed to load:",e,"warn"),this.previewSupported=!1}),this.previewVideo.addEventListener("loadedmetadata",()=>{this.previewVideoReady=!0,this.player.options.thumbnailPregenerate&&this.pregenerateThumbnails()},{once:!0}),this.player.container&&this.player.container.appendChild(this.previewVideo),this.previewVideo.src=n,this.previewVideoReady=!1,this.previewUsingMainVideo=!1,this.previewVideoInitialized=!0}pregenerateThumbnails(){if(!this.previewSupported||!this.previewVideo)return;if(!window.requestIdleCallback)return;const e=this.player.state.duration;if(!e||e<=0)return;const t=this.player.options.thumbnailInterval||10,i=[];for(let s=0;s<e;s+=t){const e=Math.floor(s);this.previewThumbnailCache.has(e)||i.push(s)}if(0===i.length)return;this.player.log(`Pre-generating ${i.length} thumbnails`,"debug");const s=e=>{for(;e.timeRemaining()>50&&i.length>0;){const e=i.shift();this.generatePreviewThumbnail(e).catch(()=>{})}i.length>0&&this.previewSupported&&requestIdleCallback(s,{timeout:5e3})};requestIdleCallback(s,{timeout:5e3})}async generatePreviewThumbnail(e){if(!this.previewSupported||!this.previewVideo)return null;this.previewVideoReady||(this.previewVideo.readyState<2?await new Promise((e,t)=>{const i=setTimeout(()=>{t(new Error("Preview video data load timeout"))},1e4),s=()=>{clearTimeout(i),this.previewVideo.removeEventListener("loadeddata",a),this.previewVideo.removeEventListener("canplay",a),this.previewVideo.removeEventListener("error",n)},a=()=>{this.previewVideo.readyState>=2&&(s(),this.previewVideoReady=!0,e())},n=()=>{s(),t(new Error("Preview video failed to load"))};this.previewVideo.readyState>=1&&this.previewVideo.addEventListener("loadeddata",a),this.previewVideo.addEventListener("canplay",a),this.previewVideo.addEventListener("error",n),this.previewVideo.readyState>=2&&a()}).catch(()=>(this.previewSupported=!1,null)):this.previewVideoReady=!0);const t=Math.floor(e);if(this.previewThumbnailCache.has(t))return this.previewThumbnailCache.get(t);const i=this.previewUsingMainVideo,s=this.player.options.thumbnailQuality||.8,a=this.player.options.thumbnailWidth||160,n=this.player.options.thumbnailHeight||90,r=await k(this.previewVideo,e,{restoreState:i,quality:s,maxWidth:a,maxHeight:n});if(r){if(this.previewThumbnailCache.size>=(this.player.options.thumbnailCacheSize||50)){const e=this.previewThumbnailCache.keys().next().value;this.previewThumbnailCache.delete(e)}this.previewThumbnailCache.set(t,r)}return r}async updatePreviewThumbnail(e){this.previewSupported&&this.controls.progressPreview&&(this.previewThumbnailTimeout&&clearTimeout(this.previewThumbnailTimeout),this.previewThumbnailTimeout=setTimeout(async()=>{try{const t=await this.generatePreviewThumbnail(e);t&&this.controls.progressPreview?(this.controls.progressPreview.style.backgroundImage=`url("${t}")`,this.controls.progressPreview.style.display="block",this.controls.progressPreview.style.backgroundRepeat="no-repeat",this.controls.progressPreview.style.backgroundPosition="center"):this.controls.progressPreview&&(this.controls.progressPreview.style.display="none"),this.currentPreviewTime=e}catch(e){this.player.log("Preview thumbnail update failed:",e,"warn"),this.controls.progressPreview&&(this.controls.progressPreview.style.display="none")}},100))}setupProgressBarEvents(){const t=this.controls.progress,i=e=>{const i=t.getBoundingClientRect(),s=i.width>0?Math.max(0,Math.min(1,(e-i.left)/i.width)):0;return{percent:s,time:s*(this.player.state.duration||0)}};t.addEventListener("mousedown",e=>{this.isDraggingProgress=!0;const{time:t}=i(e.clientX);this.player.seek(t)}),document.addEventListener("mousemove",e=>{if(this.isDraggingProgress){const{time:t}=i(e.clientX);this.player.seek(t)}}),document.addEventListener("mouseup",()=>{this.isDraggingProgress=!1}),t.addEventListener("mousemove",s=>{if(!this.isDraggingProgress){const{time:a}=i(s.clientX),n=t.getBoundingClientRect(),r=s.clientX-n.left;if(this.controls.progressTooltipTime.textContent=e.formatTime(a),this.controls.progressTooltip.style.left=`${r}px`,this.controls.progressTooltip.style.display="block",!this.player?.state?.hasStartedPlayback)return void(this.controls.progressPreview&&(this.controls.progressPreview.style.display="none"));this.ensurePreviewVideoInitialized(),this.previewSupported?this.updatePreviewThumbnail(a):this.controls.progressPreview&&(this.controls.progressPreview.style.display="none")}}),t.addEventListener("mouseleave",()=>{this.controls.progressTooltip.style.display="none",this.previewThumbnailTimeout&&clearTimeout(this.previewThumbnailTimeout)}),t.addEventListener("keydown",e=>{"ArrowLeft"===e.key?(e.preventDefault(),this.player.seekBackward(5)):"ArrowRight"===e.key&&(e.preventDefault(),this.player.seekForward(5))}),t.addEventListener("touchstart",e=>{this.isDraggingProgress=!0;const t=e.touches[0],{time:s}=i(t.clientX);this.player.seek(s)}),t.addEventListener("touchmove",e=>{if(this.isDraggingProgress){e.preventDefault();const t=e.touches[0],{time:s}=i(t.clientX);this.player.seek(s)}}),t.addEventListener("touchend",()=>{this.isDraggingProgress=!1})}createPlayPauseButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-play-pause`,attributes:{type:"button","aria-label":b.t("player.play")}});return e.appendChild(h("play")),e.addEventListener("click",()=>{this.player.toggle()}),this.controls.playPause=e,e}createRestartButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-restart`,attributes:{type:"button","aria-label":b.t("player.restart")}});return e.appendChild(h("restart")),e.addEventListener("click",()=>{this.player.seek(0),this.player.play()}),e}createPreviousButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-previous`,attributes:{type:"button","aria-label":b.t("player.previous")}});e.appendChild(h("skipPrevious")),e.addEventListener("click",()=>{this.player.playlistManager&&this.player.playlistManager.previous()});const t=()=>{this.player.playlistManager&&(e.disabled=!this.player.playlistManager.hasPrevious()&&!this.player.playlistManager.options.loop)};return this.player.on("playlisttrackchange",t),t(),this.controls.previous=e,e}createNextButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-next`,attributes:{type:"button","aria-label":b.t("player.next")}});e.appendChild(h("skipNext")),e.addEventListener("click",()=>{this.player.playlistManager&&this.player.playlistManager.next()});const t=()=>{this.player.playlistManager&&(e.disabled=!this.player.playlistManager.hasNext()&&!this.player.playlistManager.options.loop)};return this.player.on("playlisttrackchange",t),t(),this.controls.next=e,e}createPlaylistToggleButton(){const e=this.player.playlistManager?`${this.player.playlistManager.uniqueId}-panel`:"vidply-playlist-panel",t=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-playlist-toggle`,attributes:{type:"button","aria-label":b.t("player.playlist"),"aria-expanded":"false","aria-pressed":"false","aria-controls":e}});return t.appendChild(h("playlist")),t.addEventListener("click",()=>{this.player.playlistManager&&this.player.playlistManager.togglePanel()}),this.controls.playlistToggle=t,t}createRewindButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-rewind`,attributes:{type:"button","aria-label":b.t("player.rewindSeconds",{seconds:15})}});return e.appendChild(h("rewind")),e.addEventListener("click",()=>{this.player.seekBackward(15)}),e}createForwardButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-forward`,attributes:{type:"button","aria-label":b.t("player.forwardSeconds",{seconds:15})}});return e.appendChild(h("forward")),e.addEventListener("click",()=>{this.player.seekForward(15)}),e}createMuteButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-mute`,attributes:{type:"button","aria-label":b.t("player.mute")}});return e.appendChild(h("volumeHigh")),e.addEventListener("click",()=>{this.player.toggleMute()}),this.controls.mute=e,e}createVolumeControl(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-mute`,attributes:{type:"button","aria-label":b.t("player.volume"),"aria-expanded":"false"}});return e.appendChild(h("volumeHigh")),e.addEventListener("contextmenu",e=>{e.preventDefault(),this.player.toggleMute()}),e.addEventListener("click",()=>{this.showVolumeSlider(e)}),this.controls.mute=e,e}showVolumeSlider(e){const t=document.querySelector(`.${this.player.options.classPrefix}-volume-menu`);if(t)return t.remove(),void e.setAttribute("aria-expanded","false");const i=v.createElement("div",{className:`${this.player.options.classPrefix}-volume-menu ${this.player.options.classPrefix}-menu`}),s=v.createElement("div",{className:`${this.player.options.classPrefix}-volume-slider`,attributes:{role:"slider","aria-label":b.t("player.volume"),"aria-valuemin":"0","aria-valuemax":"100","aria-valuenow":String(Math.round(100*this.player.state.volume)),tabindex:"0"}}),a=v.createElement("div",{className:`${this.player.options.classPrefix}-volume-track`}),n=v.createElement("div",{className:`${this.player.options.classPrefix}-volume-fill`});n.style.height=100*this.player.state.volume+"%";const r=v.createElement("div",{className:`${this.player.options.classPrefix}-volume-handle`});a.appendChild(n),n.appendChild(r),s.appendChild(a),i.appendChild(s);const o=e=>{const t=a.getBoundingClientRect(),i=Math.max(0,Math.min(1,1-(e-t.top)/t.height));this.player.setVolume(i)};s.addEventListener("mousedown",e=>{e.stopPropagation(),e.preventDefault(),this.isDraggingVolume=!0,o(e.clientY)}),document.addEventListener("mousemove",e=>{this.isDraggingVolume&&o(e.clientY)}),document.addEventListener("mouseup",()=>{this.isDraggingVolume=!1}),s.addEventListener("touchstart",e=>{e.stopPropagation(),e.preventDefault(),this.isDraggingVolume=!0,o(e.touches[0].clientY)},{passive:!1}),s.addEventListener("touchmove",e=>{this.isDraggingVolume&&(e.preventDefault(),o(e.touches[0].clientY))},{passive:!1}),s.addEventListener("touchend",e=>{e.stopPropagation(),e.preventDefault(),this.isDraggingVolume=!1},{passive:!1}),s.addEventListener("touchcancel",()=>{this.isDraggingVolume=!1}),s.addEventListener("keydown",t=>{"ArrowUp"===t.key?(t.preventDefault(),this.player.setVolume(Math.min(1,this.player.state.volume+.1))):"ArrowDown"===t.key?(t.preventDefault(),this.player.setVolume(Math.max(0,this.player.state.volume-.1))):"Escape"===t.key&&(t.preventDefault(),t.stopPropagation(),this.closeMenuAndReturnFocus(i,e,!0))}),i.addEventListener("click",e=>{e.stopPropagation()}),i.addEventListener("touchstart",e=>{e.stopPropagation()}),i.addEventListener("touchmove",e=>{e.stopPropagation()}),i.addEventListener("touchend",e=>{e.stopPropagation()}),i.style.visibility="hidden",i.style.display="block",this.insertMenuIntoDOM(i,e),this.positionMenu(i,e,!0),requestAnimationFrame(()=>{i.style.visibility="visible"}),this.controls.volumeSlider=s,this.controls.volumeFill=n,g(s,{delay:50}),this.attachMenuCloseHandler(i,e,!0)}createTimeDisplay(){const e=v.createElement("div",{className:`${this.player.options.classPrefix}-time`,attributes:{role:"group","aria-label":b.t("time.display")}});this.controls.currentTimeDisplay=v.createElement("span",{className:`${this.player.options.classPrefix}-current-time`});const t=v.createElement("span",{textContent:"00:00",attributes:{"aria-hidden":"true"}}),i=v.createElement("span",{className:"vidply-sr-only",textContent:b.t("time.seconds",{count:0})});this.controls.currentTimeDisplay.appendChild(t),this.controls.currentTimeDisplay.appendChild(i),this.controls.currentTimeVisual=t,this.controls.currentTimeAccessible=i;const s=v.createElement("span",{textContent:" / ",attributes:{"aria-hidden":"true"}});this.controls.durationDisplay=v.createElement("span",{className:`${this.player.options.classPrefix}-duration`});const a=v.createElement("span",{textContent:"00:00",attributes:{"aria-hidden":"true"}}),n=v.createElement("span",{className:"vidply-sr-only",textContent:b.t("time.durationPrefix")+b.t("time.seconds",{count:0})});return this.controls.durationDisplay.appendChild(a),this.controls.durationDisplay.appendChild(n),this.controls.durationVisual=a,this.controls.durationAccessible=n,e.appendChild(this.controls.currentTimeDisplay),e.appendChild(s),e.appendChild(this.controls.durationDisplay),e}createChaptersButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-chapters`,attributes:{type:"button","aria-label":b.t("player.chapters"),"aria-expanded":"false"}});return e.appendChild(h("chapters")),e.addEventListener("click",()=>{this.showChaptersMenu(e)}),this.controls.chapters=e,e}showChaptersMenu(t){const i=document.querySelector(`.${this.player.options.classPrefix}-chapters-menu`);if(i)return i.remove(),t.setAttribute("aria-expanded","false"),void(this.openMenu===i&&(this.openMenu=null,this.openMenuButton=null));const s=v.createElement("div",{className:`${this.player.options.classPrefix}-chapters-menu ${this.player.options.classPrefix}-menu`,attributes:{role:"menu","aria-label":b.t("player.chapters")}}),a=Array.from(this.player.element.textTracks).filter(e=>"chapters"===e.kind);if(0===a.length){const e=v.createElement("div",{className:`${this.player.options.classPrefix}-menu-item`,textContent:b.t("player.noChapters"),attributes:{role:"menuitem"},style:{opacity:"0.5",cursor:"default"}});s.appendChild(e)}else{const i=a[0];if("disabled"===i.mode&&(i.mode="hidden"),i.cues&&0!==i.cues.length){const a=i.cues;for(let i=0;i<a.length;i++){const n=a[i],r=v.createElement("button",{className:`${this.player.options.classPrefix}-menu-item`,attributes:{type:"button",role:"menuitem",tabindex:"-1"}}),o=v.createElement("span",{className:`${this.player.options.classPrefix}-chapter-time`,textContent:e.formatTime(n.startTime),attributes:{"aria-label":e.formatDuration(n.startTime)}}),l=v.createElement("span",{className:`${this.player.options.classPrefix}-chapter-title`,textContent:n.text});r.appendChild(o),r.appendChild(document.createTextNode(" ")),r.appendChild(l),r.addEventListener("click",()=>{this.player.seek(n.startTime),this.closeMenuAndReturnFocus(s,t)}),s.appendChild(r)}this.attachMenuKeyboardNavigation(s,t),setTimeout(()=>{const e=s.querySelector(`.${this.player.options.classPrefix}-menu-item`);e&&e.focus({preventScroll:!0})},0)}else{const e=v.createElement("div",{className:`${this.player.options.classPrefix}-menu-item`,textContent:b.t("player.loadingChapters"),attributes:{role:"menuitem"},style:{opacity:"0.5",cursor:"default"}});s.appendChild(e),i.addEventListener("load",()=>{s.remove(),this.showChaptersMenu(t)},{once:!0}),setTimeout(()=>{i.cues&&i.cues.length>0&&document.contains(s)&&(s.remove(),this.showChaptersMenu(t))},500)}}s.style.visibility="hidden",s.style.display="block",this.insertMenuIntoDOM(s,t),this.positionMenu(s,t,!0),requestAnimationFrame(()=>{s.style.visibility="visible"}),this.attachMenuCloseHandler(s,t)}createQualityButton(){const e=b.t("player.quality"),t=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-quality`,attributes:{type:"button","aria-label":e,"aria-expanded":"false"}});t.appendChild(h("hd")),v.attachTooltip(t,e,this.player.options.classPrefix);const i=v.createElement("span",{className:`${this.player.options.classPrefix}-quality-text`,textContent:""});return t.appendChild(i),t.addEventListener("click",()=>{this.showQualityMenu(t)}),this.controls.quality=t,this.controls.qualityText=i,setTimeout(()=>this.updateQualityIndicator(),500),t}showQualityMenu(e){const t=document.querySelector(`.${this.player.options.classPrefix}-quality-menu`);if(t)return t.remove(),e.setAttribute("aria-expanded","false"),void(this.openMenu===t&&(this.openMenu=null,this.openMenuButton=null));const i=v.createElement("div",{className:`${this.player.options.classPrefix}-quality-menu ${this.player.options.classPrefix}-menu`,attributes:{role:"menu","aria-label":b.t("player.quality")}});if(this.player.renderer&&this.player.renderer.getQualities){const t=this.player.renderer.getQualities(),s=this.player.renderer.getCurrentQuality?this.player.renderer.getCurrentQuality():-1,a=void 0!==this.player.renderer.hls;if(0===t.length){const e=v.createElement("div",{className:`${this.player.options.classPrefix}-menu-item`,textContent:b.t("player.autoQuality"),attributes:{role:"menuitem"},style:{opacity:"0.5",cursor:"default"}});i.appendChild(e)}else{let n=null;if(a){const t=v.createElement("button",{className:`${this.player.options.classPrefix}-menu-item`,textContent:b.t("player.auto"),attributes:{type:"button",role:"menuitem",tabindex:"-1"}});this.player.renderer.hls&&-1===this.player.renderer.hls.currentLevel&&(t.classList.add(`${this.player.options.classPrefix}-menu-item-active`),t.appendChild(h("check")),n=t),t.addEventListener("click",()=>{this.player.renderer.switchQuality&&this.player.renderer.switchQuality(-1),this.closeMenuAndReturnFocus(i,e)}),i.appendChild(t)}t.forEach(t=>{const a=v.createElement("button",{className:`${this.player.options.classPrefix}-menu-item`,textContent:t.name||`${t.height}p`,attributes:{type:"button",role:"menuitem",tabindex:"-1"}});t.index===s&&(a.classList.add(`${this.player.options.classPrefix}-menu-item-active`),a.appendChild(h("check")),n=a),a.addEventListener("click",()=>{this.player.renderer.switchQuality&&this.player.renderer.switchQuality(t.index),this.closeMenuAndReturnFocus(i,e)}),i.appendChild(a)}),this.attachMenuKeyboardNavigation(i,e),setTimeout(()=>{const e=n||i.querySelector(`.${this.player.options.classPrefix}-menu-item`);e&&e.focus({preventScroll:!0})},0)}}else{const e=v.createElement("div",{className:`${this.player.options.classPrefix}-menu-item`,textContent:b.t("player.noQuality"),style:{opacity:"0.5",cursor:"default"}});i.appendChild(e)}i.style.visibility="hidden",i.style.display="block",this.insertMenuIntoDOM(i,e),this.positionMenu(i,e,!0),requestAnimationFrame(()=>{i.style.visibility="visible"}),this.attachMenuCloseHandler(i,e)}createCaptionStyleButton(){const e=b.t("player.captionStyling"),t=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-caption-style`,attributes:{type:"button","aria-label":e,"aria-expanded":"false"}}),i=v.createElement("span",{textContent:"Aa",style:{fontSize:"14px",fontWeight:"bold"}});return t.appendChild(i),v.attachTooltip(t,e,this.player.options.classPrefix),t.addEventListener("click",()=>{this.showCaptionStyleMenu(t)}),this.controls.captionStyle=t,t}showCaptionStyleMenu(e){const t=document.querySelector(`.${this.player.options.classPrefix}-caption-style-menu`);if(t)return t.remove(),e.setAttribute("aria-expanded","false"),void(this.openMenu===t&&(this.openMenu=null,this.openMenuButton=null));const i=v.createElement("div",{className:`${this.player.options.classPrefix}-caption-style-menu ${this.player.options.classPrefix}-menu ${this.player.options.classPrefix}-settings-menu`,attributes:{role:"menu","aria-label":b.t("player.captionStyling")}});if(i.addEventListener("click",e=>{e.stopPropagation()}),!this.player.captionManager||0===this.player.captionManager.tracks.length){const t=v.createElement("div",{className:`${this.player.options.classPrefix}-menu-item`,textContent:b.t("player.noCaptions"),attributes:{role:"menuitem"},style:{opacity:"0.5",cursor:"default",padding:"12px 16px"}});return i.appendChild(t),i.style.visibility="hidden",i.style.display="block",this.insertMenuIntoDOM(i,e),this.positionMenu(i,e,!0),requestAnimationFrame(()=>{i.style.visibility="visible"}),void this.attachMenuCloseHandler(i,e,!0)}const s=this.createStyleControl(b.t("styleLabels.fontSize"),"captionsFontSize",[{label:b.t("fontSizes.small"),value:"87.5%"},{label:b.t("fontSizes.normal"),value:"100%"},{label:b.t("fontSizes.large"),value:"125%"},{label:b.t("fontSizes.xlarge"),value:"150%"}]);i.appendChild(s);const a=this.createStyleControl(b.t("styleLabels.font"),"captionsFontFamily",[{label:b.t("fontFamilies.sansSerif"),value:"sans-serif"},{label:b.t("fontFamilies.serif"),value:"serif"},{label:b.t("fontFamilies.monospace"),value:"monospace"}]);i.appendChild(a);const n=this.createColorControl(b.t("styleLabels.textColor"),"captionsColor");i.appendChild(n);const r=this.createColorControl(b.t("styleLabels.background"),"captionsBackgroundColor");i.appendChild(r);const o=this.createOpacityControl(b.t("styleLabels.opacity"),"captionsOpacity");i.appendChild(o),i.style.minWidth="220px",i.style.visibility="hidden",i.style.display="block",this.insertMenuIntoDOM(i,e),this.positionMenu(i,e,!0),requestAnimationFrame(()=>{i.style.visibility="visible"}),this.attachMenuCloseHandler(i,e,!0),y(i,`.${this.player.options.classPrefix}-style-select`)}createStyleControl(e,t,i){const s=v.createElement("div",{className:`${this.player.options.classPrefix}-style-group`}),a=`${this.player.options.classPrefix}-${t}-${Date.now()}`,n=v.createElement("label",{textContent:e,attributes:{for:a},style:{display:"block",fontSize:"12px",marginBottom:"4px",color:"rgba(255,255,255,0.7)"}});s.appendChild(n);const r=v.createElement("select",{className:`${this.player.options.classPrefix}-style-select`,attributes:{id:a},style:{width:"100%",padding:"6px",background:"var(--vidply-white)",border:"1px solid var(--vidply-white-10)",borderRadius:"4px",color:"var(--vidply-black)",fontSize:"13px"}}),o=this.player.options[t];return i.forEach(e=>{const t=v.createElement("option",{textContent:e.label,attributes:{value:e.value}});e.value===o&&(t.selected=!0),r.appendChild(t)}),r.addEventListener("mousedown",e=>{e.stopPropagation()}),r.addEventListener("click",e=>{e.stopPropagation()}),r.addEventListener("change",e=>{e.stopPropagation(),this.player.options[t]=e.target.value,this.player.captionManager&&this.player.captionManager.setCaptionStyle(t.replace("captions","").charAt(0).toLowerCase()+t.replace("captions","").slice(1),e.target.value)}),s.appendChild(r),s}createColorControl(e,t){const i=v.createElement("div",{className:`${this.player.options.classPrefix}-style-group`}),s=`${this.player.options.classPrefix}-${t}-${Date.now()}`,a=v.createElement("label",{textContent:e,attributes:{for:s},style:{display:"block",fontSize:"12px",marginBottom:"4px",color:"rgba(255,255,255,0.7)"}});i.appendChild(a);const n=v.createElement("input",{attributes:{id:s,type:"color",value:this.player.options[t]},style:{width:"100%",height:"32px",padding:"2px",background:"rgba(255,255,255,0.1)",border:"1px solid rgba(255,255,255,0.2)",borderRadius:"4px",cursor:"pointer"}});return n.addEventListener("mousedown",e=>{e.stopPropagation()}),n.addEventListener("click",e=>{e.stopPropagation()}),n.addEventListener("change",e=>{e.stopPropagation(),this.player.options[t]=e.target.value,this.player.captionManager&&this.player.captionManager.setCaptionStyle(t.replace("captions","").charAt(0).toLowerCase()+t.replace("captions","").slice(1),e.target.value)}),i.appendChild(n),i}createOpacityControl(e,t){const i=v.createElement("div",{className:`${this.player.options.classPrefix}-style-group`}),s=`${this.player.options.classPrefix}-${t}-${Date.now()}`,a=v.createElement("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"}}),n=v.createElement("label",{textContent:e,attributes:{for:s},style:{fontSize:"12px",color:"rgba(255,255,255,0.7)"}}),r=v.createElement("span",{textContent:Math.round(100*this.player.options[t])+"%",style:{fontSize:"12px",color:"rgba(255,255,255,0.7)"}});a.appendChild(n),a.appendChild(r),i.appendChild(a);const o=v.createElement("input",{attributes:{id:s,type:"range",min:"0",max:"1",step:"0.1",value:String(this.player.options[t])},style:{width:"100%",cursor:"pointer"}});return o.addEventListener("mousedown",e=>{e.stopPropagation()}),o.addEventListener("click",e=>{e.stopPropagation()}),o.addEventListener("input",e=>{e.stopPropagation();const i=parseFloat(e.target.value);r.textContent=Math.round(100*i)+"%",this.player.options[t]=i,this.player.captionManager&&this.player.captionManager.setCaptionStyle(t.replace("captions","").charAt(0).toLowerCase()+t.replace("captions","").slice(1),i)}),i.appendChild(o),i}createSpeedButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-speed`,attributes:{type:"button","aria-label":b.t("player.speed"),"aria-expanded":"false"}});e.appendChild(h("speed"));const t=v.createElement("span",{className:`${this.player.options.classPrefix}-speed-text`,textContent:"1x"});return e.appendChild(t),e.addEventListener("click",()=>{this.showSpeedMenu(e)}),this.controls.speed=e,this.controls.speedText=t,e}formatSpeedLabel(e){return 1===e?b.t("speeds.normal"):`${e.toLocaleString(b.getLanguage(),{minimumFractionDigits:0,maximumFractionDigits:2})}Ã—`}showSpeedMenu(e){const t=document.querySelector(`.${this.player.options.classPrefix}-speed-menu`);if(t)return t.remove(),e.setAttribute("aria-expanded","false"),void(this.openMenu===t&&(this.openMenu=null,this.openMenuButton=null));const i=v.createElement("div",{className:`${this.player.options.classPrefix}-speed-menu ${this.player.options.classPrefix}-menu`,attributes:{role:"menu"}});let s=null;[.25,.5,.75,1,1.25,1.5,1.75,2].forEach(t=>{const a=v.createElement("button",{className:`${this.player.options.classPrefix}-menu-item`,textContent:this.formatSpeedLabel(t),attributes:{type:"button",role:"menuitem",tabindex:"-1"}});t===this.player.state.playbackSpeed&&(a.classList.add(`${this.player.options.classPrefix}-menu-item-active`),a.appendChild(h("check")),s=a),a.addEventListener("click",()=>{this.player.setPlaybackSpeed(t),this.closeMenuAndReturnFocus(i,e)}),i.appendChild(a)}),i.style.visibility="hidden",i.style.display="block",this.insertMenuIntoDOM(i,e),this.positionMenu(i,e,!0),requestAnimationFrame(()=>{i.style.visibility="visible"}),this.attachMenuKeyboardNavigation(i,e),this.attachMenuCloseHandler(i,e),setTimeout(()=>{const e=s||i.querySelector(`.${this.player.options.classPrefix}-menu-item`);e&&e.focus({preventScroll:!0})},0)}createCaptionsButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-captions-button`,attributes:{type:"button","aria-label":b.t("player.captions"),"aria-expanded":"false"}});return e.appendChild(h("captionsOff")),e.addEventListener("click",()=>{this.showCaptionsMenu(e)}),this.controls.captions=e,e}showCaptionsMenu(e){const t=document.querySelector(`.${this.player.options.classPrefix}-captions-menu`);if(t)return t.remove(),e.setAttribute("aria-expanded","false"),void(this.openMenu===t&&(this.openMenu=null,this.openMenuButton=null));const i=v.createElement("div",{className:`${this.player.options.classPrefix}-captions-menu ${this.player.options.classPrefix}-menu`,attributes:{role:"menu","aria-label":b.t("captions.select")}});if(!this.player.captionManager||0===this.player.captionManager.tracks.length){const t=v.createElement("div",{className:`${this.player.options.classPrefix}-menu-item`,textContent:b.t("player.noCaptions"),attributes:{role:"menuitem"},style:{opacity:"0.5",cursor:"default"}});return i.appendChild(t),this.insertMenuIntoDOM(i,e),void this.attachMenuCloseHandler(i,e)}let s=null;const a=v.createElement("button",{className:`${this.player.options.classPrefix}-menu-item`,textContent:b.t("captions.off"),attributes:{type:"button",role:"menuitem",tabindex:"-1"}});this.player.state.captionsEnabled||(a.classList.add(`${this.player.options.classPrefix}-menu-item-active`),a.appendChild(h("check")),s=a),a.addEventListener("click",()=>{this.player.disableCaptions(),this.updateCaptionsButton(),this.closeMenuAndReturnFocus(i,e)}),i.appendChild(a),this.player.captionManager.getAvailableTracks().forEach(t=>{const a=v.createElement("button",{className:`${this.player.options.classPrefix}-menu-item`,textContent:t.label,attributes:{type:"button",role:"menuitem",lang:t.language,tabindex:"-1"}});this.player.state.captionsEnabled&&this.player.captionManager.currentTrack===this.player.captionManager.tracks[t.index]&&(a.classList.add(`${this.player.options.classPrefix}-menu-item-active`),a.appendChild(h("check")),s=a),a.addEventListener("click",()=>{this.player.captionManager.switchTrack(t.index),this.updateCaptionsButton(),this.closeMenuAndReturnFocus(i,e)}),i.appendChild(a)}),this.insertMenuIntoDOM(i,e),this.attachMenuKeyboardNavigation(i,e),this.attachMenuCloseHandler(i,e),setTimeout(()=>{const e=s||i.querySelector(`.${this.player.options.classPrefix}-menu-item`);e&&e.focus({preventScroll:!0})},0)}updateCaptionsButton(){this.controls.captions&&(this.controls.captions.querySelector(".vidply-icon").innerHTML=this.player.state.captionsEnabled?h("captions").innerHTML:h("captionsOff").innerHTML)}createTranscriptButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-transcript`,attributes:{type:"button","aria-label":b.t("player.transcript"),"aria-expanded":"false"}});return e.appendChild(h("transcript")),e.addEventListener("click",async()=>{await this.player.toggleTranscript(),this.updateTranscriptButton()}),this.controls.transcript=e,e}updateTranscriptButton(){this.controls.transcript&&this.controls.transcript.setAttribute("aria-expanded",this.player.transcriptManager&&this.player.transcriptManager.isVisible?"true":"false")}createAudioDescriptionButton(){const e=b.t("player.audioDescription"),t=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-audio-description`,attributes:{type:"button","aria-label":e,role:"switch","aria-checked":"false"}});return t.appendChild(h("audioDescription")),v.attachTooltip(t,e,this.player.options.classPrefix),t.addEventListener("click",async()=>{await this.player.toggleAudioDescription(),this.updateAudioDescriptionButton()}),this.controls.audioDescription=t,t}updateAudioDescriptionButton(){if(!this.controls.audioDescription)return;const e=this.controls.audioDescription.querySelector(".vidply-icon"),t=this.player.state.audioDescriptionEnabled;e.innerHTML=t?h("audioDescriptionOn").innerHTML:h("audioDescription").innerHTML,this.controls.audioDescription.setAttribute("aria-checked",t?"true":"false")}createSignLanguageButton(){const e=b.t("player.signLanguage"),t=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-sign-language`,attributes:{type:"button","aria-label":e,"aria-expanded":"false"}});return t.appendChild(h("signLanguagePip")),v.attachTooltip(t,e,this.player.options.classPrefix),t.addEventListener("click",()=>{this.player.toggleSignLanguage(),this.updateSignLanguageButton()}),this.controls.signLanguage=t,t}updateSignLanguageButton(){if(!this.controls.signLanguage)return;const e=this.controls.signLanguage.querySelector(".vidply-icon"),t=this.player.state.signLanguageEnabled;e.innerHTML=t?h("signLanguagePipOn").innerHTML:h("signLanguagePip").innerHTML,this.controls.signLanguage.setAttribute("aria-expanded",t?"true":"false"),this.controls.signLanguage.setAttribute("aria-label",b.t(t?"signLanguage.hide":"signLanguage.show"))}createSignLanguageInMainViewButton(){const e=b.t("signLanguage.showInMainView"),t=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-sign-language-main-view`,attributes:{type:"button","aria-label":e,"aria-pressed":"false"}});return t.appendChild(h("signLanguage")),v.attachTooltip(t,e,this.player.options.classPrefix),t.addEventListener("click",()=>{this.player.signLanguageManager&&this.player.signLanguageManager.toggleInMainView()}),this.controls.signLanguageMainView=t,t}updateSignLanguageInMainViewButton(){const e=this.controls.signLanguageMainView;if(!e)return;const t=this.player.state.signLanguageInMainView,i=b.t(t?"signLanguage.hideInMainView":"signLanguage.showInMainView"),s=t?"signLanguageOn":"signLanguage";e.querySelector(".vidply-icon").innerHTML=h(s).innerHTML,e.setAttribute("aria-pressed",String(t)),e.setAttribute("aria-label",i);const a=e.querySelector(`.${this.player.options.classPrefix}-tooltip`);a&&(a.textContent=i)}updateAccessibilityButtons(){const e=this.hasAudioDescription(),t=this.hasSignLanguage();if(e){if(!this.controls.audioDescription&&!1!==this.player.options.audioDescriptionButton){const e=this.createAudioDescriptionButton();e.dataset.overflowPriority="2",e.dataset.overflowPriorityMobile="3";const t=this.rightButtons.querySelector(`.${this.player.options.classPrefix}-transcript`),i=this.rightButtons.querySelector(`.${this.player.options.classPrefix}-playlist-toggle`),s=t||i||null;s?this.rightButtons.insertBefore(e,s):this.rightButtons.appendChild(e),this.setupOverflowMenu()}this.controls.audioDescription&&(this.controls.audioDescription.style.display="")}else this.controls.audioDescription&&(this.controls.audioDescription.style.display="none");const i=t&&!1!==this.player.options.signLanguageButton,s=this.player.options.classPrefix,a=this.player.options.signLanguageDisplayMode||"both",n=["pip","both"].includes(a),r=["main","both"].includes(a);if(i){const e=this.rightButtons.querySelector(`.${s}-quality`),t=this.rightButtons.querySelector(`.${s}-fullscreen`),i=e||t||null;let a=!1;if(n&&!this.controls.signLanguage){const e=this.createSignLanguageButton();e.dataset.overflowPriority="3",e.dataset.overflowPriorityMobile="3",i?this.rightButtons.insertBefore(e,i):this.rightButtons.appendChild(e),a=!0}if(r&&!this.controls.signLanguageMainView){const e=this.createSignLanguageInMainViewButton();e.dataset.overflowPriority="3",e.dataset.overflowPriorityMobile="3";const t=this.controls.signLanguage?.nextSibling;t?this.rightButtons.insertBefore(e,t):i?this.rightButtons.insertBefore(e,i):this.rightButtons.appendChild(e),a=!0}a&&this.setupOverflowMenu(),this.controls.signLanguage&&(this.controls.signLanguage.style.display=n?"":"none"),this.controls.signLanguageMainView&&(this.controls.signLanguageMainView.style.display=r?"":"none")}else this.controls.signLanguage&&(this.controls.signLanguage.style.display="none"),this.controls.signLanguageMainView&&(this.controls.signLanguageMainView.style.display="none")}createSettingsButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-settings`,attributes:{type:"button","aria-label":b.t("player.settings")}});return e.appendChild(h("settings")),e.addEventListener("click",()=>{this.player.showSettings()}),e}createPipButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-pip`,attributes:{type:"button","aria-label":b.t("player.pip")}});return e.appendChild(h("pip")),e.addEventListener("click",()=>{this.player.togglePiP()}),e}createFullscreenButton(){const e=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-fullscreen`,attributes:{type:"button","aria-label":b.t("player.fullscreen")}});return e.appendChild(h("fullscreen")),e.addEventListener("click",()=>{this.player.toggleFullscreen()}),this.controls.fullscreen=e,e}attachEvents(){this.player.on("play",()=>this.updatePlayPauseButton()),this.player.on("pause",()=>this.updatePlayPauseButton()),this.player.on("timeupdate",()=>this.updateProgress()),this.player.on("loadedmetadata",()=>{this.updateDuration(),this.ensureQualityButton(),this.updateQualityIndicator(),this.updatePreviewVideoSource()}),this.player.on("sourcechange",()=>{this.updatePreviewVideoSource()}),this.player.on("volumechange",()=>this.updateVolumeDisplay()),this.player.on("progress",()=>this.updateBuffered()),this.player.on("playbackspeedchange",()=>this.updateSpeedDisplay()),this.player.on("fullscreenchange",()=>this.updateFullscreenButton()),this.player.on("captionsenabled",()=>this.updateCaptionsButton()),this.player.on("captionsdisabled",()=>this.updateCaptionsButton()),this.player.on("audiodescriptionenabled",()=>this.updateAudioDescriptionButton()),this.player.on("audiodescriptiondisabled",()=>this.updateAudioDescriptionButton()),this.player.on("signlanguageenabled",()=>this.updateSignLanguageButton()),this.player.on("signlanguagedisabled",()=>this.updateSignLanguageButton()),this.player.on("signlanguageinmainviewenabled",()=>this.updateSignLanguageInMainViewButton()),this.player.on("signlanguageinmainviewdisabled",()=>this.updateSignLanguageInMainViewButton()),this.player.on("qualitychange",()=>this.updateQualityIndicator()),this.player.on("hlslevelswitched",()=>this.updateQualityIndicator()),this.player.on("hlsmanifestparsed",()=>{this.ensureQualityButton(),this.updateQualityIndicator()})}updatePlayPauseButton(){if(!this.controls.playPause)return;const e=this.controls.playPause.querySelector(".vidply-icon"),t=this.player.state.playing;e.innerHTML=t?h("pause").innerHTML:h("play").innerHTML;const i=b.t(t?"player.pause":"player.play");this.controls.playPause.setAttribute("aria-label",i),v.attachTooltip(this.controls.playPause,i,this.player.options.classPrefix)}updateProgress(){if(!this.controls.played)return;const t=this.player.state.duration||0,i=t>0?Math.min(100,Math.max(0,(this.player.state.currentTime||0)/t*100)):0;this.controls.played.style.width=`${i}%`,this.controls.progress.setAttribute("aria-valuenow",String(Math.round(i)));const s=e.formatDuration(this.player.state.currentTime),a=e.formatDuration(this.player.state.duration);if(this.controls.progress.setAttribute("aria-valuetext",`${Math.round(i)}%, ${s} ${b.t("time.of")} ${a}`),this.controls.currentTimeVisual){const t=this.player.state.currentTime;this.controls.currentTimeVisual.textContent=e.formatTime(t),this.controls.currentTimeAccessible&&(this.controls.currentTimeAccessible.textContent=e.formatDuration(t))}}updateDuration(){if(this.controls.durationVisual){const t=this.player.state.duration;this.controls.durationVisual.textContent=e.formatTime(t),this.controls.durationAccessible&&(this.controls.durationAccessible.textContent=b.t("time.durationPrefix")+e.formatDuration(t))}}updateVolumeDisplay(){const e=100*this.player.state.volume;if(this.controls.volumeFill&&(this.controls.volumeFill.style.height=`${e}%`),this.controls.volumeSlider&&this.controls.volumeSlider.setAttribute("aria-valuenow",String(Math.round(e))),this.controls.mute){const e=this.controls.mute.querySelector(".vidply-icon");if(e){let t;t=this.player.state.muted||0===this.player.state.volume?"volumeMuted":this.player.state.volume<.3?"volumeLow":this.player.state.volume<.7?"volumeMedium":"volumeHigh",e.innerHTML=h(t).innerHTML;const i=b.t(this.player.state.muted?"player.unmute":"player.mute");this.controls.mute.setAttribute("aria-label",i),v.attachTooltip(this.controls.mute,i,this.player.options.classPrefix)}}this.controls.volumeSlider&&this.controls.volumeSlider.setAttribute("aria-valuenow",String(Math.round(e)))}updateBuffered(){if(!this.controls.buffered||!this.player.element.buffered||0===this.player.element.buffered.length)return;const e=this.player.element.buffered.end(this.player.element.buffered.length-1);this.controls.buffered.style.width=e/this.player.state.duration*100+"%"}updateSpeedDisplay(){this.controls.speedText&&(this.controls.speedText.textContent=`${this.player.state.playbackSpeed}x`)}updateFullscreenButton(){if(!this.controls.fullscreen)return;const e=this.controls.fullscreen.querySelector(".vidply-icon"),t=this.player.state.fullscreen;e.innerHTML=t?h("fullscreenExit").innerHTML:h("fullscreen").innerHTML,this.controls.fullscreen.setAttribute("aria-label",b.t(t?"player.exitFullscreen":"player.fullscreen"))}ensureQualityButton(){if(!this.player.options.qualityButton)return;if(this.controls.quality)return;if(!this.hasQualityLevels())return;const e=this.createQualityButton(),t=this.rightButtons.querySelector(`.${this.player.options.classPrefix}-speed`),i=this.rightButtons.querySelector(`.${this.player.options.classPrefix}-caption-style`)||t;this.rightButtons.insertBefore(e,i||this.rightButtons.firstChild),this.player.log("Quality button added dynamically","info")}ensureCaptionsButton(){if(!this.player.options.captionsButton)return;if(this.controls.captions)return;const e=this.createCaptionsButton();e.dataset.overflowPriority="1",e.dataset.overflowPriorityMobile="3";const t=this.rightButtons.querySelector(`.${this.player.options.classPrefix}-chapters`);t&&t.nextSibling?this.rightButtons.insertBefore(e,t.nextSibling):t?t.after(e):this.rightButtons.insertBefore(e,this.rightButtons.firstChild),this.player.log("Captions button added dynamically for HLS subtitles","info")}ensureCaptionStyleButton(){if(!this.player.options.captionStyleButton)return;if(this.controls.captionStyle)return;const e=this.createCaptionStyleButton();e.dataset.overflowPriority="3",e.dataset.overflowPriorityMobile="3";const t=this.rightButtons.querySelector(`.${this.player.options.classPrefix}-captions-button`);t?t.after(e):this.rightButtons.insertBefore(e,this.rightButtons.firstChild),this.player.log("Caption style button added dynamically for HLS subtitles","info")}ensureTranscriptButton(){if(!this.player.options.transcriptButton)return;if(this.controls.transcript)return;const e=this.createTranscriptButton();e.dataset.overflowPriority="3",e.dataset.overflowPriorityMobile="3";const t=this.rightButtons.querySelector(`.${this.player.options.classPrefix}-audio-description`),i=this.rightButtons.querySelector(`.${this.player.options.classPrefix}-speed`),s=this.rightButtons.querySelector(`.${this.player.options.classPrefix}-caption-style`);if(t)t.after(e);else if(i)i.after(e);else if(s)s.after(e);else{const t=this.rightButtons.querySelector(`.${this.player.options.classPrefix}-quality`),i=this.rightButtons.querySelector(`.${this.player.options.classPrefix}-pip`),s=this.rightButtons.querySelector(`.${this.player.options.classPrefix}-fullscreen`),a=t||i||s;a?this.rightButtons.insertBefore(e,a):this.rightButtons.appendChild(e)}this.player.log("Transcript button added dynamically for HLS subtitles","info")}removeHlsCaptionButtons(e=!1){!e&&this.player.element.querySelectorAll('track[kind="captions"], track[kind="subtitles"]').length>0?this.player.log("Keeping caption buttons - native track elements exist","info"):(this.disableAllCaptions(),this.controls.captions&&(this.controls.captions.remove(),this.controls.captions=null,this.player.log("Captions button removed - no subtitle tracks","info")),this.controls.captionStyle&&(this.controls.captionStyle.remove(),this.controls.captionStyle=null,this.player.log("Caption style button removed - no subtitle tracks","info")),this.controls.transcript&&(this.controls.transcript.remove(),this.controls.transcript=null,this.player.log("Transcript button removed - no subtitle tracks","info")))}disableAllCaptions(){const e=this.player.element.textTracks;for(let t=0;t<e.length;t++)e[t].mode="disabled";this.player.captionsManager&&this.player.captionsManager.hide();const t=this.player.container?.querySelector(`.${this.player.options.classPrefix}-captions`);t&&(t.textContent="",t.style.display="none"),this.player.state.captionsEnabled=!1,this.player.log("All captions disabled and cleared","info")}updateQualityIndicator(){if(!this.controls.qualityText)return;if(!this.player.renderer||!this.player.renderer.getQualities)return;const e=this.player.renderer.getQualities();if(0===e.length)return void(this.controls.qualityText.textContent="");let t="";if(this.player.renderer.hls&&-1===this.player.renderer.hls.currentLevel)t="Auto";else if(this.player.renderer.getCurrentQuality){const i=this.player.renderer.getCurrentQuality(),s=e.find(e=>e.index===i);s&&(t=s.height?`${s.height}p`:"")}this.controls.qualityText.textContent=t}setupAutoHide(){if("VIDEO"!==this.player.element.tagName)return;const e=()=>{this.element.classList.add(`${this.player.options.classPrefix}-controls-visible`),this.player.container.classList.add(`${this.player.options.classPrefix}-controls-visible`),this.player.state.controlsVisible=!0,clearTimeout(this.hideTimeout),this.player.state.playing&&(this.hideTimeout=setTimeout(()=>{this.element.classList.remove(`${this.player.options.classPrefix}-controls-visible`),this.player.container.classList.remove(`${this.player.options.classPrefix}-controls-visible`),this.player.state.controlsVisible=!1},this.player.state.fullscreen?1.5*this.player.options.hideControlsDelay:this.player.options.hideControlsDelay))};this.player.container.addEventListener("mousemove",e),this.player.container.addEventListener("touchstart",e),this.player.container.addEventListener("touchmove",e),this.player.container.addEventListener("click",e),this.player.container.addEventListener("tap",e),this.element.addEventListener("focusin",e),this.player.on("pause",()=>{e(),clearTimeout(this.hideTimeout)}),this.player.on("play",()=>{e()}),this.player.on("enterfullscreen",()=>{e(),this.player.state.fullscreen&&(clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(()=>{this.player.state.playing&&(this.element.classList.remove(`${this.player.options.classPrefix}-controls-visible`),this.player.container.classList.remove(`${this.player.options.classPrefix}-controls-visible`),this.player.state.controlsVisible=!1)},2*this.player.options.hideControlsDelay))}),e()}createOverflowMenuButton(){const e=b.t("player.moreOptions"),t=v.createElement("button",{className:`${this.player.options.classPrefix}-button ${this.player.options.classPrefix}-overflow-menu`,attributes:{type:"button","aria-label":e,"aria-expanded":"false"}});return t.appendChild(h("moreVertical")),v.attachTooltip(t,e,this.player.options.classPrefix),t.addEventListener("click",()=>{this.showOverflowMenu(t)}),this.controls.overflowMenu=t,t}showOverflowMenu(e){const t=document.querySelector(`.${this.player.options.classPrefix}-overflow-menu-list`);if(t)return t.remove(),e.setAttribute("aria-expanded","false"),void(this.openMenu===t&&(this.openMenu=null,this.openMenuButton=null));const i=v.createElement("div",{className:`${this.player.options.classPrefix}-overflow-menu-list ${this.player.options.classPrefix}-menu`,attributes:{role:"menu","aria-label":b.t("player.moreOptions")}}),s=Array.from(this.rightButtons.querySelectorAll('button[data-in-overflow="true"]'));if(0===s.length){const e=v.createElement("div",{className:`${this.player.options.classPrefix}-menu-item`,textContent:b.t("player.noMoreOptions"),attributes:{role:"menuitem"},style:{opacity:"0.5",cursor:"default"}});i.appendChild(e)}else s.forEach(t=>{const s=v.createElement("button",{className:`${this.player.options.classPrefix}-menu-item`,attributes:{type:"button",role:"menuitem",tabindex:"-1"}}),a=t.getAttribute("aria-label")||t.getAttribute("title")||"",n=t.querySelector(".vidply-icon");if(n){const e=n.cloneNode(!0);s.appendChild(e)}else{const e=t.querySelector("span");if(e&&e.textContent&&e.textContent.length<=3){const t=e.cloneNode(!0);t.classList.add("vidply-icon"),s.appendChild(t)}}const r=v.createElement("span",{textContent:a});s.appendChild(r),s.addEventListener("click",a=>{this._overflowMenuItemRef=s;const n=t.style.display;t.style.display="",t.style.visibility="hidden",t.click(),setTimeout(()=>{t.style.display=n,t.style.visibility="",this._overflowMenuItemRef=null},100),this.closeMenuAndReturnFocus(i,e)}),i.appendChild(s)}),this.attachMenuKeyboardNavigation(i,e),setTimeout(()=>{const e=i.querySelector(`.${this.player.options.classPrefix}-menu-item`);e&&"BUTTON"===e.tagName&&e.focus({preventScroll:!0})},0);i.style.visibility="hidden",i.style.display="block",this.insertMenuIntoDOM(i,e),this.positionMenu(i,e,!0),requestAnimationFrame(()=>{i.style.visibility="visible"}),this.attachMenuCloseHandler(i,e)}setupOverflowDetection(){const e=()=>{const e=window.innerWidth>=768,t=window.innerHeight<window.innerWidth,i=this.player.state.fullscreen,s=t&&i;if(!this.rightButtons||0===this.rightButtons.children.length)return void(this.overflowMenuButton&&(this.overflowMenuButton.style.display="none"));const a=Array.from(this.rightButtons.children).filter(e=>!e.classList.contains(`${this.player.options.classPrefix}-overflow-menu`));if(0===a.length)return void(this.overflowMenuButton&&(this.overflowMenuButton.style.display="none"));const n=!e&&!t;if(this.player.options.debug&&console.log("Overflow detection:",{isDesktop:e,isFullscreen:i,isLandscape:t,isLandscapeFullscreen:s,shouldUseOverflow:n,width:window.innerWidth,height:window.innerHeight}),!n)return a.forEach(e=>{e.dataset.inOverflow="false",e.style.display=""}),this.overflowMenuButton&&(this.overflowMenuButton.style.display="none"),void(this.player.options.debug&&console.log("No overflow menu needed - all buttons visible, overflow button hidden"));this.player.options.debug&&console.log("Mobile portrait - checking for overflow..."),a.forEach(e=>{e.style.display=""});const r=this.rightButtons.offsetWidth,o=r-50;let l=0;const c=a.map(e=>{const t=getComputedStyle(e),i=e.offsetWidth+parseInt(t.marginLeft||0)+parseInt(t.marginRight||0);return l+=i,{btn:e,width:i}});l+=8*(a.length-1);const h=window.innerWidth<768,u=l>o||h||s&&!e;if(this.player.options.debug&&console.log("Overflow detection:",{containerWidth:r,availableWidth:o,totalWidth:l,needsOverflow:u,isSmallScreen:h,reason:h?"mobile screen":l>o?"not enough space":"enough space",buttonCount:a.length}),u){const e=window.innerWidth<768,t=e?"overflowPriorityMobile":"overflowPriority";this.player.options.debug&&console.log(`Using ${e?"mobile":"desktop"} priorities (width: ${window.innerWidth}px)`);const i=c.sort((e,i)=>{const s=parseInt(e.btn.dataset[t]||e.btn.dataset.overflowPriority||"1");return parseInt(i.btn.dataset[t]||i.btn.dataset.overflowPriority||"1")-s});let s=l,a=0;for(const{btn:n,width:r}of i){const i=parseInt(n.dataset[t]||n.dataset.overflowPriority||"1"),l=n.getAttribute("aria-label")||"unknown";1!==i?(e?i>1:s>o)?(n.dataset.inOverflow="true",n.style.display="none",s-=r,a++,this.player.options.debug&&console.log(`  â†’ Hiding button: ${l} (priority ${i}, ${e?"mobile":"desktop"})`)):(n.dataset.inOverflow="false",n.style.display=""):(n.dataset.inOverflow="false",n.style.display="")}if(this.player.options.debug&&console.log("Overflow button exists?",!!this.overflowMenuButton),!this.overflowMenuButton)return void console.error("Overflow menu button not found!");a>0?(this.overflowMenuButton.style.display="",this.player.options.debug&&console.log("Showing overflow menu button -",a,"buttons moved")):(this.overflowMenuButton.style.display="none",this.player.options.debug&&console.log("Hiding overflow menu button - all buttons fit"))}else a.forEach(e=>{e.dataset.inOverflow="false",e.style.display=""}),this.overflowMenuButton.style.display="none"},t=new ResizeObserver(()=>{requestAnimationFrame(e)});t.observe(this.rightButtons),window.addEventListener("resize",()=>{requestAnimationFrame(e)}),this.player.on("fullscreenchange",()=>{setTimeout(()=>{requestAnimationFrame(e)},50)}),requestAnimationFrame(()=>{e(),setTimeout(()=>e(),100),setTimeout(()=>e(),300),setTimeout(()=>e(),500)}),document.fonts&&document.fonts.ready&&document.fonts.ready.then(()=>{requestAnimationFrame(e)}),this.overflowResizeObserver=t}show(){this.element.style.display=""}hide(){this.element.style.display="none"}updatePreviewVideoSource(){const e=this.player.renderer;if(!e||!e.media||"VIDEO"!==e.media.tagName)return;if(this.previewSupported||this.previewVideo||this.initPreviewThumbnail(),!this.previewSupported||!this.previewVideo)return;const t=e.media,i=t.src||t.querySelector("source")?.src;i&&this.previewVideo.src!==i?(this.previewThumbnailCache.clear(),this.previewVideoReady=!1,this.previewVideo.src=i,t.crossOrigin&&(this.previewVideo.crossOrigin=t.crossOrigin),this.previewVideo.addEventListener("loadedmetadata",()=>{this.previewVideoReady=!0},{once:!0})):i&&!this.previewVideoReady&&this.previewVideo.readyState>=1&&(this.previewVideoReady=!0)}cleanupPreviewThumbnail(){this.previewThumbnailTimeout&&(clearTimeout(this.previewThumbnailTimeout),this.previewThumbnailTimeout=null),this.previewVideo&&this.previewVideo.parentNode&&(this.previewVideo.parentNode.removeChild(this.previewVideo),this.previewVideo=null),this.previewThumbnailCache.clear()}destroy(){this.hideTimeout&&clearTimeout(this.hideTimeout),this.overflowResizeObserver&&this.overflowResizeObserver.disconnect(),this.cleanupPreviewThumbnail(),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element)}},M=class{constructor(e){this.player=e,this.shortcuts=e.options.keyboardShortcuts,this.init()}init(){this.attachEvents()}attachEvents(){this.player.container.addEventListener("keydown",e=>{this.handleKeydown(e)},!0),this.player.container.hasAttribute("tabindex")||this.player.container.setAttribute("tabindex","0")}handleKeydown(e){if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||"SELECT"===e.target.tagName)return;const t=document.activeElement;if(t){if(t.closest('.vidply-menu, [role="menu"]'))return;if(t.closest(".vidply-playlist-item-button"))return;if(t.closest(".vidply-sign-language-wrapper")){const e=this.player.signLanguageManager?.draggable;if(e?.keyboardDragMode||e?.keyboardResizeMode)return}if(t.closest(".vidply-transcript-window")){const e=this.player.transcriptManager?.draggableResizable;if(e?.keyboardDragMode||e?.keyboardResizeMode)return}}const i=e.key;let s=!1;if("Escape"===i&&this.player.state.fullscreen)return this.player.exitFullscreen(),e.preventDefault(),void e.stopPropagation();for(const[t,a]of Object.entries(this.shortcuts))if(a.includes(i)&&(s=this.executeAction(t,e),s)){e.preventDefault(),e.stopPropagation(),this.announceAction(t);break}!s&&this.player.options.debug&&console.log("[VidPly] Unhandled key:",e.key,"code:",e.code,"shiftKey:",e.shiftKey)}executeAction(e,t){switch(e){case"play-pause":return this.player.toggle(),!0;case"volume-up":return this.player.setVolume(Math.min(1,this.player.state.volume+.1)),!0;case"volume-down":return this.player.setVolume(Math.max(0,this.player.state.volume-.1)),!0;case"seek-forward":return this.player.seekForward(),!0;case"seek-backward":return this.player.seekBackward(),!0;case"mute":return this.player.toggleMute(),!0;case"fullscreen":return this.player.toggleFullscreen(),!0;case"captions":if(this.player.captionManager&&this.player.captionManager.tracks.length>1){const e=this.player.controlBar&&this.player.controlBar.controls.captions;e?this.player.controlBar.showCaptionsMenu(e):this.player.toggleCaptions()}else this.player.toggleCaptions();return!0;case"caption-style-menu":return!(!this.player.controlBar||!this.player.controlBar.controls.captionStyle||(this.player.controlBar.showCaptionStyleMenu(this.player.controlBar.controls.captionStyle),0));case"speed-up":return this.player.setPlaybackSpeed(Math.min(2,this.player.state.playbackSpeed+.25)),!0;case"speed-down":return this.player.setPlaybackSpeed(Math.max(.25,this.player.state.playbackSpeed-.25)),!0;case"speed-menu":return!(!this.player.controlBar||!this.player.controlBar.controls.speed||(this.player.controlBar.showSpeedMenu(this.player.controlBar.controls.speed),0));case"quality-menu":return!(!this.player.controlBar||!this.player.controlBar.controls.quality||(this.player.controlBar.showQualityMenu(this.player.controlBar.controls.quality),0));case"chapters-menu":return!(!this.player.controlBar||!this.player.controlBar.controls.chapters||(this.player.controlBar.showChaptersMenu(this.player.controlBar.controls.chapters),0));case"transcript-toggle":return!!this.player.transcriptManager&&(this.player.transcriptManager.toggleTranscript(),!0);default:return!1}}announceAction(e){if(!this.player.options.screenReaderAnnouncements)return;let t="";switch(e){case"play-pause":t=this.player.state.playing?"Playing":"Paused";break;case"volume-up":case"volume-down":t=`Volume ${Math.round(100*this.player.state.volume)}%`;break;case"mute":t=this.player.state.muted?"Muted":"Unmuted";break;case"fullscreen":t=this.player.state.fullscreen?"Fullscreen":"Exit fullscreen";break;case"captions":t=this.player.state.captionsEnabled?"Captions on":"Captions off";break;case"speed-up":case"speed-down":t=`Speed ${this.player.state.playbackSpeed}x`}t&&this.announce(t)}announce(e,t="polite"){let i=document.getElementById("vidply-announcer");i||(i=document.createElement("div"),i.id="vidply-announcer",i.className="vidply-sr-only",i.setAttribute("aria-live",t),i.setAttribute("aria-atomic","true"),i.style.cssText="\n        position: absolute;\n        left: -10000px;\n        width: 1px;\n        height: 1px;\n        overflow: hidden;\n      ",document.body.appendChild(i)),i.textContent="",setTimeout(()=>{i.textContent=e},100)}updateShortcut(e,t){Array.isArray(t)&&(this.shortcuts[e]=t)}destroy(){}},S=null,P=null,E=0,x=class e extends L{constructor(e,t={}){if(super(),this.element="string"==typeof e?document.querySelector(e):e,!this.element)throw new Error("VidPly: Element not found");if(E++,this.instanceId=E,"VIDEO"!==this.element.tagName&&"AUDIO"!==this.element.tagName){const e=document.createElement(t.mediaType||"video");Array.from(this.element.attributes).forEach(t=>{"id"===t.name||"class"===t.name||t.name.startsWith("data-")||e.setAttribute(t.name,t.value)}),this.element.querySelectorAll("track").forEach(t=>{e.appendChild(t.cloneNode(!0))}),this.element.innerHTML="",this.element.appendChild(e),this.element=e}this._originalElement=this.element,this.options={width:null,height:null,poster:null,responsive:!0,fillContainer:!1,autoplay:!1,loop:!1,muted:!1,volume:.8,playbackSpeed:1,preload:"metadata",initialDuration:0,deferLoad:!1,requirePlaybackForAccessibilityToggles:!1,startTime:0,playsInline:!0,controls:!0,hideControlsDelay:3e3,playPauseButton:!0,progressBar:!0,currentTime:!0,duration:!0,volumeControl:!0,muteButton:!0,chaptersButton:!0,qualityButton:!0,captionStyleButton:!0,speedButton:!0,hideSpeedForHls:!1,hideSpeedForHlsVideo:!1,captionsButton:!0,transcriptButton:!0,fullscreenButton:!0,pipButton:!1,seekInterval:10,seekIntervalLarge:30,captions:!0,captionsDefault:!1,captionsFontSize:"100%",captionsFontFamily:"sans-serif",captionsColor:"#FFFFFF",captionsBackgroundColor:"#000000",captionsOpacity:.8,audioDescription:!0,audioDescriptionSrc:null,audioDescriptionButton:!0,signLanguage:!0,signLanguageSrc:null,signLanguageButton:!0,signLanguagePosition:"bottom-right",signLanguageDisplayMode:"both",transcript:!1,transcriptPosition:"external",transcriptContainer:null,keyboard:!0,keyboardShortcuts:{"play-pause":[" ","p","k"],"volume-up":["ArrowUp"],"volume-down":["ArrowDown"],"seek-forward":["ArrowRight"],"seek-backward":["ArrowLeft"],mute:["m"],fullscreen:["f"],captions:["c"],"caption-style-menu":["a"],"speed-up":[">"],"speed-down":["<"],"speed-menu":["s"],"quality-menu":["q"],"chapters-menu":["j"],"transcript-toggle":["t"]},ariaLabels:{},screenReaderAnnouncements:!0,highContrast:!1,focusHighlight:!0,metadataAlerts:{},metadataHashtags:{},language:"en",languages:["en"],resumePlayback:!0,resumeThreshold:10,resumePrompt:!0,thumbnailPreview:!0,thumbnailCacheSize:50,thumbnailPregenerate:!0,thumbnailInterval:10,thumbnailWidth:160,thumbnailHeight:90,thumbnailQuality:.8,lazyInit:!0,lazyMargin:"200px",theme:"dark",themeVariables:{},debug:!1,classPrefix:"vidply",iconType:"svg",pauseOthersOnPlay:!0,onReady:null,onPlay:null,onPause:null,onEnded:null,onTimeUpdate:null,onVolumeChange:null,onError:null,...t},this.options.metadataAlerts=this.options.metadataAlerts||{},this.options.metadataHashtags=this.options.metadataHashtags||{},this.noticeElement=null,this.noticeTimeout=null,this.storage=new o("vidply");const i=this.storage.getPlayerPreferences();i&&(void 0!==i.volume&&(this.options.volume=i.volume),void 0!==i.playbackSpeed&&(this.options.playbackSpeed=i.playbackSpeed),void 0!==i.muted&&(this.options.muted=i.muted)),this.state={ready:!1,playing:!1,paused:!0,ended:!1,buffering:!1,seeking:!1,hasStartedPlayback:!1,muted:this.options.muted,volume:this.options.volume,currentTime:0,duration:Number(this.options.initialDuration)>0?Number(this.options.initialDuration):0,playbackSpeed:this.options.playbackSpeed,fullscreen:!1,pip:!1,captionsEnabled:this.options.captionsDefault,currentCaption:null,controlsVisible:!0,audioDescriptionEnabled:!1,signLanguageEnabled:!1,signLanguageInMainView:!1,resumePromptVisible:!1},this.resumePromptElement=null,this._saveProgressThrottled=null,this._resumeChecked=!1,this.originalSrc=null,this.audioDescriptionSrc=this.options.audioDescriptionSrc,this.signLanguageSrc=this.options.signLanguageSrc,this.signLanguageSources=this.options.signLanguageSources||{},this.currentSignLanguage=null,this.signLanguageVideo=null,this.audioDescriptionSourceElement=null,this.originalAudioDescriptionSource=null,this.audioDescriptionCaptionTracks=[],this._audioDescriptionDesiredState=!1,this._textTracksCache=null,this._textTracksDirty=!0,this._sourceElementsCache=null,this._sourceElementsDirty=!0,this._trackElementsCache=null,this._trackElementsDirty=!0,this.timeouts=new Set,this.container=null,this.renderer=null,this.controlBar=null,this.captionManager=null,this.keyboardManager=null,this.settingsDialog=null,this.metadataCueChangeHandler=null,this.metadataAlertHandlers=new Map,this.audioDescriptionManager=null,this.signLanguageManager=null,this._managersLoading=null,Object.defineProperties(this,{signLanguageWrapper:{get:()=>this.signLanguageManager?.wrapper,set:e=>{this.signLanguageManager&&(this.signLanguageManager.wrapper=e)}},signLanguageVideo:{get:()=>this.signLanguageManager?.video,set:e=>{this.signLanguageManager&&(this.signLanguageManager.video=e)}},signLanguageHeader:{get:()=>this.signLanguageManager?.header,set:e=>{this.signLanguageManager&&(this.signLanguageManager.header=e)}},signLanguageSettingsButton:{get:()=>this.signLanguageManager?.settingsButton,set:e=>{this.signLanguageManager&&(this.signLanguageManager.settingsButton=e)}},signLanguageSettingsMenu:{get:()=>this.signLanguageManager?.settingsMenu,set:e=>{this.signLanguageManager&&(this.signLanguageManager.settingsMenu=e)}},signLanguageSettingsMenuVisible:{get:()=>this.signLanguageManager?.settingsMenuVisible,set:e=>{this.signLanguageManager&&(this.signLanguageManager.settingsMenuVisible=e)}},signLanguageDraggable:{get:()=>this.signLanguageManager?.draggable,set:e=>{this.signLanguageManager&&(this.signLanguageManager.draggable=e)}},currentSignLanguage:{get:()=>this.signLanguageManager?.currentLanguage,set:e=>{this.signLanguageManager&&(this.signLanguageManager.currentLanguage=e)}}}),this.init()}showNotice(e,{timeout:t=2500,priority:i="polite"}={}){try{if(!e)return;if(!this.container)return;if(this.keyboardManager?.announce&&this.keyboardManager.announce(e,i),!this.noticeElement){const e=document.createElement("div");e.className=`${this.options.classPrefix}-notice`,e.setAttribute("role","status"),e.setAttribute("aria-live",i),e.setAttribute("aria-atomic","true"),e.style.position="absolute",e.style.left="0.75rem",e.style.right="0.75rem",e.style.top="0.75rem",e.style.zIndex="9999",e.style.padding="0.5rem 0.75rem",e.style.borderRadius="0.5rem",e.style.background="rgba(0, 0, 0, 0.75)",e.style.color="#fff",e.style.fontSize="0.875rem",e.style.lineHeight="1.3",e.style.pointerEvents="none",this.noticeElement=e,this.container.appendChild(e)}this.noticeElement.textContent=e,this.noticeElement.style.display="block",this.noticeTimeout&&(clearTimeout(this.noticeTimeout),this.noticeTimeout=null),this.noticeTimeout=setTimeout(()=>{this.noticeElement&&(this.noticeElement.style.display="none")},t)}catch(e){}}async init(){try{if(this.log("Initializing VidPly player"),this.options.languageFiles)try{await b.loadLanguagesFromUrls(this.options.languageFiles)}catch(e){console.warn("Failed to load some language files:",e)}if(this.options.languageFile&&this.options.languageFileUrl)try{await b.loadLanguageFromUrl(this.options.languageFile,this.options.languageFileUrl),this.log(`Custom language file loaded for ${this.options.languageFile}`)}catch(e){console.warn(`Failed to load language file for ${this.options.languageFile}:`,e)}if(!this.options.language||"en"===this.options.language){const e=this.detectHtmlLanguage();e&&(this.options.language=e,this.log(`Auto-detected language from HTML: ${e}`))}this.options.language||(this.options.language="en"),await b.ensureLanguage(this.options.language),b.setLanguage(this.options.language),this.createContainer(),this.element.src||this.element.querySelector("source")?.src?await this.initializeRenderer():this.log("No initial source - waiting for playlist or manual load"),await this.initFeatureManagers(),this.options.controls&&(this.controlBar=new w(this),this.videoWrapper.appendChild(this.controlBar.element)),this.options.captions&&(this.captionManager=new i(this)),this.options.transcript&&await this.ensureTranscriptManager(),this.setupMetadataHandling(),this.options.keyboard&&(this.keyboardManager=new M(this)),this.setupResponsiveHandlers(),this.options.startTime>0&&this.seek(this.options.startTime),requestAnimationFrame(()=>{this.options.muted?this.mute():this.renderer&&this.renderer.media&&this.renderer.setMuted(!1),.8!==this.options.volume?this.setVolume(this.options.volume):this.renderer&&this.renderer.media&&this.renderer.setVolume(this.options.volume)}),this.options.resumePlayback&&this.initResumePlayback(),this.state.ready=!0,this._originalElement.classList.add("vidply-initialized"),this.emit("ready"),this.options.onReady&&this.options.onReady.call(this),this.options.autoplay&&this.play(),this.log("Player initialized successfully")}catch(e){this.handleError(e)}}async ensureTranscriptManager(){if(this.transcriptManager)return this.transcriptManager;if(!this.options.transcript&&!this.options.transcriptButton)return null;const e=await import("./vidply.TranscriptManager-457ACZUN.min.js"),t=e.TranscriptManager||e.default;return t?(this.transcriptManager=new t(this),this.transcriptManager):null}async toggleTranscript(){const e=await this.ensureTranscriptManager();e&&(e.toggleTranscript(),this.controlBar&&this.controlBar.updateTranscriptButton())}async ensureAudioDescriptionManager(){if(this.audioDescriptionManager)return this.audioDescriptionManager;if(!this.options.audioDescriptionSrc&&!this.audioDescriptionSrc&&!this.options.audioDescriptionButton)return null;const e=await(async()=>{if(!S){const e=await import("./vidply.AudioDescriptionManager-S2B3YPBT.min.js");S=e.AudioDescriptionManager}return S})();return this.audioDescriptionManager=new e(this),this.audioDescriptionManager}async ensureSignLanguageManager(){if(this.signLanguageManager)return this.signLanguageManager;const e=this.options.signLanguageSrc||this.signLanguageSrc,t=this.options.signLanguageSources&&Object.keys(this.options.signLanguageSources).length>0;if(!e&&!t&&!this.options.signLanguageButton)return null;const i=await(async()=>{if(!P){const e=await import("./vidply.SignLanguageManager-6M4S4KNR.min.js");P=e.SignLanguageManager}return P})();return this.signLanguageManager=new i(this),this.signLanguageManager}async initFeatureManagers(){const e=[],t=this.sourceElements.some(e=>e.getAttribute("data-desc-src")||e.getAttribute("data-orig-src"));(this.options.audioDescriptionButton||this.options.audioDescriptionSrc||this.audioDescriptionSrc||t)&&e.push(this.ensureAudioDescriptionManager()),(this.options.signLanguageButton||this.options.signLanguageSrc||this.signLanguageSrc||this.options.signLanguageSources&&Object.keys(this.options.signLanguageSources).length>0)&&e.push(this.ensureSignLanguageManager()),e.length>0&&await Promise.all(e)}detectHtmlLanguage(){const e=document.documentElement.lang||document.documentElement.getAttribute("lang");if(!e)return null;const t=e.toLowerCase().split("-")[0];return b.translations[t]||b.builtInLanguageLoaders&&b.builtInLanguageLoaders[t]?t:(this.log(`Language "${e}" not available, using English as fallback`),null)}initResumePlayback(){this._saveProgressThrottled=r(()=>this.saveProgress(),5e3),this.on("timeupdate",()=>{this.state.playing&&this.state.duration>0&&this._saveProgressThrottled()}),this.on("loadedmetadata",()=>{this._resumeChecked||(this._resumeChecked=!0,this.checkForResume())}),this.on("ended",()=>{const e=this.getVideoId();e&&this.storage.clearWatchProgress(e)})}getVideoId(){const e=this.element.getAttribute("data-video-id")||this.element.dataset.videoId||this._originalElement?.getAttribute("data-video-id")||this._originalElement?.dataset?.videoId;if(e)return e;let t=this.element.src;if(!t){const e=this.element.querySelector("source");t=e?.src}return t?this._hashString(t):null}_hashString(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t&=t;return"v_"+Math.abs(t).toString(36)}saveProgress(){if(!this.options.resumePlayback)return;const e=this.getVideoId();if(!e)return;const t=this.state.currentTime,i=this.state.duration;i<30||t<this.options.resumeThreshold||t/i*100>95||this.storage.saveWatchProgress(e,t,i)}checkForResume(){if(!this.options.resumePlayback)return;const e=this.getVideoId();if(!e)return;const t=this.storage.getWatchProgress(e);if(!t)return;const{currentTime:i,duration:s,percentage:a}=t;i<this.options.resumeThreshold||a>95||this.state.duration>0&&Math.abs(this.state.duration-s)>5?this.storage.clearWatchProgress(e):this.options.resumePrompt?this.showResumePrompt(i):this.seek(i)}_formatResumeTime(e){const t=Math.floor(e/3600),i=Math.floor(e%3600/60),s=Math.floor(e%60);return t>0?`${t}:${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`:`${i}:${s.toString().padStart(2,"0")}`}showResumePrompt(e){if(this.state.resumePromptVisible||!this.container)return;const t=this._formatResumeTime(e),i=b.t("resume.prompt",{time:t});this.resumePromptElement=v.createElement("div",{className:`${this.options.classPrefix}-resume-prompt`,attributes:{role:"dialog","aria-label":i,"aria-modal":"true"}});const s=v.createElement("div",{className:`${this.options.classPrefix}-resume-prompt-content`}),a=v.createElement("p",{className:`${this.options.classPrefix}-resume-prompt-message`,textContent:i}),n=v.createElement("div",{className:`${this.options.classPrefix}-resume-prompt-buttons`}),r=v.createElement("button",{className:`${this.options.classPrefix}-resume-prompt-button ${this.options.classPrefix}-resume-prompt-button-primary`,textContent:b.t("resume.resume"),attributes:{type:"button"}});r.addEventListener("click",()=>{this.hideResumePrompt(),this.seek(e),this.play()});const o=v.createElement("button",{className:`${this.options.classPrefix}-resume-prompt-button`,textContent:b.t("resume.startOver"),attributes:{type:"button"}});o.addEventListener("click",()=>{this.hideResumePrompt();const e=this.getVideoId();e&&this.storage.clearWatchProgress(e),this.seek(0),this.play()}),this.resumePromptElement.addEventListener("keydown",e=>{"Escape"===e.key&&(e.preventDefault(),e.stopPropagation(),this.hideResumePrompt())}),n.appendChild(r),n.appendChild(o),s.appendChild(a),s.appendChild(n),this.resumePromptElement.appendChild(s),this.container.appendChild(this.resumePromptElement),this.state.resumePromptVisible=!0,requestAnimationFrame(()=>{r.focus()}),this.emit("resumepromptshow",{savedTime:e})}hideResumePrompt(){this.resumePromptElement&&(this.resumePromptElement.remove(),this.resumePromptElement=null,this.state.resumePromptVisible=!1,this.emit("resumeprompthide"))}static THEMES=["dark","light","minimal","high-contrast"];applyTheme(){if(!this.container)return;const t=e.THEMES.map(e=>`${this.options.classPrefix}-theme-${e}`);this.container.classList.remove(...t);const i=this.options.theme;i&&e.THEMES.includes(i)&&this.container.classList.add(`${this.options.classPrefix}-theme-${i}`),this.options.themeVariables&&"object"==typeof this.options.themeVariables&&Object.entries(this.options.themeVariables).forEach(([e,t])=>{const i=e.startsWith("--vidply-")?e:`--vidply-${e}`;this.container.style.setProperty(i,t)})}setTheme(e,t={}){const i=this.options.theme;this.options.theme=e,t&&Object.keys(t).length>0&&(this.options.themeVariables={...this.options.themeVariables,...t}),this.applyTheme(),this.emit("themechange",{theme:e,previousTheme:i,customVariables:this.options.themeVariables})}getTheme(){return this.options.theme}setThemeVariable(e,t){if(!this.container)return;const i=e.startsWith("--vidply-")?e:`--vidply-${e}`;this.container.style.setProperty(i,t),this.options.themeVariables=this.options.themeVariables||{},this.options.themeVariables[e]=t}resetTheme(){this.container&&this.options.themeVariables&&Object.keys(this.options.themeVariables).forEach(e=>{const t=e.startsWith("--vidply-")?e:`--vidply-${e}`;this.container.style.removeProperty(t)}),this.options.theme="dark",this.options.themeVariables={},this.applyTheme(),this.emit("themechange",{theme:"dark",previousTheme:this.options.theme})}createContainer(){const t=this.instanceId>1?`${b.t("player.label")} ${this.instanceId}`:b.t("player.label");this.container=v.createElement("div",{className:`${this.options.classPrefix}-player`,attributes:{role:"application","aria-label":t,tabindex:"0"}});const i=this.element.tagName.toLowerCase();if(this.container.classList.add(`${this.options.classPrefix}-${i}`),this.options.responsive&&this.container.classList.add(`${this.options.classPrefix}-responsive`),this.videoWrapper=v.createElement("div",{className:`${this.options.classPrefix}-video-wrapper`}),this.element.parentNode.insertBefore(this.container,this.element),"AUDIO"===this.element.tagName&&this.options.poster&&(this.trackArtworkElement=v.createElement("div",{className:`${this.options.classPrefix}-track-artwork`,attributes:{"aria-hidden":"true"}}),this.trackArtworkElement.style.backgroundImage=`url(${this.options.poster})`,this.container.appendChild(this.trackArtworkElement)),this.container.appendChild(this.videoWrapper),this.videoWrapper.appendChild(this.element),this.element.controls=!1,this.element.removeAttribute("controls"),this.element.setAttribute("tabindex","-1"),this.element.style.width="100%",this.element.style.height="100%","VIDEO"===this.element.tagName&&this.options.playsInline&&(this.element.setAttribute("playsinline",""),this.element.playsInline=!0),this.options.width&&(this.container.style.width="number"==typeof this.options.width?`${this.options.width}px`:this.options.width),this.options.height&&(this.container.style.height="number"==typeof this.options.height?`${this.options.height}px`:this.options.height),this.options.poster&&"VIDEO"===this.element.tagName){const e=this.resolvePosterPath(this.options.poster);this.element.poster=e}"VIDEO"===this.element.tagName&&this.createPlayButtonOverlay(),this.element.vidply=this,e.instances.push(this),this.element.style.cursor="pointer",this.element.addEventListener("click",e=>{e.target===this.element&&this.toggle()}),this.on("play",()=>{this.state.hasStartedPlayback=!0,this.hidePosterOverlay()}),this.on("timeupdate",()=>{this.state.currentTime>0&&this.hidePosterOverlay()}),this.element.addEventListener("loadeddata",()=>{(this.state.playing||this.state.currentTime>0)&&this.hidePosterOverlay()},{once:!0}),this.applyTheme()}createPlayButtonOverlay(){this.playButtonOverlay=d(),this.playButtonOverlay.addEventListener("click",()=>{this.toggle()}),this.videoWrapper.appendChild(this.playButtonOverlay),this.on("play",()=>{this.playButtonOverlay.style.opacity="0",this.playButtonOverlay.style.pointerEvents="none"}),this.on("pause",()=>{this.playButtonOverlay.style.opacity="1",this.playButtonOverlay.style.pointerEvents="auto",this.positionPlayOverlayOnMobile()}),this.on("ended",()=>{this.playButtonOverlay.style.opacity="1",this.playButtonOverlay.style.pointerEvents="auto",this.positionPlayOverlayOnMobile()}),this.debouncedPositionPlayOverlay=s(()=>{this.positionPlayOverlayOnMobile()},150),window.addEventListener("resize",this.debouncedPositionPlayOverlay),this.on("loadedmetadata",()=>{this.positionPlayOverlayOnMobile()}),this.on("enterfullscreen",()=>{n(()=>this.positionPlayOverlayOnMobile(),100)}),this.on("exitfullscreen",()=>{n(()=>this.positionPlayOverlayOnMobile(),100)})}positionPlayOverlayOnMobile(){if(!this.playButtonOverlay||"VIDEO"!==this.element.tagName)return;if(!a())return void(this.playButtonOverlay.style.top="");const e=this.element.getBoundingClientRect(),t=this.videoWrapper.getBoundingClientRect();this.playButtonOverlay.style.top=e.top-t.top+e.height/2+"px"}async initializeRenderer(){let e=this._pendingSource||this.element.src||this.element.querySelector("source")?.src;if(!e)throw new Error("No media source found");this.currentSource=e,this._pendingSource=null,this.audioDescriptionManager?.initFromSourceElements(this.sourceElements,this.trackElements),this.originalSrc||(this.originalSrc=e);let i=t;if(e.includes("youtube.com")||e.includes("youtu.be")){const e=await import("./vidply.YouTubeRenderer-CTEREOSQ.min.js");i=e.YouTubeRenderer||e.default}else if(e.includes("vimeo.com")){const e=await import("./vidply.VimeoRenderer-PVOJ6FAM.min.js");i=e.VimeoRenderer||e.default}else if(e.includes(".m3u8")){const e=await import("./vidply.HLSRenderer-TBGNB3HF.min.js");i=e.HLSRenderer||e.default}else if(e.includes("soundcloud.com")||e.includes("api.soundcloud.com")){const e=await import("./vidply.SoundCloudRenderer-S7DCYVO3.min.js");i=e.SoundCloudRenderer||e.default}this.log(`Using ${i?.name||"HTML5Renderer"} renderer`),this.renderer=new i(this),await this.renderer.init(),this.invalidateTrackCache()}get textTracks(){return this._textTracksCache&&!this._textTracksDirty||(this._textTracksCache=Array.from(this.element.textTracks||[]),this._textTracksDirty=!1),this._textTracksCache}get sourceElements(){return this._sourceElementsCache&&!this._sourceElementsDirty||(this._sourceElementsCache=Array.from(this.element.querySelectorAll("source")),this._sourceElementsDirty=!1),this._sourceElementsCache}get trackElements(){return this._trackElementsCache&&!this._trackElementsDirty||(this._trackElementsCache=Array.from(this.element.querySelectorAll("track")),this._trackElementsDirty=!1),this._trackElementsCache}invalidateTrackCache(){this._textTracksDirty=!0,this._trackElementsDirty=!0,this._sourceElementsDirty=!0}findTextTrack(e,t=null){return this.textTracks.find(t?i=>i.kind===e&&i.language===t:t=>t.kind===e)}findSourceElement(e,t=null){return this.sourceElements.find(t?i=>i.getAttribute(e)===t:t=>t.hasAttribute(e))}findTrackElement(e){return this.trackElements.find(t=>t.track===e)}resolvePosterPath(e){if(!e)return e;if(e.match(/^(https?:|\/)/))return e;try{return new URL(e,window.location.href).href}catch(t){return e}}async generatePosterFromVideo(e=10){if("VIDEO"!==this.element.tagName)return null;const t=this.renderer;if(!t||!t.media||"VIDEO"!==t.media.tagName)return null;const i=t.media;(!i.duration||i.duration<e)&&(e=Math.min(e,Math.max(1,.1*i.duration)));let s=i;this.controlBar&&this.controlBar.previewVideo&&this.controlBar.previewSupported&&(s=this.controlBar.previewVideo);const a=s===i;return await k(s,e,{restoreState:a,quality:.9})}async autoGeneratePoster(){if(this.element.getAttribute("poster")||this.element.poster||this.options.poster)return;if("VIDEO"!==this.element.tagName)return;this.state.duration&&0!==this.state.duration||await new Promise(e=>{const t=()=>{this.element.removeEventListener("loadedmetadata",t),e()};this.element.readyState>=1?e():this.element.addEventListener("loadedmetadata",t)});const e=await this.generatePosterFromVideo(10);e&&(this.element.poster=e,this.log("Auto-generated poster from video frame at 10 seconds","info"),this.showPosterOverlay())}showPosterOverlay(){if(!this.videoWrapper||"VIDEO"!==this.element.tagName)return;const e=this.element.getAttribute("poster")||this.element.poster||this.options.poster;if(!e)return;const t=e.startsWith("data:")?e:this.resolvePosterPath(e);this.videoWrapper.style.setProperty("--vidply-poster-image",`url("${t}")`),this.videoWrapper.classList.add("vidply-forced-poster"),this._isAudioContent&&this.container?this.container.classList.add("vidply-audio-content"):this.container&&this.container.classList.remove("vidply-audio-content")}hidePosterOverlay(){this.videoWrapper&&(this.videoWrapper.classList.remove("vidply-forced-poster"),this.videoWrapper.style.removeProperty("--vidply-poster-image"))}setManagedTimeout(e,t){const i=setTimeout(()=>{this.timeouts.delete(i),e()},t);return this.timeouts.add(i),i}clearManagedTimeout(e){e&&(clearTimeout(e),this.timeouts.delete(e))}isExternalRendererUrl(e){return!!e&&(e.includes("youtube.com")||e.includes("youtu.be")||e.includes("vimeo.com")||e.includes("soundcloud.com")||e.includes("api.soundcloud.com")||e.includes(".m3u8"))}async load(e){try{this.log("Loading new media:",e.src),this.renderer&&this.pause();const t=window.scrollX||window.pageXOffset,s=window.scrollY||window.pageYOffset;this.trackElements.forEach(e=>e.remove()),this.invalidateTrackCache();const a=this.isExternalRendererUrl(e.src);if(a&&(this._switchingRenderer=!0),a?(this.element.removeAttribute("src"),this.element.querySelectorAll("source").forEach(e=>e.removeAttribute("src"))):(this.element.src=e.src,e.type&&(this.element.type=e.type)),this._pendingSource=e.src,this._isAudioContent=e.type&&e.type.startsWith("audio/"),this.container&&(this._isAudioContent?this.container.classList.add("vidply-audio-content"):this.container.classList.remove("vidply-audio-content")),e.poster&&"VIDEO"===this.element.tagName)if(this._isAudioContent){if(this.element.removeAttribute("poster"),this.videoWrapper){const t=this.resolvePosterPath(e.poster);this.videoWrapper.style.setProperty("--vidply-poster-image",`url("${t}")`),this.videoWrapper.classList.add("vidply-forced-poster")}}else this.element.poster=this.resolvePosterPath(e.poster),this.videoWrapper&&(this.videoWrapper.classList.remove("vidply-forced-poster"),this.videoWrapper.style.removeProperty("--vidply-poster-image"));e.tracks&&e.tracks.length>0&&(e.tracks.forEach(e=>{const t=document.createElement("track");t.src=e.src,t.kind=e.kind||"captions",t.srclang=e.srclang||"en",t.label=e.label||e.srclang,e.default&&(t.default=!0),e.describedSrc&&t.setAttribute("data-desc-src",e.describedSrc);const i=this.element.firstChild;i&&i.nodeType===Node.ELEMENT_NODE&&"TRACK"!==i.tagName?this.element.insertBefore(t,i):this.element.appendChild(t)}),this.invalidateTrackCache());const n=this.state.signLanguageEnabled,r=this.state.audioDescriptionEnabled;this.audioDescriptionSrc=e.audioDescriptionSrc||null,this.signLanguageSrc=e.signLanguageSrc||null,this.originalSrc=e.src,this.audioDescriptionManager&&(this.audioDescriptionManager.updateSources(e.audioDescriptionSrc),this.audioDescriptionManager.reinitialize()),this.signLanguageManager&&this.signLanguageManager.updateSources(e.signLanguageSrc,e.signLanguageSources),r&&this.disableAudioDescription(),n&&this.disableSignLanguage();const o=this.shouldChangeRenderer(e.src);if(o&&this.renderer&&(this.renderer.destroy(),this.renderer=null),!this.renderer||o)await this.initializeRenderer();else if(this.renderer.media=this.element,this.options.deferLoad){try{this.element.preload=this.options.preload||"metadata"}catch(e){}this.renderer&&("boolean"==typeof this.renderer._didDeferredLoad&&(this.renderer._didDeferredLoad=!1),"boolean"==typeof this.renderer._hlsSourceLoaded&&(this.renderer._hlsSourceLoaded=!1),"_pendingSrc"in this.renderer&&(this.renderer._pendingSrc=this._pendingSource||this.currentSource||null))}else this.element.load();if(a?setTimeout(()=>{this._switchingRenderer=!1},500):this._switchingRenderer=!1,window.scrollTo(t,s),this.captionManager&&(this.captionManager.destroy(),this.captionManager=new i(this)),this.transcriptManager){const e=this.transcriptManager.isVisible;this.transcriptManager.destroy(),this.transcriptManager=null,await this.ensureTranscriptManager(),e&&this.controlBar&&this.controlBar.hasCaptionTracks()&&this.transcriptManager?.showTranscript()}this.controlBar&&this.updateControlBar(),window.scrollTo(t,s),n&&this.signLanguageSrc&&setTimeout(()=>{this.enableSignLanguage(),window.scrollTo(t,s)},150),r&&this.audioDescriptionSrc&&setTimeout(()=>{this.enableAudioDescription(),window.scrollTo(t,s)},150),this.emit("sourcechange",e),this.log("Media loaded successfully")}catch(e){this.handleError(e)}}ensureLoaded(){try{if(!this.renderer)return;"function"==typeof this.renderer.ensureLoaded&&this.renderer.ensureLoaded()}catch(e){}}updateControlBar(){if(!this.controlBar)return;const e=this.controlBar;e.element.innerHTML="",e.createControls(),e.attachEvents(),e.setupAutoHide(),e.setupOverflowDetection()}shouldChangeRenderer(e){if(!this.renderer)return!0;const t=e.includes("youtube.com")||e.includes("youtu.be"),i=e.includes("vimeo.com"),s=e.includes(".m3u8"),a=e.includes("soundcloud.com")||e.includes("api.soundcloud.com"),n=this.renderer.constructor.name;return!((!t||"YouTubeRenderer"===n)&&(!i||"VimeoRenderer"===n)&&(!s||"HLSRenderer"===n)&&(!a||"SoundCloudRenderer"===n)&&(t||i||s||a||"HTML5Renderer"===n))}play(){this.renderer?this.renderer.play():this.playlistManager&&Array.isArray(this.playlistManager.tracks)&&this.playlistManager.tracks.length>0&&this.playlistManager.play(this.playlistManager.currentIndex>=0?this.playlistManager.currentIndex:0,!0)}pause(){this.renderer&&this.renderer.pause()}stop(){this.pause(),this.seek(0)}toggle(){this.state.playing?this.pause():this.play()}seek(e){this.renderer&&this.renderer.seek(e)}seekForward(e=this.options.seekInterval){this.seek(Math.min(this.state.currentTime+e,this.state.duration))}seekBackward(e=this.options.seekInterval){this.seek(Math.max(this.state.currentTime-e,0))}setVolume(e){const t=Math.max(0,Math.min(1,e));this.renderer&&this.renderer.setVolume(t),this.state.volume=t,t>0&&this.state.muted&&(this.state.muted=!1,this.renderer&&this.renderer.setMuted(!1),this.emit("volumechange")),this.savePlayerPreferences()}getVolume(){return this.state.volume}mute(){this.renderer&&this.renderer.setMuted(!0),this.state.muted=!0,this.savePlayerPreferences(),this.emit("volumechange")}unmute(){this.renderer&&this.renderer.setMuted(!1),this.state.muted=!1,this.savePlayerPreferences(),this.emit("volumechange")}toggleMute(){this.state.muted?this.unmute():this.mute()}setPlaybackSpeed(e){const t=Math.max(.25,Math.min(2,e));this.renderer&&this.renderer.setPlaybackSpeed(t),this.state.playbackSpeed=t,this.savePlayerPreferences(),this.emit("playbackspeedchange",t)}getPlaybackSpeed(){return this.state.playbackSpeed}savePlayerPreferences(){this.storage.savePlayerPreferences({volume:this.state.volume,muted:this.state.muted,playbackSpeed:this.state.playbackSpeed})}enterFullscreen(){const e=this.container;let t=null;/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1?this._enablePseudoFullscreen():(e.requestFullscreen?t=e.requestFullscreen():e.webkitRequestFullscreen?t=e.webkitRequestFullscreen():e.mozRequestFullScreen?t=e.mozRequestFullScreen():e.msRequestFullscreen&&(t=e.msRequestFullscreen()),t&&t.catch&&t.catch(e=>{this.log("Fullscreen API failed, using pseudo-fullscreen:",e.message),this._enablePseudoFullscreen()}),e.requestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen?(this.state.fullscreen=!0,this.container.classList.add(`${this.options.classPrefix}-fullscreen`),this.emit("fullscreenchange",!0)):this._enablePseudoFullscreen())}exitFullscreen(){document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen():this._disablePseudoFullscreen(),this.state.fullscreen=!1,this.container.classList.remove(`${this.options.classPrefix}-fullscreen`),this.emit("fullscreenchange",!1)}toggleFullscreen(){this.state.fullscreen?this.exitFullscreen():this.enterFullscreen()}_enablePseudoFullscreen(){this.state.fullscreen=!0,this.container.classList.add(`${this.options.classPrefix}-fullscreen`),document.body.classList.add("vidply-fullscreen-active"),this._originalScrollX=window.scrollX||window.pageXOffset,this._originalScrollY=window.scrollY||window.pageYOffset,this._originalBodyOverflow=document.body.style.overflow,this._originalBodyPosition=document.body.style.position,this._originalBodyWidth=document.body.style.width,this._originalBodyHeight=document.body.style.height,this._originalHtmlOverflow=document.documentElement.style.overflow,this._originalBodyBackground=document.body.style.background,this._originalHtmlBackground=document.documentElement.style.background,document.body.style.overflow="hidden",document.body.style.width="100%",document.body.style.height="100%",document.body.style.background="#000",document.documentElement.style.overflow="hidden",document.documentElement.style.background="#000",this._originalViewport=document.querySelector('meta[name="viewport"]')?.getAttribute("content");const e=document.querySelector('meta[name="viewport"]');e&&e.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"),window.scrollTo(0,0),this._makeBackgroundInert(),this.emit("fullscreenchange",!0),this.emit("enterfullscreen")}_makeBackgroundInert(){this._inertElements=[];let e=this.container;for(;e&&e!==document.body&&e!==document.documentElement;){const t=e.parentElement;t&&Array.from(t.children).forEach(t=>{t===e||t.nodeType!==Node.ELEMENT_NODE||t.hasAttribute("inert")||"SCRIPT"===t.tagName||"STYLE"===t.tagName||"LINK"===t.tagName||"META"===t.tagName||(t.setAttribute("inert",""),this._inertElements.push(t))}),e=t}}_restoreBackgroundInteractivity(){this._inertElements&&(this._inertElements.forEach(e=>{e.removeAttribute("inert")}),this._inertElements=[])}_disablePseudoFullscreen(){if(document.body.classList.remove("vidply-fullscreen-active"),this._restoreBackgroundInteractivity(),void 0!==this._originalBodyOverflow&&(document.body.style.overflow=this._originalBodyOverflow,delete this._originalBodyOverflow),void 0!==this._originalBodyPosition&&(document.body.style.position=this._originalBodyPosition,delete this._originalBodyPosition),void 0!==this._originalBodyWidth&&(document.body.style.width=this._originalBodyWidth,delete this._originalBodyWidth),void 0!==this._originalBodyHeight&&(document.body.style.height=this._originalBodyHeight,delete this._originalBodyHeight),void 0!==this._originalHtmlOverflow&&(document.documentElement.style.overflow=this._originalHtmlOverflow,delete this._originalHtmlOverflow),void 0!==this._originalBodyBackground&&(document.body.style.background=this._originalBodyBackground,delete this._originalBodyBackground),void 0!==this._originalHtmlBackground&&(document.documentElement.style.background=this._originalHtmlBackground,delete this._originalHtmlBackground),void 0!==this._originalViewport){const e=document.querySelector('meta[name="viewport"]');e&&e.setAttribute("content",this._originalViewport),delete this._originalViewport}void 0!==this._originalScrollX&&void 0!==this._originalScrollY&&(window.scrollTo(this._originalScrollX,this._originalScrollY),delete this._originalScrollX,delete this._originalScrollY),this.emit("exitfullscreen")}enterPiP(){this.element.requestPictureInPicture&&(this.element.requestPictureInPicture(),this.state.pip=!0,this.emit("pipchange",!0))}exitPiP(){document.pictureInPictureElement&&(document.exitPictureInPicture(),this.state.pip=!1,this.emit("pipchange",!1))}togglePiP(){this.state.pip?this.exitPiP():this.enterPiP()}enableCaptions(){this.captionManager&&(this.captionManager.enable(),this.state.captionsEnabled=!0)}disableCaptions(){this.captionManager&&(this.captionManager.disable(),this.state.captionsEnabled=!1)}toggleCaptions(){this.state.captionsEnabled?this.disableCaptions():this.enableCaptions()}async validateTrackExists(e){try{return(await fetch(e,{method:"HEAD",cache:"no-cache"})).ok}catch(e){return!1}}stripVTTFormatting(e){return e?e.replace(/<[^>]+>/g,"").replace(/\n/g," ").trim().toLowerCase():""}findMatchingCaptionTime(e,t){if(!e||!t||0===t.length)return null;const i=this.stripVTTFormatting(e);for(const e of t){if("captions"!==e.kind&&"subtitles"!==e.kind)continue;const t=e.track;if(t&&t.cues)for(let e=0;e<t.cues.length;e++){const s=t.cues[e],a=this.stripVTTFormatting(s.text);if(a===i)return s.startTime;const n=i.split(/\s+/).filter(e=>e.length>2),r=a.split(/\s+/).filter(e=>e.length>2);if(n.length>0&&r.length>0&&n.filter(e=>r.includes(e)).length/n.length>=.8)return s.startTime}}return null}async enableAudioDescription(){const e=await this.ensureAudioDescriptionManager();return e?.enable()}async _legacyEnableAudioDescription(){const e=this.sourceElements.some(e=>e.getAttribute("data-desc-src"));if(!(this.audioDescriptionSrc||e||this.audioDescriptionCaptionTracks.length>0))return void console.warn("VidPly: No audio description source, source elements, or tracks provided");const t=this.element.currentTime,i=this.state.playing,s=!i&&0===t;let a=null;if(this.captionManager&&this.captionManager.currentTrack){const e=this.captionManager.currentTrack.track;e&&e.activeCues&&e.activeCues.length>0&&(a=this.stripVTTFormatting(e.activeCues[0].text))}const n=this.resolvePosterPath(this.element.getAttribute("poster")||this.element.poster||this.options.poster);s&&this.showPosterOverlay();let r=[];if(this.audioDescriptionSourceElement){const e=this.element.currentSrc||this.element.src,o=this.sourceElements;let l=null,c=this.audioDescriptionSrc;for(const t of o){const i=t.getAttribute("src"),s=t.getAttribute("data-desc-src"),a=i?i.split("/").pop():"",n=e?e.split("/").pop():"";if(e&&(e===i||e.includes(i)||e.includes(a)||a&&n===a)){l=t,s?c=s:i&&(c=this.audioDescriptionSrc||c);break}}if(!l){l=this.audioDescriptionSourceElement;const e=l.getAttribute("data-desc-src");e&&(c=e)}if(this.audioDescriptionCaptionTracks.length>0){const e=this.audioDescriptionCaptionTracks.map(async e=>{if(e.trackElement&&e.describedSrc){if(!0!==e.explicit)return{trackInfo:e,exists:!1};try{return{trackInfo:e,exists:await this.validateTrackExists(e.describedSrc)}}catch(t){return{trackInfo:e,exists:!1}}}return{trackInfo:e,exists:!1}}),t=(await Promise.all(e)).filter(e=>e.exists);if(t.length>0){const e=new Map;t.forEach(({trackInfo:t})=>{const i=t.trackElement.track;e.set(t,i?{wasShowing:"showing"===i.mode,wasHidden:"hidden"===i.mode}:{wasShowing:!1,wasHidden:!1})});const i=t.map(({trackInfo:e})=>{const t=e.trackElement.getAttribute("src"),i=e.trackElement.parentNode,s=e.trackElement.nextSibling,a={};return Array.from(e.trackElement.attributes).forEach(e=>{a[e.name]=e.value}),{trackInfo:e,oldSrc:t,parent:i,nextSibling:s,attributes:a}});i.forEach(({trackInfo:e})=>{e.trackElement.remove()}),this.element.load(),await new Promise(t=>{setTimeout(()=>{i.forEach(({trackInfo:e,parent:t,nextSibling:i,attributes:s})=>{r.push(e);const a=document.createElement("track");a.setAttribute("src",e.describedSrc),Object.keys(s).forEach(e=>{"src"!==e&&"data-desc-src"!==e&&a.setAttribute(e,s[e])}),i&&i.parentNode?t.insertBefore(a,i):t.appendChild(a),e.trackElement=a}),this.invalidateTrackCache();const s=()=>{this.setManagedTimeout(()=>{r.forEach(t=>{const i=t.trackElement.track;if(i){const s=e.get(t)||{wasShowing:!1,wasHidden:!1};i.mode="hidden";const a=()=>{i.mode=s.wasShowing||s.wasHidden?"hidden":"disabled"};i.readyState>=2?a():(i.addEventListener("load",a,{once:!0}),i.addEventListener("error",a,{once:!0}))}})},300)};this.element.readyState>=1?setTimeout(s,200):(this.element.addEventListener("loadedmetadata",s,{once:!0}),setTimeout(s,2e3)),t()},100)})}}const h=this.sourceElements,u=[];h.forEach(e=>{const t=e.getAttribute("data-desc-src"),i=e.getAttribute("src");if(t){const s=e.getAttribute("type");let a=e.getAttribute("data-orig-src");a||(a=i),u.push({src:t,type:s,origSrc:a,descSrc:t})}else{const t=e.getAttribute("type"),i=e.getAttribute("src");u.push({src:i,type:t,origSrc:null,descSrc:null})}});const p=this.element.hasAttribute("src");p&&this.element.getAttribute("src"),p&&this.element.removeAttribute("src"),h.forEach(e=>{e.remove()}),u.forEach(e=>{const t=document.createElement("source");t.setAttribute("src",e.src),e.type&&t.setAttribute("type",e.type),e.origSrc&&t.setAttribute("data-orig-src",e.origSrc),e.descSrc&&t.setAttribute("data-desc-src",e.descSrc);const i=this.element.querySelector("track");i?this.element.insertBefore(t,i):this.element.appendChild(t)}),this._sourceElementsDirty=!0,this._sourceElementsCache=null,n&&"VIDEO"===this.element.tagName&&(this.element.poster=n),this.element.load(),await new Promise(e=>{const t=()=>{this.element.removeEventListener("loadedmetadata",t),e()};this.element.readyState>=1?e():this.element.addEventListener("loadedmetadata",t)}),await new Promise(e=>setTimeout(e,300)),(t>0||i)&&await new Promise(e=>{const t=()=>{this.element.removeEventListener("canplay",t),this.element.removeEventListener("canplaythrough",t),e()};this.element.readyState>=3?e():(this.element.addEventListener("canplay",t,{once:!0}),this.element.addEventListener("canplaythrough",t,{once:!0}),setTimeout(()=>{this.element.removeEventListener("canplay",t),this.element.removeEventListener("canplaythrough",t),e()},3e3))});let d=t;if(a&&this.captionManager&&this.captionManager.tracks.length>0){await new Promise(e=>setTimeout(e,500));const e=this.findMatchingCaptionTime(a,this.captionManager.tracks);null!==e&&(d=e,this.options.debug&&console.log(`[VidPly] Syncing via caption: ${t}s -> ${d}s`))}if(d>0&&(this.seek(d),await new Promise(e=>setTimeout(e,100))),i?(await this.play(),this.setManagedTimeout(()=>{this.hidePosterOverlay()},100)):(this.pause(),s||this.hidePosterOverlay()),!this._audioDescriptionDesiredState)return;this.state.audioDescriptionEnabled=!0,this.emit("audiodescriptionenabled")}else{if(this.audioDescriptionCaptionTracks.length>0){const e=this.audioDescriptionCaptionTracks.map(async e=>{if(e.trackElement&&e.describedSrc){if(!0!==e.explicit)return{trackInfo:e,exists:!1};try{return{trackInfo:e,exists:await this.validateTrackExists(e.describedSrc)}}catch(t){return{trackInfo:e,exists:!1}}}return{trackInfo:e,exists:!1}}),t=(await Promise.all(e)).filter(e=>e.exists);if(t.length>0){const e=new Map;t.forEach(({trackInfo:t})=>{const i=t.trackElement.track;e.set(t,i?{wasShowing:"showing"===i.mode,wasHidden:"hidden"===i.mode}:{wasShowing:!1,wasHidden:!1})});const i=t.map(({trackInfo:e})=>{const t=e.trackElement.getAttribute("src"),i=e.trackElement.parentNode,s=e.trackElement.nextSibling,a={};return Array.from(e.trackElement.attributes).forEach(e=>{a[e.name]=e.value}),{trackInfo:e,oldSrc:t,parent:i,nextSibling:s,attributes:a}});i.forEach(({trackInfo:e})=>{e.trackElement.remove()}),this.element.load(),setTimeout(()=>{i.forEach(({trackInfo:e,parent:t,nextSibling:i,attributes:s})=>{r.push(e);const a=document.createElement("track");a.setAttribute("src",e.describedSrc),Object.keys(s).forEach(e=>{"src"!==e&&"data-desc-src"!==e&&a.setAttribute(e,s[e])});const n=t.firstChild;n&&n.nodeType===Node.ELEMENT_NODE&&"TRACK"!==n.tagName?t.insertBefore(a,n):i&&i.parentNode?t.insertBefore(a,i):t.appendChild(a),e.trackElement=a}),this.element.load();const t=()=>{setTimeout(()=>{r.forEach(t=>{const i=t.trackElement.track;if(i){const s=e.get(t)||{wasShowing:!1,wasHidden:!1};i.mode="hidden";const a=()=>{i.mode=s.wasShowing||s.wasHidden?"hidden":"disabled"};i.readyState>=2?a():(i.addEventListener("load",a,{once:!0}),i.addEventListener("error",a,{once:!0}))}})},300)};this.element.readyState>=1?setTimeout(t,200):(this.element.addEventListener("loadedmetadata",t,{once:!0}),setTimeout(t,2e3))},100)}}const e=this.sourceElements;if(e.some(e=>e.getAttribute("data-desc-src"))){const t=[];e.forEach(e=>{const i=e.getAttribute("data-desc-src"),s=e.getAttribute("src");if(i){const a=e.getAttribute("type");let n=e.getAttribute("data-orig-src");n||(n=s),t.push({src:i,type:a,origSrc:n,descSrc:i})}else{const i=e.getAttribute("type"),s=e.getAttribute("src");t.push({src:s,type:i,origSrc:null,descSrc:null})}}),e.forEach(e=>{e.remove()}),t.forEach(e=>{const t=document.createElement("source");t.setAttribute("src",e.src),e.type&&t.setAttribute("type",e.type),e.origSrc&&t.setAttribute("data-orig-src",e.origSrc),e.descSrc&&t.setAttribute("data-desc-src",e.descSrc),this.element.appendChild(t)}),n&&"VIDEO"===this.element.tagName&&(this.element.poster=n),this.element.load(),this.invalidateTrackCache()}else this.audioDescriptionSrc&&(n&&"VIDEO"===this.element.tagName&&(this.element.poster=n),this.element.src=this.audioDescriptionSrc)}await new Promise(e=>{const t=()=>{this.element.removeEventListener("loadedmetadata",t),e()};this.element.readyState>=1?e():this.element.addEventListener("loadedmetadata",t)}),(t>0||i)&&await new Promise(e=>{const t=()=>{this.element.removeEventListener("canplay",t),this.element.removeEventListener("canplaythrough",t),e()};this.element.readyState>=3?e():(this.element.addEventListener("canplay",t,{once:!0}),this.element.addEventListener("canplaythrough",t,{once:!0}),setTimeout(()=>{this.element.removeEventListener("canplay",t),this.element.removeEventListener("canplaythrough",t),e()},3e3))}),"VIDEO"!==this.element.tagName||0!==t||i||this.element.readyState>=1&&(this.element.currentTime=.001,this.setManagedTimeout(()=>{this.element.currentTime=0},10));let o=t;if(a&&this.captionManager&&this.captionManager.tracks.length>0){await new Promise(e=>setTimeout(e,500));const e=this.findMatchingCaptionTime(a,this.captionManager.tracks);null!==e&&(o=e,this.options.debug&&console.log(`[VidPly] Syncing via caption: ${t}s -> ${o}s`))}if(o>0&&(this.seek(o),await new Promise(e=>setTimeout(e,100))),i?(await this.play(),this.setManagedTimeout(()=>{this.hidePosterOverlay()},100)):(this.pause(),s||this.hidePosterOverlay()),r.length>0&&this.captionManager){const e=this.state.captionsEnabled;let t=null;if(this.captionManager.currentTrack){const e=this.captionManager.tracks.findIndex(e=>e.track===this.captionManager.currentTrack.track);e>=0&&(t={language:this.captionManager.tracks[e].language,kind:this.captionManager.tracks[e].kind})}const i=()=>{if(this.captionManager.tracks=[],this.captionManager.loadTracks(),e&&t&&this.captionManager.tracks.length>0){const e=this.captionManager.tracks.findIndex(e=>e.language===t.language&&e.kind===t.kind);if(e>=0){const t=this.captionManager.tracks[e];if(t.track.readyState>=2)this.captionManager.enable(e);else{const i=()=>{t.track.removeEventListener("load",i),t.track.removeEventListener("error",i),this.captionManager&&this.captionManager.tracks.includes(t)&&this.captionManager.enable(e)};t.track.addEventListener("load",i,{once:!0}),t.track.addEventListener("error",i,{once:!0}),t.track.mode="hidden",setTimeout(()=>{this.captionManager&&this.captionManager.tracks.includes(t)&&this.captionManager.enable(e)},1e3)}}else if(this.captionManager.tracks.length>0){const e=this.captionManager.tracks[0];if(e.track.readyState>=2)this.captionManager.enable(0);else{const t=()=>{e.track.removeEventListener("load",t),e.track.removeEventListener("error",t),this.captionManager&&this.captionManager.tracks.includes(e)&&this.captionManager.enable(0)};e.track.addEventListener("load",t,{once:!0}),e.track.addEventListener("error",t,{once:!0}),e.track.mode="hidden",setTimeout(()=>{this.captionManager&&this.captionManager.tracks.includes(e)&&this.captionManager.enable(0)},1e3)}}}};setTimeout(i,600)}if(this.transcriptManager&&this.transcriptManager.isVisible){const e=void 0!==r?r:[];if(e.length>0){const t=()=>{this.invalidateTrackCache();const t=this.textTracks,i=e.map(e=>{const i=e.trackElement,s=i.getAttribute("src"),a=i.getAttribute("srclang"),n=i.getAttribute("kind");let r=t.find(e=>i.track===e);if(r||(r=t.find(e=>{if(e.language===a&&(e.kind===n||"captions"===n&&"subtitles"===e.kind)){const t=this.findTrackElement(e);if(t&&t.getAttribute("src")===s)return!0}return!1})),r){const e=this.findTrackElement(r);if(e&&e.getAttribute("src")!==s)return null}return r}).filter(Boolean);if(0===i.length)return void this.setManagedTimeout(()=>{this.transcriptManager&&this.transcriptManager.loadTranscriptData&&this.transcriptManager.loadTranscriptData()},1e3);i.forEach(e=>{"disabled"===e.mode&&(e.mode="hidden")});let s=0;const a=()=>{s++,s>=i.length&&this.setManagedTimeout(()=>{if(this.transcriptManager&&this.transcriptManager.loadTranscriptData){this.invalidateTrackCache();const t=e.map(e=>e.describedSrc);(i.some(e=>{const i=this.findTrackElement(e);return i&&t.includes(i.getAttribute("src"))})||i.length>0)&&this.transcriptManager.loadTranscriptData()}},800)};i.forEach(t=>{"disabled"===t.mode&&(t.mode="hidden");const i=this.findTrackElement(t),s=i?i.getAttribute("src"):null,n=e.find(e=>{const i=e.trackElement;return i&&(i.track===t||i.getAttribute("srclang")===t.language&&i.getAttribute("kind")===t.kind)}),r=n?n.describedSrc:null;if(r&&s&&s!==r)a();else if(t.readyState>=2&&t.cues&&t.cues.length>0)a();else{"disabled"===t.mode&&(t.mode="hidden");const e=()=>{this.setManagedTimeout(a,300)};t.readyState>=2?this.setManagedTimeout(()=>{t.cues&&t.cues.length>0?a():t.addEventListener("load",e,{once:!0})},100):(t.addEventListener("load",e,{once:!0}),t.addEventListener("error",()=>{a()},{once:!0}))}})};(()=>{this.setManagedTimeout(()=>{this.element.readyState>=1?t():(this.element.addEventListener("loadedmetadata",t,{once:!0}),this.setManagedTimeout(t,2e3))},500)})(),setTimeout(()=>{this.transcriptManager&&this.transcriptManager.loadTranscriptData&&this.transcriptManager.loadTranscriptData()},5e3)}else setTimeout(()=>{this.transcriptManager&&this.transcriptManager.loadTranscriptData&&this.transcriptManager.loadTranscriptData()},800)}s||this.hidePosterOverlay(),this._audioDescriptionDesiredState&&(this.state.audioDescriptionEnabled=!0,this.emit("audiodescriptionenabled"))}async disableAudioDescription(){const e=await this.ensureAudioDescriptionManager();return e?.disable()}async _legacyDisableAudioDescription(){if(!this.originalSrc)return;const e=this.element.currentTime,t=this.state.playing;let i=null;if(this.captionManager&&this.captionManager.currentTrack){const e=this.captionManager.currentTrack.track;e&&e.activeCues&&e.activeCues.length>0&&(i=this.stripVTTFormatting(e.activeCues[0].text))}const s=this.resolvePosterPath(this.element.getAttribute("poster")||this.element.poster||this.options.poster);let a=[];if(this.audioDescriptionCaptionTracks.length>0){const e=this.audioDescriptionCaptionTracks.map(e=>{const t=e.trackElement;if(!t||!t.parentNode)return null;const i=t.parentNode,s=t.nextSibling,a={};return Array.from(t.attributes).forEach(e=>{a[e.name]=e.value}),{trackInfo:e,parent:i,nextSibling:s,attributes:a}}).filter(Boolean);e.forEach(({trackInfo:e})=>{e.trackElement&&e.trackElement.parentNode&&e.trackElement.remove()}),this.element.load(),await new Promise(t=>{setTimeout(()=>{e.forEach(({trackInfo:e,parent:t,nextSibling:i,attributes:s})=>{a.push(e);const n=document.createElement("track");n.setAttribute("src",e.originalTrackSrc),Object.keys(s).forEach(e=>{"src"!==e&&"data-desc-src"!==e&&n.setAttribute(e,s[e])}),e.describedSrc&&n.setAttribute("data-desc-src",e.describedSrc),i&&i.parentNode?t.insertBefore(n,i):t.appendChild(n),e.trackElement=n}),this.invalidateTrackCache(),t()},100)})}const n=this.sourceElements;if(n.some(e=>e.getAttribute("data-orig-src"))){const e=[];n.forEach(t=>{const i=t.getAttribute("data-orig-src"),s=t.getAttribute("data-desc-src");if(i){const a=t.getAttribute("type");e.push({src:i,type:a,origSrc:i,descSrc:s})}else{const i=t.getAttribute("type"),a=t.getAttribute("src");e.push({src:a,type:i,origSrc:null,descSrc:s})}});const t=this.element.hasAttribute("src");t&&this.element.getAttribute("src"),t&&this.element.removeAttribute("src"),n.forEach(e=>{e.remove()}),e.forEach(e=>{const t=document.createElement("source");t.setAttribute("src",e.src),e.type&&t.setAttribute("type",e.type),e.origSrc&&t.setAttribute("data-orig-src",e.origSrc),e.descSrc&&t.setAttribute("data-desc-src",e.descSrc);const i=this.element.querySelector("track");i?this.element.insertBefore(t,i):this.element.appendChild(t)}),this._sourceElementsDirty=!0,this._sourceElementsCache=null,s&&"VIDEO"===this.element.tagName&&(this.element.poster=s),this.element.load()}else s&&"VIDEO"===this.element.tagName&&(this.element.poster=s),this.element.src=this.originalAudioDescriptionSource||this.originalSrc,this.element.load();await new Promise(e=>{const t=()=>{this.element.removeEventListener("loadedmetadata",t),e()};this.element.readyState>=1?e():this.element.addEventListener("loadedmetadata",t)}),(e>0||t)&&await new Promise(e=>{const t=()=>{this.element.removeEventListener("canplay",t),this.element.removeEventListener("canplaythrough",t),e()};this.element.readyState>=3?e():(this.element.addEventListener("canplay",t,{once:!0}),this.element.addEventListener("canplaythrough",t,{once:!0}),setTimeout(()=>{this.element.removeEventListener("canplay",t),this.element.removeEventListener("canplaythrough",t),e()},3e3))});let r=e;if(i&&this.captionManager&&this.captionManager.tracks.length>0){await new Promise(e=>setTimeout(e,500));const t=this.findMatchingCaptionTime(i,this.captionManager.tracks);null!==t&&(r=t,this.options.debug&&console.log(`[VidPly] Syncing via caption: ${e}s -> ${r}s`))}if(r>0&&(this.seek(r),await new Promise(e=>setTimeout(e,100))),t?(await this.play(),this.hidePosterOverlay()):(this.pause(),t||0!==r?this.hidePosterOverlay():this.showPosterOverlay()),a.length>0&&this.captionManager){const e=this.state.captionsEnabled;let t=null;if(this.captionManager.currentTrack){const e=this.captionManager.tracks.findIndex(e=>e.track===this.captionManager.currentTrack.track);e>=0&&(t={language:this.captionManager.tracks[e].language,kind:this.captionManager.tracks[e].kind})}const i=()=>{if(this.captionManager.tracks=[],this.captionManager.loadTracks(),e&&t&&this.captionManager.tracks.length>0){const e=this.captionManager.tracks.findIndex(e=>e.language===t.language&&e.kind===t.kind);if(e>=0){const t=this.captionManager.tracks[e];if(t.track.readyState>=2)this.captionManager.enable(e);else{const i=()=>{t.track.removeEventListener("load",i),t.track.removeEventListener("error",i),this.captionManager&&this.captionManager.tracks.includes(t)&&this.captionManager.enable(e)};t.track.addEventListener("load",i,{once:!0}),t.track.addEventListener("error",i,{once:!0}),t.track.mode="hidden",setTimeout(()=>{this.captionManager&&this.captionManager.tracks.includes(t)&&this.captionManager.enable(e)},1e3)}}else if(this.captionManager.tracks.length>0){const e=this.captionManager.tracks[0];if(e.track.readyState>=2)this.captionManager.enable(0);else{const t=()=>{e.track.removeEventListener("load",t),e.track.removeEventListener("error",t),this.captionManager&&this.captionManager.tracks.includes(e)&&this.captionManager.enable(0)};e.track.addEventListener("load",t,{once:!0}),e.track.addEventListener("error",t,{once:!0}),e.track.mode="hidden",setTimeout(()=>{this.captionManager&&this.captionManager.tracks.includes(e)&&this.captionManager.enable(0)},1e3)}}}};setTimeout(i,600)}this.transcriptManager&&this.transcriptManager.isVisible&&this.setManagedTimeout(()=>{this.transcriptManager&&this.transcriptManager.loadTranscriptData&&this.transcriptManager.loadTranscriptData()},500),this._audioDescriptionDesiredState||(this.state.audioDescriptionEnabled=!1,this.emit("audiodescriptiondisabled"))}async toggleAudioDescription(){if(this.options.requirePlaybackForAccessibilityToggles&&!this.renderer&&this.playlistManager?.tracks?.length)return void this.showNotice(b.t("player.startPlaybackForAudioDescription"));const e=await this.ensureAudioDescriptionManager();return e?!this.renderer&&this.playlistManager&&this.playlistManager.tracks?.length?(e.desiredState=!e.desiredState,this.state.audioDescriptionEnabled=e.desiredState,this.emit(e.desiredState?"audiodescriptionenabled":"audiodescriptiondisabled"),void this.play()):e.toggle():void 0}async enableSignLanguage(){const e=await this.ensureSignLanguageManager();return e?.enable()}_legacyEnableSignLanguage(){const e=Object.keys(this.signLanguageSources).length>0;if(!e&&!this.signLanguageSrc)return void console.warn("No sign language video source provided");if(this.signLanguageWrapper)return this.signLanguageWrapper.style.display="block",this.state.signLanguageEnabled=!0,this.emit("signlanguageenabled"),void this.setManagedTimeout(()=>{this.signLanguageSettingsButton&&document.contains(this.signLanguageSettingsButton)&&this.signLanguageSettingsButton.focus({preventScroll:!0})},150);let t=null,i=null;if(e){if(this.captionManager&&this.captionManager.currentTrack){const e=this.captionManager.currentTrack.language?.toLowerCase().split("-")[0];e&&this.signLanguageSources[e]&&(t=e,i=this.signLanguageSources[e])}if(!t&&this.options.language){const e=this.options.language.toLowerCase().split("-")[0];this.signLanguageSources[e]&&(t=e,i=this.signLanguageSources[e])}t||(t=Object.keys(this.signLanguageSources)[0],i=this.signLanguageSources[t]),this.currentSignLanguage=t}else i=this.signLanguageSrc;this.signLanguageWrapper=document.createElement("div"),this.signLanguageWrapper.className="vidply-sign-language-wrapper",this.signLanguageWrapper.setAttribute("tabindex","0"),this.signLanguageWrapper.setAttribute("aria-label",b.t("player.signLanguageDragResize")),this.signLanguageHeader=v.createElement("div",{className:`${this.options.classPrefix}-sign-language-header`,attributes:{tabindex:"0"}});const s=v.createElement("div",{className:`${this.options.classPrefix}-sign-language-header-left`}),a=v.createElement("h3",{textContent:b.t("player.signLanguageVideo")}),n=b.t("player.signLanguageSettings");if(this.signLanguageSettingsButton=v.createElement("button",{className:`${this.options.classPrefix}-sign-language-settings`,attributes:{type:"button","aria-label":n,"aria-expanded":"false"}}),this.signLanguageSettingsButton.appendChild(h("settings")),v.attachTooltip(this.signLanguageSettingsButton,n,this.options.classPrefix),this.signLanguageSettingsHandlers={settingsClick:e=>{if(e.preventDefault(),e.stopPropagation(),this.signLanguageDocumentClickHandler){const e=this.signLanguageSettingsMenuJustOpened;this.signLanguageSettingsMenuJustOpened=!0,setTimeout(()=>{this.signLanguageSettingsMenuJustOpened=e},100)}this.signLanguageSettingsMenuVisible?this.hideSignLanguageSettingsMenu():this.showSignLanguageSettingsMenu()},settingsKeydown:e=>{"d"===e.key||"D"===e.key?(e.preventDefault(),e.stopPropagation(),this.toggleSignLanguageKeyboardDragMode()):"r"===e.key||"R"===e.key?(e.preventDefault(),e.stopPropagation(),this.toggleSignLanguageResizeMode()):"Escape"===e.key&&this.signLanguageSettingsMenuVisible&&(e.preventDefault(),e.stopPropagation(),this.hideSignLanguageSettingsMenu())}},this.signLanguageSettingsButton.addEventListener("click",this.signLanguageSettingsHandlers.settingsClick),this.signLanguageSettingsButton.addEventListener("keydown",this.signLanguageSettingsHandlers.settingsKeydown),s.appendChild(this.signLanguageSettingsButton),this.signLanguageSelector=null,e){const e=`${this.options.classPrefix}-sign-language-select-${Date.now()}`,i=Object.keys(this.signLanguageSources).map(e=>({value:e,text:this.getSignLanguageLabel(e),selected:e===t})),{label:a,select:n}=u({classPrefix:this.options.classPrefix,labelClass:`${this.options.classPrefix}-sign-language-label`,selectClass:`${this.options.classPrefix}-sign-language-select`,labelText:"settings.language",selectId:e,options:i,onChange:e=>{e.stopPropagation(),this.switchSignLanguage(e.target.value)}});this.signLanguageSelector=n;const r=v.createElement("div",{className:`${this.options.classPrefix}-sign-language-selector-wrapper`});r.appendChild(a),r.appendChild(this.signLanguageSelector),f(r),s.appendChild(r)}s.appendChild(a);const r=b.t("player.closeSignLanguage"),o=v.createElement("button",{className:`${this.options.classPrefix}-sign-language-close`,attributes:{type:"button","aria-label":r}});o.appendChild(h("close")),v.attachTooltip(o,r,this.options.classPrefix),o.addEventListener("click",()=>{this.disableSignLanguage(),this.controlBar&&this.controlBar.controls&&this.controlBar.controls.signLanguage&&setTimeout(()=>{this.controlBar.controls.signLanguage.focus({preventScroll:!0})},0)}),this.signLanguageHeader.appendChild(s),this.signLanguageHeader.appendChild(o),this.signLanguageSettingsMenuVisible=!1,this.signLanguageSettingsMenu=null,this.signLanguageSettingsMenuJustOpened=!1,this.signLanguageResizeOptionButton=null,this.signLanguageResizeOptionText=null,this.signLanguageDragOptionButton=null,this.signLanguageDragOptionText=null,this.signLanguageDocumentClickHandler=null,this.signLanguageDocumentClickHandlerAdded=!1,this.signLanguageVideo=document.createElement("video"),this.signLanguageVideo.className="vidply-sign-language-video",this.signLanguageVideo.src=i,this.signLanguageVideo.setAttribute("aria-label",b.t("player.signLanguage")),this.signLanguageVideo.muted=!0,this.signLanguageVideo.setAttribute("playsinline",""),this.signLanguageResizeHandles=["n","s","e","w","ne","nw","se","sw"].map(e=>{const t=v.createElement("div",{className:`${this.options.classPrefix}-sign-resize-handle ${this.options.classPrefix}-sign-resize-${e}`,attributes:{"data-direction":e,"data-vidply-managed-resize":"true","aria-hidden":"true"}});return t.style.display="none",t}),this.signLanguageWrapper.appendChild(this.signLanguageHeader),this.signLanguageWrapper.appendChild(this.signLanguageVideo),this.signLanguageResizeHandles.forEach(e=>this.signLanguageWrapper.appendChild(e));const l=this.storage.getSignLanguagePreferences();this.signLanguageWrapper.style.width=l&&l.size&&l.size.width?l.size.width:"280px",this.signLanguageWrapper.style.height="auto",this.signLanguageDesiredPosition=this.options.signLanguagePosition||"bottom-right",this.container.appendChild(this.signLanguageWrapper),requestAnimationFrame(()=>{this.constrainSignLanguagePosition()}),this.signLanguageVideo.currentTime=this.state.currentTime,this.state.paused||this.signLanguageVideo.play(),this.setupSignLanguageInteraction(),this.signLanguageHandlers={play:()=>{this.signLanguageVideo&&this.signLanguageVideo.play()},pause:()=>{this.signLanguageVideo&&this.signLanguageVideo.pause()},timeupdate:()=>{this.signLanguageVideo&&Math.abs(this.signLanguageVideo.currentTime-this.state.currentTime)>.5&&(this.signLanguageVideo.currentTime=this.state.currentTime)},ratechange:()=>{this.signLanguageVideo&&(this.signLanguageVideo.playbackRate=this.state.playbackSpeed)}},this.on("play",this.signLanguageHandlers.play),this.on("pause",this.signLanguageHandlers.pause),this.on("timeupdate",this.signLanguageHandlers.timeupdate),this.on("ratechange",this.signLanguageHandlers.ratechange),e&&(this.signLanguageHandlers.captionChange=()=>{if(this.captionManager&&this.captionManager.currentTrack&&this.signLanguageSelector){const e=this.captionManager.currentTrack.language?.toLowerCase().split("-")[0];e&&this.signLanguageSources[e]&&this.currentSignLanguage!==e&&(this.switchSignLanguage(e),this.signLanguageSelector.value=e)}},this.on("captionsenabled",this.signLanguageHandlers.captionChange)),this.state.signLanguageEnabled=!0,this.emit("signlanguageenabled"),this.setManagedTimeout(()=>{this.signLanguageSettingsButton&&document.contains(this.signLanguageSettingsButton)&&this.signLanguageSettingsButton.focus({preventScroll:!0})},150)}async disableSignLanguage(){const e=await this.ensureSignLanguageManager();return e?.disable()}async toggleSignLanguage(){if(this.options.requirePlaybackForAccessibilityToggles&&!this.renderer&&this.playlistManager?.tracks?.length)return void this.showNotice(b.t("player.startPlaybackForSignLanguage"));const e=await this.ensureSignLanguageManager();if(e){if(!this.renderer&&this.playlistManager&&this.playlistManager.tracks?.length){const t=e.enabled,i=e.toggle();return!t&&e.enabled&&this.play(),i}return e.toggle()}}setupSignLanguageInteraction(){return this.signLanguageManager?._setupInteraction()}_legacySetupSignLanguageInteraction(){this.signLanguageWrapper&&(window.innerWidth<768&&!this.state.fullscreen?this.signLanguageDraggable&&(this.signLanguageDraggable.destroy(),this.signLanguageDraggable=null):this.signLanguageDraggable||(this.signLanguageDraggable=new l(this.signLanguageWrapper,{dragHandle:this.signLanguageHeader,resizeHandles:this.signLanguageResizeHandles,constrainToViewport:!0,maintainAspectRatio:!0,minWidth:150,minHeight:100,classPrefix:`${this.options.classPrefix}-sign`,keyboardDragKey:"d",keyboardResizeKey:"r",keyboardStep:10,keyboardStepLarge:50,pointerResizeIndicatorText:b.t("player.signLanguageResizeActive"),onPointerResizeToggle:e=>{this.signLanguageResizeHandles.forEach(t=>{t.style.display=e?"block":"none"})},onDragStart:e=>!(e.target.closest(`.${this.options.classPrefix}-sign-language-close`)||e.target.closest(`.${this.options.classPrefix}-sign-language-settings`)||e.target.closest(`.${this.options.classPrefix}-sign-language-select`)||e.target.closest(`.${this.options.classPrefix}-sign-language-label`)||e.target.closest(`.${this.options.classPrefix}-sign-language-settings-menu`))}),this.signLanguageCustomKeyHandler=e=>{const t=e.key.toLowerCase();if(!this.signLanguageSettingsMenuVisible)return"home"===t?(e.preventDefault(),e.stopPropagation(),void(this.signLanguageDraggable&&(this.signLanguageDraggable.pointerResizeMode&&this.signLanguageDraggable.disablePointerResizeMode(),this.signLanguageDraggable.manuallyPositioned=!1,this.constrainSignLanguagePosition()))):"r"===t?(e.preventDefault(),e.stopPropagation(),void(this.toggleSignLanguageResizeMode()&&this.signLanguageWrapper.focus({preventScroll:!0}))):"escape"===t?(e.preventDefault(),e.stopPropagation(),this.signLanguageDraggable&&this.signLanguageDraggable.pointerResizeMode?void this.signLanguageDraggable.disablePointerResizeMode():this.signLanguageDraggable&&this.signLanguageDraggable.keyboardDragMode?void this.signLanguageDraggable.disableKeyboardDragMode():(this.disableSignLanguage(),void(this.controlBar&&this.controlBar.controls&&this.controlBar.controls.signLanguage&&setTimeout(()=>{this.controlBar.controls.signLanguage.focus({preventScroll:!0})},0)))):void 0},this.signLanguageWrapper.addEventListener("keydown",this.signLanguageCustomKeyHandler),this.signLanguageInteractionHandlers={draggable:this.signLanguageDraggable,headerKeyHandler:this.signLanguageHeaderKeyHandler,customKeyHandler:this.signLanguageCustomKeyHandler}))}toggleSignLanguageKeyboardDragMode(){if(this.signLanguageDraggable){const e=this.signLanguageDraggable.keyboardDragMode;this.signLanguageDraggable.toggleKeyboardDragMode(),!e&&this.signLanguageDraggable.keyboardDragMode&&this.enableSignLanguageMoveMode(),this.updateSignLanguageDragOptionState()}}enableSignLanguageMoveMode(){this.signLanguageWrapper.classList.add(`${this.options.classPrefix}-sign-move-mode`),this.updateSignLanguageResizeOptionState(),setTimeout(()=>{this.signLanguageWrapper.classList.remove(`${this.options.classPrefix}-sign-move-mode`)},2e3)}toggleSignLanguageResizeMode({focus:e=!0}={}){return!!this.signLanguageDraggable&&(this.signLanguageDraggable.pointerResizeMode?(this.signLanguageDraggable.disablePointerResizeMode({focus:e}),this.updateSignLanguageResizeOptionState(),!1):(this.signLanguageDraggable.enablePointerResizeMode({focus:e}),this.updateSignLanguageResizeOptionState(),!0))}getSignLanguageLabel(e){return{en:"English",de:"Deutsch",es:"EspaÃ±ol",fr:"FranÃ§ais",it:"Italiano",ja:"æ—¥æœ¬èªž",pt:"PortuguÃªs",ar:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",hi:"à¤¹à¤¿à¤¨à¥à¤¦à¥€"}[e]||e.toUpperCase()}switchSignLanguage(e){return this.signLanguageManager?.switchLanguage(e)}_legacySwitchSignLanguage(e){if(!this.signLanguageSources[e]||!this.signLanguageVideo)return;const t=this.signLanguageVideo.currentTime,i=!this.signLanguageVideo.paused;this.signLanguageVideo.src=this.signLanguageSources[e],this.currentSignLanguage=e,this.signLanguageVideo.currentTime=t,i&&this.signLanguageVideo.play().catch(()=>{}),this.emit("signlanguagelanguagechanged",e)}showSignLanguageSettingsMenu(){return this.signLanguageManager?.showSettingsMenu()}_legacyShowSignLanguageSettingsMenu(){if(this.signLanguageSettingsMenuJustOpened=!0,setTimeout(()=>{this.signLanguageSettingsMenuJustOpened=!1},350),this.signLanguageDocumentClickHandlerAdded||(this.signLanguageDocumentClickHandler=e=>{this.signLanguageSettingsMenuJustOpened||this.signLanguageSettingsButton&&(this.signLanguageSettingsButton===e.target||this.signLanguageSettingsButton.contains(e.target))||this.signLanguageSettingsMenu&&this.signLanguageSettingsMenu.contains(e.target)||this.signLanguageSettingsMenuVisible&&this.hideSignLanguageSettingsMenu()},setTimeout(()=>{document.addEventListener("mousedown",this.signLanguageDocumentClickHandler,!0),this.signLanguageDocumentClickHandlerAdded=!0},300)),this.signLanguageSettingsMenu)return this.signLanguageSettingsMenu.style.display="block",this.signLanguageSettingsMenuVisible=!0,this.signLanguageSettingsButton&&this.signLanguageSettingsButton.setAttribute("aria-expanded","true"),this.signLanguageSettingsMenuKeyHandler=c(this.signLanguageSettingsMenu,this.signLanguageSettingsButton,`.${this.options.classPrefix}-sign-language-settings-item`,()=>this.hideSignLanguageSettingsMenu({focusButton:!0})),this.positionSignLanguageSettingsMenu(),this.updateSignLanguageDragOptionState(),this.updateSignLanguageResizeOptionState(),void m(this.signLanguageSettingsMenu,`.${this.options.classPrefix}-sign-language-settings-item`);this.signLanguageSettingsMenu=v.createElement("div",{className:`${this.options.classPrefix}-sign-language-settings-menu`,attributes:{role:"menu"}});const e=p({classPrefix:this.options.classPrefix,itemClass:`${this.options.classPrefix}-sign-language-settings-item`,icon:"move",label:"player.enableSignDragMode",hasTextClass:!0,onClick:()=>{this.toggleSignLanguageKeyboardDragMode(),this.hideSignLanguageSettingsMenu()}});e.setAttribute("role","switch"),e.setAttribute("aria-checked","false");const t=e.querySelector(`.${this.options.classPrefix}-tooltip`);t&&t.remove();const i=e.querySelector(`.${this.options.classPrefix}-button-text`);i&&i.remove(),this.signLanguageDragOptionButton=e,this.signLanguageDragOptionText=e.querySelector(`.${this.options.classPrefix}-settings-text`),this.updateSignLanguageDragOptionState();const s=p({classPrefix:this.options.classPrefix,itemClass:`${this.options.classPrefix}-sign-language-settings-item`,icon:"resize",label:"player.enableSignResizeMode",hasTextClass:!0,onClick:e=>{e.preventDefault(),e.stopPropagation(),this.toggleSignLanguageResizeMode({focus:!1})?(this.hideSignLanguageSettingsMenu({focusButton:!1}),setTimeout(()=>{this.signLanguageWrapper&&this.signLanguageWrapper.focus({preventScroll:!0})},20)):this.hideSignLanguageSettingsMenu({focusButton:!0})}});s.setAttribute("role","switch"),s.setAttribute("aria-checked","false");const a=s.querySelector(`.${this.options.classPrefix}-tooltip`);a&&a.remove();const n=s.querySelector(`.${this.options.classPrefix}-button-text`);n&&n.remove(),this.signLanguageResizeOptionButton=s,this.signLanguageResizeOptionText=s.querySelector(`.${this.options.classPrefix}-settings-text`),this.updateSignLanguageResizeOptionState();const r=p({classPrefix:this.options.classPrefix,itemClass:`${this.options.classPrefix}-sign-language-settings-item`,icon:"close",label:"transcript.closeMenu",onClick:()=>{this.hideSignLanguageSettingsMenu()}}),o=r.querySelector(`.${this.options.classPrefix}-tooltip`);o&&o.remove();const l=r.querySelector(`.${this.options.classPrefix}-button-text`);l&&l.remove(),this.signLanguageSettingsMenu.appendChild(e),this.signLanguageSettingsMenu.appendChild(s),this.signLanguageSettingsMenu.appendChild(r),this.signLanguageSettingsMenu.style.visibility="hidden",this.signLanguageSettingsMenu.style.display="block",this.signLanguageSettingsButton&&this.signLanguageSettingsButton.parentNode?this.signLanguageSettingsButton.insertAdjacentElement("afterend",this.signLanguageSettingsMenu):this.signLanguageWrapper&&this.signLanguageWrapper.appendChild(this.signLanguageSettingsMenu),this.positionSignLanguageSettingsMenuImmediate(),requestAnimationFrame(()=>{this.signLanguageSettingsMenu&&(this.signLanguageSettingsMenu.style.visibility="visible")}),this.signLanguageSettingsMenuKeyHandler=c(this.signLanguageSettingsMenu,this.signLanguageSettingsButton,`.${this.options.classPrefix}-sign-language-settings-item`,()=>this.hideSignLanguageSettingsMenu({focusButton:!0})),this.signLanguageSettingsMenuVisible=!0,this.signLanguageSettingsButton&&this.signLanguageSettingsButton.setAttribute("aria-expanded","true"),this.updateSignLanguageDragOptionState(),this.updateSignLanguageResizeOptionState(),m(this.signLanguageSettingsMenu,`.${this.options.classPrefix}-sign-language-settings-item`)}hideSignLanguageSettingsMenu({focusButton:e=!0}={}){return this.signLanguageManager?.hideSettingsMenu({focusButton:e})}positionSignLanguageSettingsMenuImmediate(){if(!this.signLanguageSettingsMenu||!this.signLanguageSettingsButton)return;const e=this.signLanguageSettingsButton.getBoundingClientRect(),t=this.signLanguageSettingsMenu.getBoundingClientRect(),i=window.innerWidth,s=window.innerHeight,a=this.signLanguageSettingsButton.parentElement;if(!a)return;const n=a.getBoundingClientRect(),r=e.left+e.width/2-n.left,o=s-e.bottom;let l=e.bottom-n.top+8,c=null;o<t.height+20&&e.top>o?(l=null,c=n.bottom-n.top-(e.top-n.top)+8,this.signLanguageSettingsMenu.classList.add("vidply-menu-above")):this.signLanguageSettingsMenu.classList.remove("vidply-menu-above");let h=r-t.width/2,u="auto",p="translateX(0)";const d=e.left+e.width/2-t.width/2;d<10?(h=0,p="translateX(0)"):d+t.width>i-10?(h="auto",u=0,p="translateX(0)"):(h=r,p="translateX(-50%)"),null!==l?(this.signLanguageSettingsMenu.style.top=`${l}px`,this.signLanguageSettingsMenu.style.bottom="auto"):null!==c&&(this.signLanguageSettingsMenu.style.top="auto",this.signLanguageSettingsMenu.style.bottom=`${c}px`),"auto"!==h?(this.signLanguageSettingsMenu.style.left=`${h}px`,this.signLanguageSettingsMenu.style.right="auto"):(this.signLanguageSettingsMenu.style.left="auto",this.signLanguageSettingsMenu.style.right=`${u}px`),this.signLanguageSettingsMenu.style.transform=p}positionSignLanguageSettingsMenu(){this.signLanguageSettingsMenu&&this.signLanguageSettingsButton&&this.signLanguageWrapper&&requestAnimationFrame(()=>{setTimeout(()=>{this.positionSignLanguageSettingsMenuImmediate()},10)})}attachSignLanguageSettingsMenuKeyboardNavigation(){this.signLanguageSettingsMenu&&(this.signLanguageSettingsMenuKeyHandler&&this.signLanguageSettingsMenu.removeEventListener("keydown",this.signLanguageSettingsMenuKeyHandler),this.signLanguageSettingsMenuKeyHandler=c(this.signLanguageSettingsMenu,this.signLanguageSettingsButton,`.${this.options.classPrefix}-sign-language-settings-item`,()=>this.hideSignLanguageSettingsMenu({focusButton:!0})))}updateSignLanguageDragOptionState(){if(!this.signLanguageDragOptionButton)return;const e=!(!this.signLanguageDraggable||!this.signLanguageDraggable.keyboardDragMode),t=b.t(e?"player.disableSignDragMode":"player.enableSignDragMode"),i=b.t(e?"player.disableSignDragModeAria":"player.enableSignDragModeAria");this.signLanguageDragOptionButton.setAttribute("aria-checked",e?"true":"false"),this.signLanguageDragOptionButton.setAttribute("aria-label",i),this.signLanguageDragOptionText&&(this.signLanguageDragOptionText.textContent=t)}updateSignLanguageResizeOptionState(){if(!this.signLanguageResizeOptionButton)return;const e=!(!this.signLanguageDraggable||!this.signLanguageDraggable.pointerResizeMode),t=b.t(e?"player.disableSignResizeMode":"player.enableSignResizeMode"),i=b.t(e?"player.disableSignResizeModeAria":"player.enableSignResizeModeAria");this.signLanguageResizeOptionButton.setAttribute("aria-checked",e?"true":"false"),this.signLanguageResizeOptionButton.setAttribute("aria-label",i),this.signLanguageResizeOptionText&&(this.signLanguageResizeOptionText.textContent=t)}constrainSignLanguagePosition(){return this.signLanguageManager?.constrainPosition()}saveSignLanguagePreferences(){return this.signLanguageManager?.savePreferences()}_legacyConstrainSignLanguagePosition(){if(!this.signLanguageWrapper||!this.videoWrapper)return;if(this.signLanguageDraggable&&this.signLanguageDraggable.manuallyPositioned)return;this.signLanguageWrapper.style.width&&""!==this.signLanguageWrapper.style.width||(this.signLanguageWrapper.style.width="280px");const e=this.videoWrapper.getBoundingClientRect(),t=this.container.getBoundingClientRect(),i=this.signLanguageWrapper.getBoundingClientRect(),s=e.left-t.left,a=e.top-t.top,n=e.width,r=e.height;let o,l,c=i.width||280,h=i.height||157.5;const u=16;switch(this.signLanguageDesiredPosition||"bottom-right"){case"bottom-right":default:o=s+n-c-u,l=a+r-h-95;break;case"bottom-left":o=s+u,l=a+r-h-95;break;case"top-right":o=s+n-c-u,l=a+u;break;case"top-left":o=s+u,l=a+u}o=Math.max(s,Math.min(o,s+n-c)),l=Math.max(a,Math.min(l,a+r-h-95)),this.signLanguageWrapper.style.left=`${o}px`,this.signLanguageWrapper.style.top=`${l}px`,this.signLanguageWrapper.style.right="auto",this.signLanguageWrapper.style.bottom="auto",this.signLanguageWrapper.classList.remove(...Array.from(this.signLanguageWrapper.classList).filter(e=>e.startsWith("vidply-sign-position-")))}_legacySaveSignLanguagePreferences(){this.signLanguageWrapper&&this.storage.saveSignLanguagePreferences({size:{width:this.signLanguageWrapper.style.width}})}cleanupSignLanguage(){return this.signLanguageManager?.cleanup()}showSettings(){console.warn("[VidPly] Settings dialog has been removed. Use individual control buttons (speed, captions, etc.)")}hideSettings(){}getCurrentTime(){return this.state.currentTime}getDuration(){return this.state.duration}isPlaying(){return this.state.playing}isPaused(){return this.state.paused}isEnded(){return this.state.ended}isMuted(){return this.state.muted}isFullscreen(){return this.state.fullscreen}handleError(e){this._switchingRenderer?this.log("Suppressing error during renderer switch:",e,"debug"):(this.log("Error:",e,"error"),this.emit("error",e),this.options.onError&&this.options.onError.call(this,e))}log(...e){if(!this.options.debug)return;let t="log";if(e.length>0){const i=e[e.length-1];"string"==typeof i&&console[i]&&(t=i,e=e.slice(0,-1))}0===e.length&&(e=[""]),"function"==typeof console[t]?console[t]("[VidPly]",...e):console.log("[VidPly]",...e)}setupResponsiveHandlers(){if("undefined"!=typeof ResizeObserver?(this.resizeObserver=new ResizeObserver(e=>{for(const t of e)this.controlBar&&"function"==typeof this.controlBar.updateControlsForViewport&&this.controlBar.updateControlsForViewport(t.contentRect.width),this.transcriptManager&&this.transcriptManager.isVisible&&this.transcriptManager.positionTranscript()}),this.resizeObserver.observe(this.container)):(this.resizeHandler=()=>{this.controlBar&&"function"==typeof this.controlBar.updateControlsForViewport&&this.controlBar.updateControlsForViewport(this.container.clientWidth),this.transcriptManager&&this.transcriptManager.isVisible&&(this.transcriptManager.draggableResizable&&this.transcriptManager.draggableResizable.manuallyPositioned||this.transcriptManager.positionTranscript())},window.addEventListener("resize",this.resizeHandler)),window.matchMedia){this.orientationHandler=e=>{setTimeout(()=>{this.transcriptManager&&this.transcriptManager.isVisible&&(this.transcriptManager.draggableResizable&&this.transcriptManager.draggableResizable.manuallyPositioned||this.transcriptManager.positionTranscript())},100)};const e=window.matchMedia("(orientation: portrait)");e.addEventListener?e.addEventListener("change",this.orientationHandler):e.addListener&&e.addListener(this.orientationHandler),this.orientationQuery=e}this.fullscreenChangeHandler=()=>{const e=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);this.state.fullscreen!==e&&(this.state.fullscreen=e,e?(this.container.classList.add(`${this.options.classPrefix}-fullscreen`),document.body.classList.add("vidply-fullscreen-active"),this._makeBackgroundInert()):(this.container.classList.remove(`${this.options.classPrefix}-fullscreen`),document.body.classList.remove("vidply-fullscreen-active"),this._restoreBackgroundInteractivity(),this._disablePseudoFullscreen()),this.emit("fullscreenchange",e),this.controlBar&&this.controlBar.updateFullscreenButton(),this.signLanguageWrapper&&"none"!==this.signLanguageWrapper.style.display)&&(window.innerWidth<768&&this.setupSignLanguageInteraction(),this.setManagedTimeout(()=>{requestAnimationFrame(()=>{this.storage.saveSignLanguagePreferences({size:null}),this.signLanguageDesiredPosition="bottom-right",this.signLanguageWrapper.style.width=e?"400px":"280px",this.constrainSignLanguagePosition()})},500))},document.addEventListener("fullscreenchange",this.fullscreenChangeHandler),document.addEventListener("webkitfullscreenchange",this.fullscreenChangeHandler),document.addEventListener("mozfullscreenchange",this.fullscreenChangeHandler),document.addEventListener("MSFullscreenChange",this.fullscreenChangeHandler)}destroy(){if(this.log("Destroying player"),this.renderer&&this.renderer.destroy(),this.controlBar&&this.controlBar.destroy(),this.captionManager&&this.captionManager.destroy(),this.keyboardManager&&this.keyboardManager.destroy(),this.transcriptManager&&this.transcriptManager.destroy(),this.cleanupSignLanguage(),this.playButtonOverlay&&this.playButtonOverlay.parentNode&&(this.playButtonOverlay.remove(),this.playButtonOverlay=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),this.orientationQuery&&this.orientationHandler&&(this.orientationQuery.removeEventListener?this.orientationQuery.removeEventListener("change",this.orientationHandler):this.orientationQuery.removeListener&&this.orientationQuery.removeListener(this.orientationHandler),this.orientationQuery=null,this.orientationHandler=null),this.fullscreenChangeHandler&&(document.removeEventListener("fullscreenchange",this.fullscreenChangeHandler),document.removeEventListener("webkitfullscreenchange",this.fullscreenChangeHandler),document.removeEventListener("mozfullscreenchange",this.fullscreenChangeHandler),document.removeEventListener("MSFullscreenChange",this.fullscreenChangeHandler),this.fullscreenChangeHandler=null),this.timeouts.forEach(e=>clearTimeout(e)),this.timeouts.clear(),this.metadataCueChangeHandler){const e=this.textTracks.find(e=>"metadata"===e.kind);e&&e.removeEventListener("cuechange",this.metadataCueChangeHandler),this.metadataCueChangeHandler=null}this.metadataAlertHandlers&&this.metadataAlertHandlers.size>0&&(this.metadataAlertHandlers.forEach(({button:e,handler:t})=>{e&&t&&e.removeEventListener("click",t)}),this.metadataAlertHandlers.clear()),this.container&&this.container.parentNode&&(this.container.parentNode.insertBefore(this.element,this.container),this.container.parentNode.removeChild(this.container)),this.removeAllListeners()}setupMetadataHandling(){const e=()=>{const e=this.textTracks.find(e=>"metadata"===e.kind);e?("disabled"===e.mode&&(e.mode="hidden"),this.metadataCueChangeHandler&&e.removeEventListener("cuechange",this.metadataCueChangeHandler),this.metadataCueChangeHandler=()=>{const t=Array.from(e.activeCues||[]);t.length>0&&this.options.debug&&this.log("[Metadata] Active cues:",t.map(e=>({start:e.startTime,end:e.endTime,text:e.text}))),t.forEach(e=>{this.handleMetadataCue(e)})},e.addEventListener("cuechange",this.metadataCueChangeHandler),this.options.debug&&this.log("[Metadata] Track enabled,",e.cues?e.cues.length:0,"cues available")):this.options.debug&&this.log("[Metadata] No metadata track found")};e(),this.on("loadedmetadata",e)}normalizeMetadataSelector(e){if(!e)return null;const t=e.trim();return t?t.startsWith("#")||t.startsWith(".")||t.startsWith("[")?t:`#${t}`:null}resolveMetadataConfig(e,t){if(!e||!t)return null;if(Object.prototype.hasOwnProperty.call(e,t))return e[t];const i=t.replace(/^#/,"");return Object.prototype.hasOwnProperty.call(e,i)?e[i]:null}cacheMetadataAlertContent(e,t={}){if(!e)return;const i=t.messageSelector||"[data-vidply-alert-message], p",s=e.querySelector(t.titleSelector||"[data-vidply-alert-title], h3, header");s&&!s.dataset.vidplyAlertTitleOriginal&&(s.dataset.vidplyAlertTitleOriginal=s.textContent.trim());const a=e.querySelector(i);a&&!a.dataset.vidplyAlertMessageOriginal&&(a.dataset.vidplyAlertMessageOriginal=a.textContent.trim())}restoreMetadataAlertContent(e,t={}){if(!e)return;const i=t.messageSelector||"[data-vidply-alert-message], p",s=e.querySelector(t.titleSelector||"[data-vidply-alert-title], h3, header");s&&s.dataset.vidplyAlertTitleOriginal&&(s.textContent=s.dataset.vidplyAlertTitleOriginal);const a=e.querySelector(i);a&&a.dataset.vidplyAlertMessageOriginal&&(a.textContent=a.dataset.vidplyAlertMessageOriginal)}focusMetadataTarget(e,t=null){if(e&&"none"!==e)if("alert"===e&&t)t.focus({preventScroll:!0});else if("player"!==e)if("media"!==e){if("playButton"===e){const e=this.controlBar?.controls?.playPause;return void(e&&e.focus({preventScroll:!0}))}if("string"==typeof e){const t=document.querySelector(e);t&&(-1!==t.tabIndex||t.hasAttribute("tabindex")||t.setAttribute("tabindex","-1"),t.focus({preventScroll:!0}))}}else this.element.focus({preventScroll:!0});else this.container&&this.container.focus({preventScroll:!0})}handleMetadataAlert(e,t={}){if(!e)return;const i=this.resolveMetadataConfig(this.options.metadataAlerts,e)||{},s=t.element||document.querySelector(e);if(!s)return void(this.options.debug&&this.log("[Metadata] Alert element not found:",e));this.options.debug&&this.log("[Metadata] Handling alert",e,{reason:t.reason,config:i}),this.cacheMetadataAlertContent(s,i),s.dataset.vidplyAlertOriginalDisplay||(s.dataset.vidplyAlertOriginalDisplay=s.style.display||""),s.dataset.vidplyAlertDisplay||(s.dataset.vidplyAlertDisplay=i.display||"block");const a=void 0!==t.show?t.show:!1!==i.show;a&&(s.style.display=i.display||s.dataset.vidplyAlertDisplay||"block",s.hidden=!1,s.removeAttribute("hidden"),s.setAttribute("aria-hidden","false"),s.setAttribute("data-vidply-alert-active","true")),!1!==i.resetContent&&"focus"===t.reason&&this.restoreMetadataAlertContent(s,i),a&&(void 0!==t.focus?t.focus:i.focusOnShow??"focus"!==t.reason)&&(-1!==s.tabIndex||s.hasAttribute("tabindex")||s.setAttribute("tabindex","-1"),s.focus({preventScroll:!0})),a&&!1!==i.autoScroll&&!1!==t.autoScroll&&s.scrollIntoView({behavior:"smooth",block:"nearest"});const n=i.continueButton;if(n){let t=null;if(t="self"===n||s.matches(n)?s:s.querySelector(n)||document.querySelector(n),t&&!this.metadataAlertHandlers.has(e)){const a=()=>{!1!==i.hideOnContinue&&(s.style.display=i.hideDisplay||s.dataset.vidplyAlertOriginalDisplay||""||"none",s.setAttribute("aria-hidden","true"),s.removeAttribute("data-vidply-alert-active")),!1!==i.resume&&this.state.paused&&this.play();const e=i.focusTarget||"playButton";this.setManagedTimeout(()=>{this.focusMetadataTarget(e,s)},i.focusDelay??100)};t.addEventListener("click",a),this.metadataAlertHandlers.set(e,{button:t,handler:a})}}return s}handleMetadataHashtags(e){if(!Array.isArray(e)||0===e.length)return;const t=this.options.metadataHashtags;t&&e.forEach(e=>{const i=this.resolveMetadataConfig(t,e);if(!i)return;const s=this.normalizeMetadataSelector(i.alert||i.selector||i.target);if(!s)return;const a=document.querySelector(s);if(a){if(this.options.debug&&this.log("[Metadata] Handling hashtag",e,{selector:s,config:i}),this.cacheMetadataAlertContent(a,i),i.title){const e=a.querySelector(i.titleSelector||"[data-vidply-alert-title], h3, header");e&&(e.textContent=i.title)}if(i.message){const e=a.querySelector(i.messageSelector||"[data-vidply-alert-message], p");e&&(e.textContent=i.message)}this.handleMetadataAlert(s,{element:a,show:!1!==i.show,focus:void 0!==i.focus&&i.focus,autoScroll:i.autoScroll,reason:"hashtag"})}else this.options.debug&&this.log("[Metadata] Hashtag target not found:",s)})}handleMetadataCue(e){const t=e.text.trim();this.options.debug&&this.log("[Metadata] Processing cue:",{time:e.startTime,text:t}),this.emit("metadata",{time:e.startTime,endTime:e.endTime,text:t,cue:e}),t.includes("PAUSE")&&(this.state.paused||(this.options.debug&&this.log("[Metadata] Pausing video at",e.startTime),this.pause()),this.emit("metadata:pause",{time:e.startTime,text:t}));const i=t.match(/FOCUS:([\w#-]+)/);if(i){const s=i[1],a=this.normalizeMetadataSelector(s),n=a?document.querySelector(a):null;n?(this.options.debug&&this.log("[Metadata] Focusing element:",a),-1!==n.tabIndex||n.hasAttribute("tabindex")||n.setAttribute("tabindex","-1"),this.setManagedTimeout(()=>{n.focus({preventScroll:!0})},10)):this.options.debug&&this.log("[Metadata] Element not found:",a||s),this.emit("metadata:focus",{time:e.startTime,target:s,selector:a,element:n,text:t}),a&&this.handleMetadataAlert(a,{element:n,reason:"focus"})}const s=t.match(/#[\w-]+/g);s&&(this.options.debug&&this.log("[Metadata] Hashtags found:",s),this.emit("metadata:hashtags",{time:e.startTime,hashtags:s,text:t}),this.handleMetadataHashtags(s))}};x.instances=[];var C=0,T=class{constructor(e,t={}){this.player=e,this.tracks=[],this.initialTracks=Array.isArray(t.tracks)?t.tracks:[],this.currentIndex=-1,this.instanceId=++C,this.uniqueId=`vidply-playlist-${this.instanceId}`,this.options={autoAdvance:!1!==t.autoAdvance,autoPlayFirst:!1!==t.autoPlayFirst,loop:t.loop||!1,showPanel:!1!==t.showPanel,recreatePlayers:t.recreatePlayers||!1,...t},this.container=null,this.playlistPanel=null,this.trackInfoElement=null,this.navigationFeedback=null,this.isPanelVisible=!1!==this.options.showPanel,this.isChangingTrack=!1,this.hostElement=t.hostElement||null,this.PlayerClass=t.PlayerClass||null,this.handleTrackEnd=this.handleTrackEnd.bind(this),this.handleTrackError=this.handleTrackError.bind(this),this.player.playlistManager=this,this.init(),this.updatePlayerControls(),this.initialTracks.length>0&&this.loadPlaylist(this.initialTracks)}getTrackMediaType(e){const t=e.src||"";return t.includes("youtube.com")||t.includes("youtu.be")?"youtube":t.includes("vimeo.com")?"vimeo":t.includes("soundcloud.com")||t.includes("api.soundcloud.com")?"soundcloud":t.includes(".m3u8")?"hls":e.type&&e.type.startsWith("audio/")?"audio":"video"}async recreatePlayerForTrack(e,t=!1){if(!this.hostElement||!this.PlayerClass)return console.warn("VidPly Playlist: Cannot recreate player - missing hostElement or PlayerClass"),!1;const i=this.getTrackMediaType(e),s="audio"===i?"audio":"video",a=this.isPanelVisible,n=[...this.tracks],r=this.currentIndex;this.trackArtworkElement&&this.trackArtworkElement.parentNode&&this.trackArtworkElement.parentNode.removeChild(this.trackArtworkElement),this.trackInfoElement&&this.trackInfoElement.parentNode&&this.trackInfoElement.parentNode.removeChild(this.trackInfoElement),this.navigationFeedback&&this.navigationFeedback.parentNode&&this.navigationFeedback.parentNode.removeChild(this.navigationFeedback),this.playlistPanel&&this.playlistPanel.parentNode&&this.playlistPanel.parentNode.removeChild(this.playlistPanel);const o=this.player?.options?{...this.player.options}:{};this.player&&(this.player.off("ended",this.handleTrackEnd),this.player.off("error",this.handleTrackError),this.player.destroy()),this.hostElement.innerHTML="";const l=document.createElement(s);l.setAttribute("preload",o.preload||"metadata"),"video"!==s||!e.poster||"video"!==i&&"hls"!==i||l.setAttribute("poster",e.poster);if(!["youtube","vimeo","soundcloud","hls"].includes(i)){const t=document.createElement("source");t.src=e.src,e.type&&(t.type=e.type),l.appendChild(t),e.tracks&&e.tracks.length>0&&e.tracks.forEach(e=>{const t=document.createElement("track");t.src=e.src,t.kind=e.kind||"captions",t.srclang=e.srclang||"en",t.label=e.label||e.srclang,e.default&&(t.default=!0),l.appendChild(t)})}this.hostElement.appendChild(l);const c={mediaType:s,poster:e.poster,audioDescriptionSrc:e.audioDescriptionSrc||null,audioDescriptionDuration:e.audioDescriptionDuration||null,signLanguageSrc:e.signLanguageSrc||null};if(Object.assign(c,o),this.player=new this.PlayerClass(l,c),this.player.playlistManager=this,await new Promise(e=>{this.player.on("ready",e)}),this.player.on("ended",this.handleTrackEnd),this.player.on("error",this.handleTrackError),this.player.container){if(this.trackArtworkElement){const e=this.player.container.querySelector(".vidply-video-wrapper");e?this.player.container.insertBefore(this.trackArtworkElement,e):this.player.container.appendChild(this.trackArtworkElement)}this.trackInfoElement&&this.player.container.appendChild(this.trackInfoElement),this.navigationFeedback&&this.player.container.appendChild(this.navigationFeedback),this.playlistPanel&&this.player.container.appendChild(this.playlistPanel)}return this.container=this.player.container,this.updatePlayerControls(),this.tracks=n,this.currentIndex=r,this.updatePlaylistUI(),this.isPanelVisible=a,this.playlistPanel&&(this.playlistPanel.style.display=a?"":"none"),this.player.load({src:e.src,type:e.type,poster:e.poster,tracks:e.tracks||[],audioDescriptionSrc:e.audioDescriptionSrc||null,signLanguageSrc:e.signLanguageSrc||null}),t&&setTimeout(()=>{this.player.play()},100),!0}init(){this.player.on("ended",this.handleTrackEnd),this.player.on("error",this.handleTrackError),this.player.on("play",this.handlePlaybackStateChange.bind(this)),this.player.on("pause",this.handlePlaybackStateChange.bind(this)),this.player.on("ended",this.handlePlaybackStateChange.bind(this)),this.player.on("fullscreenchange",this.handleFullscreenChange.bind(this)),this.player.on("audiodescriptionenabled",this.handleAudioDescriptionChange.bind(this)),this.player.on("audiodescriptiondisabled",this.handleAudioDescriptionChange.bind(this)),this.options.showPanel&&this.createUI(),0===this.tracks.length&&0===this.initialTracks.length&&this.loadPlaylistFromAttribute()}loadPlaylistFromAttribute(){if(!this.player.element||!this.player.element.parentElement)return;const e=this.player.element.parentElement.parentElement,t=e?e.parentElement:null;if(!t)return;this.loadOptionsFromAttributes(t);const i=t.getAttribute("data-playlist");if(i)try{const e=JSON.parse(i);Array.isArray(e)&&e.length>0?this.loadPlaylist(e):console.warn("VidPly Playlist: data-playlist is not a valid array or is empty")}catch(e){console.error("VidPly Playlist: Failed to parse data-playlist attribute",e)}}loadOptionsFromAttributes(e){const t=e.getAttribute("data-playlist-auto-advance");null!==t&&(this.options.autoAdvance="true"===t);const i=e.getAttribute("data-playlist-auto-play-first");null!==i&&(this.options.autoPlayFirst="true"===i);const s=e.getAttribute("data-playlist-loop");null!==s&&(this.options.loop="true"===s);const a=e.getAttribute("data-playlist-show-panel");null!==a&&(this.options.showPanel="true"===a)}updatePlayerControls(){if(!this.player.controlBar)return;const e=this.player.controlBar;e.element.innerHTML="",e.createControls(),e.attachEvents(),e.setupAutoHide()}loadPlaylist(e){this.tracks=e,this.currentIndex=-1,this.container&&this.container.classList.add("vidply-has-playlist"),this.playlistPanel&&this.renderPlaylist(),e.length>0&&(this.options.autoPlayFirst?this.play(0):this.loadTrack(0).catch(()=>{})),this.updatePlaylistVisibilityInFullscreen()}async loadTrack(e){if(e<0||e>=this.tracks.length)return void console.warn("VidPly Playlist: Invalid track index",e);const t=this.tracks[e];if(this.selectTrack(e),this.isChangingTrack=!0,this.options.recreatePlayers&&this.hostElement&&this.PlayerClass){const i=this.player?"AUDIO"===this.player.element.tagName?"audio":"video":null,s=this.getTrackMediaType(t);if(i!==("audio"===s||"soundcloud"===s?"audio":"video"))return await this.recreatePlayerForTrack(t,!1),this.selectTrack(e),this.player.emit("playlisttrackchange",{index:e,item:t,total:this.tracks.length}),void setTimeout(()=>{this.isChangingTrack=!1},150)}const i=this.player.load({src:t.src,type:t.type,poster:t.poster,tracks:t.tracks||[],audioDescriptionSrc:t.audioDescriptionSrc||null,signLanguageSrc:t.signLanguageSrc||null,signLanguageSources:t.signLanguageSources||{}});this.player?.options?.deferLoad&&"function"==typeof this.player.ensureLoaded&&Promise.resolve(i).then(()=>this.player?.ensureLoaded?.()).catch(()=>{}),this.player.emit("playlisttrackchange",{index:e,item:t,total:this.tracks.length}),setTimeout(()=>{this.isChangingTrack=!1},150)}selectTrack(e){if(e<0||e>=this.tracks.length)return void console.warn("VidPly Playlist: Invalid track index",e);const t=this.tracks[e];this.currentIndex=e;try{if("VIDEO"===this.player?.element?.tagName)if(t.poster){const e="function"==typeof this.player.resolvePosterPath?this.player.resolvePosterPath(t.poster):t.poster;this.player.element.poster=e,this.player.applyPosterAspectRatio?.(e)}else this.player.element.removeAttribute("poster");if(this.player.audioDescriptionSrc=t.audioDescriptionSrc||null,this.player.signLanguageSrc=t.signLanguageSrc||null,this.player.signLanguageSources=t.signLanguageSources||{},t.duration&&Number(t.duration)>0&&(this.player.state.duration=Number(t.duration)),this.player.audioDescriptionManager&&(this.player.audioDescriptionManager.src=t.audioDescriptionSrc||null,this.player.audioDescriptionManager.originalSource=t.src||this.player.originalSrc||null),this.player.signLanguageManager&&(this.player.signLanguageManager.src=t.signLanguageSrc||null,this.player.signLanguageManager.sources=t.signLanguageSources||{},this.player.signLanguageManager.currentLanguage=null),t.src&&!this.player.originalSrc&&(this.player.originalSrc=t.src),Array.from(this.player.element.querySelectorAll("track")).forEach(e=>e.remove()),Array.isArray(t.tracks)&&t.tracks.forEach(e=>{if(!e?.src)return;const t=document.createElement("track");t.src=e.src,t.kind=e.kind||"captions",t.srclang=e.srclang||"en",t.label=e.label||e.srclang||"Track",e.default&&(t.default=!0),e.describedSrc&&t.setAttribute("data-desc-src",e.describedSrc),this.player.element.appendChild(t)}),"function"==typeof this.player.invalidateTrackCache&&this.player.invalidateTrackCache(),this.player.audioDescriptionManager&&"function"==typeof this.player.audioDescriptionManager.initFromSourceElements)try{this.player.audioDescriptionManager.captionTracks=[],this.player.audioDescriptionManager.initFromSourceElements(this.player.sourceElements,this.player.trackElements)}catch(e){}if(this.player.captionManager&&"function"==typeof this.player.captionManager.loadTracks)try{this.player.captionManager.tracks=[],this.player.captionManager.currentTrack=null,this.player.captionManager.loadTracks()}catch(e){}"function"==typeof this.player.updateControlBar&&this.player.updateControlBar()}catch(e){}this.updateTrackInfo(t),this.updatePlaylistUI(),this.player.emit("playlisttrackselect",{index:e,item:t,total:this.tracks.length})}async play(e,t=!1){if(e<0||e>=this.tracks.length)return void console.warn("VidPly Playlist: Invalid track index",e);const i=this.tracks[e];if(this.isChangingTrack=!0,this.currentIndex=e,this.options.recreatePlayers&&this.hostElement&&this.PlayerClass){const t=this.player?"AUDIO"===this.player.element.tagName?"audio":"video":null,s=this.getTrackMediaType(i);if(t!==("audio"===s||"soundcloud"===s?"audio":"video"))return await this.recreatePlayerForTrack(i,!0),this.updateTrackInfo(i),this.updatePlaylistUI(),this.player.emit("playlisttrackchange",{index:e,item:i,total:this.tracks.length}),void setTimeout(()=>{this.isChangingTrack=!1},150)}let s=i.src;this.player?.audioDescriptionManager?.desiredState&&i.audioDescriptionSrc&&(this.player.originalSrc=i.src,this.player.audioDescriptionManager.originalSource=i.src,this.player.audioDescriptionManager.src=i.audioDescriptionSrc,s=i.audioDescriptionSrc),this.player.load({src:s,type:i.type,poster:i.poster,tracks:i.tracks||[],audioDescriptionSrc:i.audioDescriptionSrc||null,signLanguageSrc:i.signLanguageSrc||null,signLanguageSources:i.signLanguageSources||{}}),this.updateTrackInfo(i),this.updatePlaylistUI(),this.player.emit("playlisttrackchange",{index:e,item:i,total:this.tracks.length}),setTimeout(()=>{this.player.play(),setTimeout(()=>{this.isChangingTrack=!1},50)},100)}next(){let e=this.currentIndex+1;if(e>=this.tracks.length){if(!this.options.loop)return;e=0}this.play(e)}previous(){let e=this.currentIndex-1;if(e<0){if(!this.options.loop)return;e=this.tracks.length-1}this.play(e)}handleTrackEnd(){this.isChangingTrack||this.options.autoAdvance&&this.next()}isExternalRendererUrl(e){return!!e&&(e.includes("youtube.com")||e.includes("youtu.be")||e.includes("vimeo.com")||e.includes("soundcloud.com")||e.includes("api.soundcloud.com")||e.includes(".m3u8"))}handleTrackError(e){const t=this.getCurrentTrack();t&&t.src&&this.isExternalRendererUrl(t.src)||this.isChangingTrack||(console.error("VidPly Playlist: Track error",e),this.options.autoAdvance&&setTimeout(()=>{this.next()},1e3))}handlePlaybackStateChange(){this.updatePlaylistVisibilityInFullscreen()}handleFullscreenChange(){setTimeout(()=>{this.updatePlaylistVisibilityInFullscreen()},50)}handleAudioDescriptionChange(){const e=this.getCurrentTrack();e&&(this.updateTrackInfo(e),this.updatePlaylistUI(),this.updatePlaylistDurations())}updatePlaylistDurations(){this.playlistPanel&&this.playlistPanel.querySelectorAll(".vidply-playlist-item").forEach((t,i)=>{const s=this.tracks[i];if(!s)return;const a=this.getEffectiveDuration(s),n=a?e.formatTime(a):"",r=t.querySelector(".vidply-playlist-duration-badge");r&&(r.textContent=n);const o=t.querySelector(".vidply-playlist-item-duration");o&&(o.textContent=n)})}getEffectiveDuration(e){return e?this.player.state.audioDescriptionEnabled&&e.audioDescriptionDuration?e.audioDescriptionDuration:e.duration||null:null}updatePlaylistVisibilityInFullscreen(){this.playlistPanel&&this.tracks.length&&(this.player.state.fullscreen?this.player.state.playing?(this.playlistPanel.classList.remove("vidply-playlist-fullscreen-visible"),setTimeout(()=>{this.player.state.playing&&this.player.state.fullscreen&&(this.playlistPanel.style.display="none")},300)):(this.playlistPanel.classList.add("vidply-playlist-fullscreen-visible"),this.playlistPanel.style.display="block"):(this.playlistPanel.classList.remove("vidply-playlist-fullscreen-visible"),this.playlistPanel.style.display=this.isPanelVisible&&this.tracks.length>0?"block":"none"))}createUI(){this.container=this.player.container,this.container?(this.trackInfoElement=v.createElement("div",{className:"vidply-track-info",attributes:{role:"status"}}),this.trackInfoElement.style.display="none",this.container.appendChild(this.trackInfoElement),this.navigationFeedback=v.createElement("div",{className:"vidply-sr-only",attributes:{role:"status","aria-live":"polite","aria-atomic":"true"}}),this.container.appendChild(this.navigationFeedback),this.playlistPanel=v.createElement("div",{className:"vidply-playlist-panel",attributes:{id:`${this.uniqueId}-panel`,role:"region","aria-label":b.t("playlist.title"),"aria-labelledby":`${this.uniqueId}-heading`}}),this.playlistPanel.style.display="none",this.container.appendChild(this.playlistPanel)):console.warn("VidPly Playlist: No container found")}updateTrackInfo(t){if(!this.trackInfoElement)return;const i=this.currentIndex+1,s=this.tracks.length,a=t.title||b.t("playlist.untitled"),n=t.artist||"",r=this.getEffectiveDuration(t),o=r?e.formatTime(r):"",l=r?e.formatDuration(r):"",c=n?b.t("playlist.by")+n:"",h=l?`. ${l}`:"",u=b.t("playlist.nowPlaying",{current:i,total:s,title:a,artist:c})+h,p=b.t("playlist.trackOf",{current:i,total:s}),d=o?`<span class="vidply-track-duration" aria-hidden="true">${v.escapeHTML(o)}</span>`:"",g=t.description||"";this.trackInfoElement.innerHTML=`\n      <span class="vidply-sr-only">${v.escapeHTML(u)}</span>\n      <div class="vidply-track-header" aria-hidden="true">\n        <span class="vidply-track-number">${v.escapeHTML(p)}</span>\n        ${d}\n      </div>\n      <div class="vidply-track-title" aria-hidden="true">${v.escapeHTML(a)}</div>\n      ${n?`<div class="vidply-track-artist" aria-hidden="true">${v.escapeHTML(n)}</div>`:""}\n      ${g?`<div class="vidply-track-description" aria-hidden="true">${v.escapeHTML(g)}</div>`:""}\n    `,this.trackInfoElement.style.display="block",this.updateTrackArtwork(t)}updateTrackArtwork(e){if("AUDIO"===this.player?.element?.tagName){if(!this.trackArtworkElement&&this.container){this.trackArtworkElement=v.createElement("div",{className:"vidply-track-artwork",attributes:{"aria-hidden":"true"}}),this.trackArtworkElement.style.display="none";const e=this.container.querySelector(".vidply-video-wrapper");e?this.container.insertBefore(this.trackArtworkElement,e):this.container.appendChild(this.trackArtworkElement)}this.trackArtworkElement&&(e.poster?(this.trackArtworkElement.style.backgroundImage=`url(${e.poster})`,this.trackArtworkElement.style.display="block"):this.trackArtworkElement.style.display="none")}else this.trackArtworkElement&&(this.trackArtworkElement.style.display="none")}renderPlaylist(){if(!this.playlistPanel)return;this.playlistPanel.innerHTML="";const e=v.createElement("h2",{className:"vidply-playlist-header",attributes:{id:`${this.uniqueId}-heading`}});e.textContent=`${b.t("playlist.title")} (${this.tracks.length})`,this.playlistPanel.appendChild(e);const t=v.createElement("div",{className:"vidply-sr-only",attributes:{id:`${this.uniqueId}-keyboard-instructions`}});t.textContent=b.t("playlist.keyboardInstructions"),this.playlistPanel.appendChild(t);const i=v.createElement("ul",{className:"vidply-playlist-list",attributes:{role:"listbox","aria-labelledby":`${this.uniqueId}-heading`,"aria-describedby":`${this.uniqueId}-keyboard-instructions`}});this.tracks.forEach((e,t)=>{const s=this.createPlaylistItem(e,t);i.appendChild(s)}),this.playlistPanel.appendChild(i),this.isPanelVisible&&(this.playlistPanel.style.display="block")}createPlaylistItem(t,i){b.t("playlist.trackOf",{current:i+1,total:this.tracks.length});const s=t.title||b.t("playlist.trackUntitled",{number:i+1}),a=t.artist?b.t("playlist.by")+t.artist:"",n=this.getEffectiveDuration(t),r=n?e.formatTime(n):"",o=n?e.formatDuration(n):"",l=i===this.currentIndex;let c=`${s}${a}`;o&&(c+=`. ${o}`);const u=v.createElement("li",{className:l?"vidply-playlist-item vidply-playlist-item-active":"vidply-playlist-item",attributes:{"data-playlist-index":i,role:"none"}}),p=v.createElement("button",{className:"vidply-playlist-item-button",attributes:{type:"button",role:"option",tabIndex:0===i?0:-1,"aria-label":c,"aria-posinset":i+1,"aria-setsize":this.tracks.length,"aria-checked":l?"true":"false"}});l&&(p.setAttribute("aria-current","true"),p.setAttribute("tabIndex","0"));const d=v.createElement("span",{className:"vidply-playlist-thumbnail-container",attributes:{"aria-hidden":"true"}}),g=v.createElement("span",{className:"vidply-playlist-thumbnail"});if(t.poster)g.style.backgroundImage=`url(${t.poster})`;else{const e=h("music");e.classList.add("vidply-playlist-thumbnail-icon"),g.appendChild(e)}if(d.appendChild(g),r&&t.poster){const e=v.createElement("span",{className:"vidply-playlist-duration-badge"});e.textContent=r,d.appendChild(e)}p.appendChild(d);const y=v.createElement("span",{className:"vidply-playlist-item-info",attributes:{"aria-hidden":"true"}}),m=v.createElement("span",{className:"vidply-playlist-item-title-row"}),f=v.createElement("span",{className:"vidply-playlist-item-title"});if(f.textContent=s,m.appendChild(f),r&&!t.poster){const e=v.createElement("span",{className:"vidply-playlist-item-duration"});e.textContent=r,m.appendChild(e)}if(y.appendChild(m),t.artist){const e=v.createElement("span",{className:"vidply-playlist-item-artist"});e.textContent=t.artist,y.appendChild(e)}if(t.description){const e=v.createElement("span",{className:"vidply-playlist-item-description"});e.textContent=t.description,y.appendChild(e)}p.appendChild(y);const L=h("play");return L.classList.add("vidply-playlist-item-icon"),L.setAttribute("aria-hidden","true"),p.appendChild(L),p.addEventListener("click",()=>{const e=this.tracks[i];this.isExternalRendererUrl(e?.src)&&this.player.state.fullscreen?(this.player.exitFullscreen(),setTimeout(()=>{this.play(i,!0)},100)):this.play(i,!0)}),p.addEventListener("keydown",e=>{this.handlePlaylistItemKeydown(e,i)}),u.appendChild(p),u}handlePlaylistItemKeydown(e,t){const i=Array.from(this.playlistPanel.querySelectorAll(".vidply-playlist-item-button"));let s=-1,a="";switch(e.key){case"Enter":case" ":e.preventDefault(),e.stopPropagation();{const e=this.tracks[t];this.isExternalRendererUrl(e?.src)&&this.player.state.fullscreen?(this.player.exitFullscreen(),setTimeout(()=>{this.play(t,!0)},100)):this.play(t,!0)}return;case"ArrowDown":e.preventDefault(),e.stopPropagation(),t<i.length-1?s=t+1:a=b.t("playlist.endOfPlaylist",{current:i.length,total:i.length});break;case"ArrowUp":e.preventDefault(),e.stopPropagation(),t>0?s=t-1:a=b.t("playlist.beginningOfPlaylist",{total:i.length});break;case"PageDown":e.preventDefault(),e.stopPropagation(),s=Math.min(t+5,i.length-1),s===i.length-1&&t!==s&&(a=b.t("playlist.jumpedToLastTrack",{current:s+1,total:i.length}));break;case"PageUp":e.preventDefault(),e.stopPropagation(),s=Math.max(t-5,0),0===s&&t!==s&&(a=b.t("playlist.jumpedToFirstTrack",{total:i.length}));break;case"Home":e.preventDefault(),e.stopPropagation(),s=0,0!==t&&(a=b.t("playlist.firstTrack",{total:i.length}));break;case"End":e.preventDefault(),e.stopPropagation(),s=i.length-1,t!==i.length-1&&(a=b.t("playlist.lastTrack",{current:i.length,total:i.length}))}if(-1!==s&&s!==t){i[t].setAttribute("tabIndex","-1"),i[s].setAttribute("tabIndex","0"),i[s].focus({preventScroll:!1});const e=i[s].closest(".vidply-playlist-item");e&&e.scrollIntoView({behavior:"smooth",block:"nearest"})}a&&this.navigationFeedback&&(this.navigationFeedback.textContent=a,setTimeout(()=>{this.navigationFeedback&&(this.navigationFeedback.textContent="")},1e3))}updatePlaylistUI(){if(!this.playlistPanel)return;const t=this.playlistPanel.querySelectorAll(".vidply-playlist-item"),i=this.playlistPanel.querySelectorAll(".vidply-playlist-item-button");t.forEach((t,s)=>{const a=i[s];if(!a)return;const n=this.tracks[s],r=(b.t("playlist.trackOf",{current:s+1,total:this.tracks.length}),n.title||b.t("playlist.trackUntitled",{number:s+1})),o=n.artist?b.t("playlist.by")+n.artist:"",l=this.getEffectiveDuration(n),c=l?e.formatDuration(l):"";if(s===this.currentIndex){t.classList.add("vidply-playlist-item-active"),a.setAttribute("aria-current","true"),a.setAttribute("aria-checked","true"),a.setAttribute("tabIndex","0");let e=`${r}${o}`;c&&(e+=`. ${c}`),a.setAttribute("aria-label",e),t.scrollIntoView({behavior:"smooth",block:"nearest"})}else{t.classList.remove("vidply-playlist-item-active"),a.removeAttribute("aria-current"),a.setAttribute("aria-checked","false"),a.setAttribute("tabIndex","-1");let e=`${r}${o}`;c&&(e+=`. ${c}`),a.setAttribute("aria-label",e)}})}getCurrentTrack(){return this.tracks[this.currentIndex]||null}getPlaylistInfo(){return{currentIndex:this.currentIndex,totalTracks:this.tracks.length,currentTrack:this.getCurrentTrack(),hasNext:this.hasNext(),hasPrevious:this.hasPrevious()}}hasNext(){return!!this.options.loop||this.currentIndex<this.tracks.length-1}hasPrevious(){return!!this.options.loop||this.currentIndex>0}addTrack(e){this.tracks.push(e),this.playlistPanel&&this.renderPlaylist()}removeTrack(e){e<0||e>=this.tracks.length||(this.tracks.splice(e,1),e<this.currentIndex?this.currentIndex--:e===this.currentIndex&&(this.currentIndex>=this.tracks.length&&(this.currentIndex=this.tracks.length-1),this.currentIndex>=0&&this.play(this.currentIndex)),this.playlistPanel&&this.renderPlaylist())}clear(){this.tracks=[],this.currentIndex=-1,this.playlistPanel&&(this.playlistPanel.innerHTML="",this.playlistPanel.style.display="none"),this.trackInfoElement&&(this.trackInfoElement.innerHTML="",this.trackInfoElement.style.display="none"),this.trackArtworkElement&&(this.trackArtworkElement.style.backgroundImage="",this.trackArtworkElement.style.display="none")}togglePanel(e){return!!this.playlistPanel&&((void 0!==e?e:"none"===this.playlistPanel.style.display)?(this.playlistPanel.style.display="block",this.isPanelVisible=!0,this.tracks.length>0&&setTimeout(()=>{const e=this.playlistPanel.querySelector('.vidply-playlist-item[tabindex="0"]');e&&e.focus({preventScroll:!0})},100),this.player.controlBar&&this.player.controlBar.controls.playlistToggle&&(this.player.controlBar.controls.playlistToggle.setAttribute("aria-expanded","true"),this.player.controlBar.controls.playlistToggle.setAttribute("aria-pressed","true"))):(this.playlistPanel.style.display="none",this.isPanelVisible=!1,this.player.controlBar&&this.player.controlBar.controls.playlistToggle&&(this.player.controlBar.controls.playlistToggle.setAttribute("aria-expanded","false"),this.player.controlBar.controls.playlistToggle.setAttribute("aria-pressed","false"),this.player.controlBar.controls.playlistToggle.focus({preventScroll:!0}))),this.isPanelVisible)}showPanel(){return this.togglePanel(!0)}hidePanel(){return this.togglePanel(!1)}destroy(){this.player.off("ended",this.handleTrackEnd),this.player.off("error",this.handleTrackError),this.trackArtworkElement&&this.trackArtworkElement.remove(),this.trackInfoElement&&this.trackInfoElement.remove(),this.playlistPanel&&this.playlistPanel.remove(),this.clear()}},B=new Map;function A(){document.querySelectorAll("[data-vidply]").forEach(e=>{const t=e.dataset.vidplyOptions?JSON.parse(e.dataset.vidplyOptions):{},i=(e=>{const t={},i={signLanguageSrc:"signLanguageSrc",signLanguageButton:"signLanguageButton",signLanguagePosition:"signLanguagePosition",signLanguageDisplayMode:"signLanguageDisplayMode",audioDescriptionSrc:"audioDescriptionSrc",audioDescriptionButton:"audioDescriptionButton",autoplay:"autoplay",loop:"loop",muted:"muted",controls:"controls",poster:"poster",width:"width",height:"height",language:"language",captions:"captions",captionsDefault:"captionsDefault",transcript:"transcript",transcriptButton:"transcriptButton",keyboard:"keyboard",responsive:"responsive",pipButton:"pipButton",fullscreenButton:"fullscreenButton",lazyInit:"lazyInit",lazyMargin:"lazyMargin",theme:"theme"};Object.keys(i).forEach(s=>{const a=e[s];void 0!==a&&(t[i[s]]="true"===a||"false"!==a&&(isNaN(a)||""===a?a:Number(a)))});const s={};if(Object.keys(e).forEach(t=>{if(t.startsWith("signLanguageSrc")&&"signLanguageSrc"!==t){const i=t.match(/^signLanguageSrc([A-Z][a-z]*)$/);if(i){const a=i[1].toLowerCase();s[a]=e[t]}}}),Object.keys(s).length>0&&(t.signLanguageSources=s,e.signLanguageSrc&&!t.signLanguageSrc&&(t.signLanguageSrc=e.signLanguageSrc)),e.vidplyLanguageFiles)try{t.languageFiles=JSON.parse(e.vidplyLanguageFiles)}catch(e){console.warn("Invalid JSON in data-vidply-language-files:",e)}if(e.vidplyLanguageFile)try{const i=JSON.parse(e.vidplyLanguageFile);"object"==typeof i&&null!==i&&(t.languageFiles=i)}catch(i){e.vidplyLanguageFileCode&&e.vidplyLanguageFileUrl&&(t.languageFile=e.vidplyLanguageFileCode,t.languageFileUrl=e.vidplyLanguageFileUrl)}else e.vidplyLanguageFileCode&&e.vidplyLanguageFileUrl&&(t.languageFile=e.vidplyLanguageFileCode,t.languageFileUrl=e.vidplyLanguageFileUrl);return t})(e.dataset),s={...i,...t};"false"!==e.dataset.vidplyLazy&&!1!==s.lazyInit&&"IntersectionObserver"in window?D(e,s,e.dataset.vidplyLazyMargin||s.lazyMargin||"500px"):new x(e,s)})}function D(e,t,i){if(e.getBoundingClientRect().height<20)return void new x(e,t);const s=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(s.unobserve(e.target),B.delete(e.target),new x(e.target,t))})},{rootMargin:i,threshold:0});s.observe(e),B.set(e,{observer:s,options:t})}x.observeLazy=(e,t={},i="200px")=>{const s="string"==typeof e?document.querySelector(e):e;return s?"IntersectionObserver"in window?(D(s,t,i),{cancel:()=>(e=>{const t=B.get(e);t&&(t.observer.unobserve(e),B.delete(e))})(s)}):(new x(s,t),null):(console.warn("VidPly: Element not found for lazy observation"),null)},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",A):A();var $=x;export{x as Player,T as PlaylistManager,$ as default};