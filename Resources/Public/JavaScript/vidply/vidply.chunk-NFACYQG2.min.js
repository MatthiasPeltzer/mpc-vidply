/*!
 * Universal, Accessible Video Player
 * (c) 2026 Matthias Peltzer
 * Released under GPL-2.0-or-later License
 */
import{StorageManager as t}from"./vidply.chunk-AE2Z46L5.min.js";import{DOMUtils as e,i18n as i}from"./vidply.chunk-YLKHFL57.min.js";function n(t,e=100){let i;return(...n)=>{clearTimeout(i),i=setTimeout(()=>{clearTimeout(i),t(...n)},e)}}function s(t,e=100){let i;return(...n)=>{i||(t(...n),i=!0,setTimeout(()=>i=!1,e))}}function a(t=768){return window.innerWidth<t}function r(t,e=100){let i=!1;const n=()=>{i||(i=!0,t())};requestAnimationFrame(n),setTimeout(n,e)}var o=class{constructor(e){this.player=e,this.element=null,this.tracks=[],this.currentTrack=null,this.currentCue=null,this.storage=new t("vidply"),this.loadSavedPreferences(),this.init()}loadSavedPreferences(){const t=this.storage.getCaptionPreferences();t&&(t.fontSize&&(this.player.options.captionsFontSize=t.fontSize),t.fontFamily&&(this.player.options.captionsFontFamily=t.fontFamily),t.color&&(this.player.options.captionsColor=t.color),t.backgroundColor&&(this.player.options.captionsBackgroundColor=t.backgroundColor),void 0!==t.opacity&&(this.player.options.captionsOpacity=t.opacity))}saveCaptionPreferences(){this.storage.saveCaptionPreferences({fontSize:this.player.options.captionsFontSize,fontFamily:this.player.options.captionsFontFamily,color:this.player.options.captionsColor,backgroundColor:this.player.options.captionsBackgroundColor,opacity:this.player.options.captionsOpacity})}init(){this.createElement(),this.loadTracks(),this.attachEvents(),this.player.options.captionsDefault&&this.tracks.length>0&&!this.currentTrack&&this.enable()}createElement(){this.element=e.createElement("div",{className:`${this.player.options.classPrefix}-captions`,attributes:{role:"region","aria-label":i.t("player.captions")}}),this.updateStyles(),(this.player.videoWrapper||this.player.container).appendChild(this.element)}loadTracks(){const t=this.player.element.textTracks;let e=-1;for(let i=0;i<t.length;i++){const n=t[i];if("subtitles"===n.kind||"captions"===n.kind){const t=this.player.findTrackElement(n),s=t&&t.hasAttribute("default");this.tracks.push({track:n,language:n.language,label:n.label,kind:n.kind,index:i,isDefault:s}),n.mode="hidden",s&&(e=this.tracks.length-1)}}e>=0&&requestAnimationFrame(()=>{this.enable(e)})}attachEvents(){this.player.on("timeupdate",()=>{this.updateCaptions()}),this.player.on("captionschange",()=>{this.updateStyles()}),this.debouncedPositionCaptions=n(()=>{this.positionCaptionsOnMobile()},150),window.addEventListener("resize",this.debouncedPositionCaptions),this.player.on("enterfullscreen",()=>{r(()=>this.positionCaptionsOnMobile(),100)}),this.player.on("exitfullscreen",()=>{r(()=>this.positionCaptionsOnMobile(),100)})}enable(t=0){if(0===this.tracks.length)return;this.currentTrack&&this.currentTrack.track&&(this.cueChangeHandler&&this.currentTrack.track.removeEventListener("cuechange",this.cueChangeHandler),this.currentTrack.track.mode="hidden");const e=this.tracks[t];if(e&&e.track){e.track.mode="hidden",this.currentTrack=e,this.player.state.captionsEnabled=!0,e.language&&this.element.setAttribute("lang",e.language),this.cueChangeHandler&&e.track.removeEventListener("cuechange",this.cueChangeHandler),this.cueChangeHandler=()=>{this.updateCaptions()},e.track.addEventListener("cuechange",this.cueChangeHandler);const t=()=>{if(e.track.readyState<2){const t=()=>{e.track.removeEventListener("load",t),e.track.removeEventListener("error",t),requestAnimationFrame(()=>{this.currentTrack&&this.currentTrack.track===e.track&&this.updateCaptions()})};e.track.addEventListener("load",t,{once:!0}),e.track.addEventListener("error",t,{once:!0})}else requestAnimationFrame(()=>{this.currentTrack&&this.currentTrack.track===e.track&&this.updateCaptions()})};requestAnimationFrame(()=>{this.currentTrack&&this.currentTrack.track===e.track&&t()}),this.player.emit("captionsenabled",e)}}disable(){this.currentTrack&&(this.currentTrack.track.mode="hidden",this.currentTrack=null),this.element.style.display="none",this.element.innerHTML="",this.element.removeAttribute("lang"),this.currentCue=null,this.player.state.captionsEnabled=!1,this.player.emit("captionsdisabled")}updateCaptions(){if(!this.currentTrack||!this.currentTrack.track)return;if("disabled"===this.currentTrack.track.mode&&(this.currentTrack.track.mode="hidden"),"showing"===this.currentTrack.track.mode&&(this.currentTrack.track.mode="hidden"),!this.currentTrack.track.activeCues)return void(this.currentTrack.track.cues&&this.currentTrack.track.cues.length>0&&this.currentCue&&(this.element.innerHTML="",this.element.style.display="none",this.currentCue=null));const t=this.currentTrack.track.activeCues,i="audio"===this.player.element.tagName.toLowerCase();if(t.length>0){const n=t[0];if(this.currentCue!==n){this.currentCue=n;let t=n.text;if(t=this.parseVTTFormatting(t),i){this.element.querySelectorAll(`.${this.player.options.classPrefix}-caption-cue`).forEach(t=>t.classList.remove(`${this.player.options.classPrefix}-caption-active`));const i=`cue-${n.startTime}-${n.endTime}`;let s=this.element.querySelector(`[data-cue-id="${i}"]`);s||(s=document.createElement("div"),s.className=`${this.player.options.classPrefix}-caption-cue`,s.setAttribute("data-cue-id",i),s.innerHTML=e.sanitizeHTML(t),this.element.appendChild(s)),s.classList.add(`${this.player.options.classPrefix}-caption-active`),requestAnimationFrame(()=>{s&&s.scrollIntoView({behavior:"smooth",block:"center"})})}else this.element.innerHTML=e.sanitizeHTML(t);this.element.style.display="block",this.positionCaptionsOnMobile(),this.player.emit("captionchange",n)}}else this.currentCue&&(i||(this.element.innerHTML="",this.element.style.display="none"),this.currentCue=null)}positionCaptionsOnMobile(){if(!this.element||"none"===this.element.style.display)return;const t=this.player.state?.fullscreen||!1,e=a();if(!e&&!t)return void(this.element.style.bottom="");const i=this.player.controlBar?.element;i&&requestAnimationFrame(()=>{if(!this.element||"none"===this.element.style.display)return;const n=i.getBoundingClientRect(),s=this.player.videoWrapper.getBoundingClientRect().bottom-n.top+16;this.element.style.bottom=`${s}px`,this.player.options.debug&&console.log("[VidPly] Caption position:",{mobile:e,isFullscreen:t,controlsHeight:n.height,bottomOffset:`${s}px`})})}parseVTTFormatting(t){return(t=(t=(t=(t=t.replace(/<c[^>]*>(.*?)<\/c>/g,'<span class="caption-class">$1</span>')).replace(/<b>(.*?)<\/b>/g,"<strong>$1</strong>")).replace(/<i>(.*?)<\/i>/g,"<em>$1</em>")).replace(/<u>(.*?)<\/u>/g,"<u>$1</u>")).replace(/<v\s+([^>]+)>(.*?)<\/v>/g,'<span class="caption-voice" data-voice="$1">$2</span>')}updateStyles(){if(!this.element)return;const t=this.player.options;this.element.style.fontSize=t.captionsFontSize,this.element.style.fontFamily=t.captionsFontFamily,this.element.style.color=t.captionsColor,this.element.style.backgroundColor=this.hexToRgba(t.captionsBackgroundColor,t.captionsOpacity)}hexToRgba(t,e){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?`rgba(${parseInt(i[1],16)}, ${parseInt(i[2],16)}, ${parseInt(i[3],16)}, ${e})`:t}setCaptionStyle(t,e){switch(t){case"fontSize":this.player.options.captionsFontSize=e;break;case"fontFamily":this.player.options.captionsFontFamily=e;break;case"color":this.player.options.captionsColor=e;break;case"backgroundColor":this.player.options.captionsBackgroundColor=e;break;case"opacity":this.player.options.captionsOpacity=e}this.updateStyles(),this.saveCaptionPreferences(),this.player.emit("captionschange")}getAvailableTracks(){return this.tracks.map((t,e)=>({index:e,language:t.language,label:t.label||t.language,kind:t.kind}))}refreshTracks(){const t=this.currentTrack?.language,e=this.player.state.captionsEnabled;if(this.currentTrack&&this.disable(),this.tracks=[],this.loadTracks(),this.player.log(`Caption tracks refreshed, found ${this.tracks.length} tracks`,"info"),e&&t&&this.tracks.length>0){const e=this.tracks.findIndex(e=>e.language===t);e>=0&&this.enable(e)}return this.tracks.length}switchTrack(t){t>=0&&t<this.tracks.length&&(this.disable(),this.enable(t))}destroy(){this.disable(),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element)}};export{n as debounce,s as throttle,a as isMobile,r as rafWithTimeout,o as CaptionManager};