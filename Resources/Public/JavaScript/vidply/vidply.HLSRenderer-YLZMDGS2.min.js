/*!
 * Universal, Accessible Video Player
 * (c) 2026 Matthias Peltzer
 * Released under GPL-2.0-or-later License
 */
var a=class{constructor(e){this.player=e,this.media=e.element,this.hls=null,this._hlsSourceLoaded=!1,this._pendingSrc=null}async init(){this.canPlayNatively()?(this.player.log("Using native HLS support"),await this.initNative()):(this.player.log("Using hls.js for HLS support"),await this.initHlsJs())}canPlayNatively(){let e=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),i=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;return!e&&!i?!1:document.createElement("video").canPlayType("application/vnd.apple.mpegurl")!==""}async initNative(){let e=(await import("./vidply.HTML5Renderer-4DX43LUF.min.js")).HTML5Renderer,i=new e(this.player);await i.init(),Object.getOwnPropertyNames(Object.getPrototypeOf(i)).forEach(t=>{t!=="constructor"&&typeof i[t]=="function"&&(this[t]=i[t].bind(i))})}async initHlsJs(){if(this.media.controls=!1,this.media.removeAttribute("controls"),window.Hls||await this.loadHlsJs(),!window.Hls.isSupported())throw new Error("HLS is not supported in this browser");let e=Array.from(this.media.querySelectorAll("source")),i=null;e.length>0&&(i=e[0].getAttribute("src"),e.forEach(s=>s.remove()),this.player.log("Removed <source> elements for HTML5 validity (hls.js uses src attribute)")),this.hls=new window.Hls({debug:this.player.options.debug,autoStartLoad:!this.player.options.deferLoad,enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,maxBufferLength:30,maxMaxBufferLength:600,maxBufferSize:60*1e3*1e3,maxBufferHole:.5,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:4,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3}),this.hls.attachMedia(this.media);let t=this.player.currentSource;if(!t&&i&&(t=i),t||(t=this.player.element.getAttribute("data-vidply-src")),!t){let s=this.player.element.getAttribute("src")||this.player.element.src;s&&!s.startsWith("blob:")&&(t=s)}if(this.player.log(`Loading HLS source: ${t}`,"log"),!t)throw new Error("No HLS source found");this.player.options.deferLoad?this._pendingSrc=t:(this.hls.loadSource(t),this._hlsSourceLoaded=!0),this.attachHlsEvents(),this.attachMediaEvents()}async loadHlsJs(){return new Promise((e,i)=>{let t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/hls.js@latest",t.onload=()=>e(),t.onerror=()=>i(new Error("Failed to load hls.js")),document.head.appendChild(t)})}attachHlsEvents(){this.hls.on(window.Hls.Events.MANIFEST_PARSED,(e,i)=>{this.player.log("HLS manifest loaded, found "+i.levels.length+" quality levels"),this.player.emit("hlsmanifestparsed",i),this.player.container&&this.player.container.classList.remove("vidply-external-controls")}),this.hls.on(window.Hls.Events.LEVEL_SWITCHED,(e,i)=>{this.player.log("HLS level switched to "+i.level),this.player.emit("hlslevelswitched",i)}),this.hls.on(window.Hls.Events.ERROR,(e,i)=>{this.handleHlsError(i)}),this.hls.on(window.Hls.Events.FRAG_BUFFERED,()=>{this.player.state.buffering=!1})}attachMediaEvents(){this.media.addEventListener("loadedmetadata",()=>{this.player.state.duration=this.media.duration,this.player.emit("loadedmetadata")}),this.media.addEventListener("play",()=>{this.player.state.playing=!0,this.player.state.paused=!1,this.player.state.ended=!1,this.player.emit("play"),this.player.options.onPlay&&this.player.options.onPlay.call(this.player)}),this.media.addEventListener("pause",()=>{this.player.state.playing=!1,this.player.state.paused=!0,this.player.emit("pause"),this.player.options.onPause&&this.player.options.onPause.call(this.player)}),this.media.addEventListener("ended",()=>{this.player.state.playing=!1,this.player.state.paused=!0,this.player.state.ended=!0,this.player.emit("ended"),this.player.options.onEnded&&this.player.options.onEnded.call(this.player),this.player.options.loop&&(this.player.seek(0),this.player.play())}),this.media.addEventListener("timeupdate",()=>{this.player.state.currentTime=this.media.currentTime,this.player.emit("timeupdate",this.media.currentTime),this.player.options.onTimeUpdate&&this.player.options.onTimeUpdate.call(this.player,this.media.currentTime)}),this.media.addEventListener("volumechange",()=>{this.player.state.volume=this.media.volume,this.player.state.muted=this.media.muted,this.player.emit("volumechange",this.media.volume)}),this.media.addEventListener("waiting",()=>{this.player.state.buffering=!0,this.player.emit("waiting")}),this.media.addEventListener("canplay",()=>{this.player.state.buffering=!1,this.player.emit("canplay")}),this.media.addEventListener("error",()=>{this.player.handleError(this.media.error)})}handleHlsError(e){if(this.player.log(`HLS Error - Type: ${e.type}, Details: ${e.details}, Fatal: ${e.fatal}`,"warn"),e.response&&this.player.log(`Response code: ${e.response.code}, URL: ${e.response.url}`,"warn"),e.fatal)switch(e.type){case window.Hls.ErrorTypes.NETWORK_ERROR:this.player.log("Fatal network error, trying to recover...","error"),this.player.log(`Network error details: ${e.details}`,"error"),setTimeout(()=>{this.hls.startLoad()},1e3);break;case window.Hls.ErrorTypes.MEDIA_ERROR:this.player.log("Fatal media error, trying to recover...","error"),this.hls.recoverMediaError();break;default:this.player.log("Fatal error, cannot recover","error"),this.player.handleError(new Error(`HLS Error: ${e.type} - ${e.details}`)),this.hls.destroy();break}else this.player.log("Non-fatal HLS error: "+e.details,"warn")}ensureLoaded(){if(!this.player.options.deferLoad||!this.hls||this._hlsSourceLoaded)return;let e=this._pendingSrc||this.player._pendingSource||this.player.currentSource;if(e)try{this.hls.loadSource(e),this._hlsSourceLoaded=!0,this.hls.startLoad()}catch{}}play(){let e=window.scrollX,i=window.scrollY;if(this.player.options.deferLoad&&this.hls&&!this._hlsSourceLoaded){let s=this._pendingSrc||this.player.currentSource;if(s)try{this.hls.loadSource(s),this.hls.startLoad(),this._hlsSourceLoaded=!0}catch{}}let t=this.media.play();window.scrollTo(e,i),t!==void 0&&t.catch(s=>{this.player.log("Play failed:",s,"warn")})}pause(){this.media.pause()}seek(e){this.media.currentTime=e}setVolume(e){this.media.volume=e}setMuted(e){this.media.muted=e}setPlaybackSpeed(e){this.media.playbackRate=e}switchQuality(e){this.hls&&(this.hls.currentLevel=e)}getQualities(){return this.hls&&this.hls.levels?this.hls.levels.map((e,i)=>{let t=Number(e.height)||0,s=Number(e.bitrate)||0,r=s>0?Math.round(s/1e3):0,l=t>0?`${t}p`:r>0?`${r} kb`:"Auto";return{index:i,height:e.height,width:e.width,bitrate:e.bitrate,name:l}}):[]}getCurrentQuality(){return this.hls?this.hls.currentLevel:-1}destroy(){this.hls&&(this.hls.destroy(),this.hls=null)}};export{a as HLSRenderer};
